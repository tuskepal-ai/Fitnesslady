<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FitnessLady ‚Äî Admin</title>
  <style>
    :root{
      --bg:#07060b; --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --stroke:rgba(255,255,255,.10);
      --glassA:rgba(255,255,255,.06);
      --glassB:rgba(255,255,255,.02);
      --pink:#ff4fd8; --pink2:#b14cff;
      --radius:18px;
      --max:1180px;
      --shadow:0 18px 55px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% 10%, rgba(255,79,216,.16), transparent 60%),
        radial-gradient(1000px 700px at 75% 20%, rgba(177,76,255,.14), transparent 60%),
        var(--bg);
      overflow-x:hidden;
    }
    body::before{
      content:"";
      position:fixed; inset:0; z-index:-1;
      background-image: var(--hero-url, url("/hero.png"));
      background-size:cover;
      background-position:center;
      opacity:.92;
    }
    .container{width:min(var(--max),92vw); margin:0 auto;}
    .topbar{
      position:fixed; top:0; left:0; right:0; z-index:50;
      background:rgba(8,6,12,.55);
      border-bottom:1px solid rgba(255,255,255,.06);
      backdrop-filter:blur(12px);
    }
    .topbar-inner{height:64px; display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .brand{display:flex; align-items:center; gap:10px; font-weight:900;}
    .dot{width:10px;height:10px;border-radius:999px;background:radial-gradient(circle at 30% 30%,#ffd0f6,var(--pink)); box-shadow:0 0 18px rgba(255,79,216,.7)}
    .pill{
      display:inline-flex; align-items:center; justify-content:center;
      padding:9px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(20,12,26,.55);
      color:var(--text);
      cursor:pointer;
      user-select:none;
      gap:8px;
    }
    .pill.primary{
      background:linear-gradient(135deg,var(--pink),var(--pink2));
      color:#140813; font-weight:900;
      border-color:rgba(255,255,255,.18);
      box-shadow:0 18px 46px rgba(255,79,216,.26);
    }
    main{padding-top:64px; min-height:100vh}
    .page{padding:18px 0 64px}
    .glass{
      background:linear-gradient(180deg,var(--glassA),var(--glassB));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter:blur(16px);
      padding:16px;
    }
    .grid{display:grid; grid-template-columns: 1fr 420px; gap:14px; align-items:start;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }
    h1{font-size:20px; margin:0 0 10px;}
    h2{font-size:16px; margin:0 0 10px;}
    .sub{margin:0 0 12px; color:var(--muted); font-size:13.5px; line-height:1.5;}
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      color:rgba(255,255,255,.92);
      outline:none;
    }
    label{display:block; margin:10px 0 6px; font-size:12.5px; color:rgba(255,255,255,.70); font-weight:800;}
    .list{display:grid; gap:10px;}
    .row{
      display:grid; grid-template-columns: 1fr auto;
      gap:10px; align-items:center;
      padding:12px;
      border-radius:16px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      cursor:pointer;
    }
    .row:hover{border-color:rgba(255,255,255,.18)}
    .title{font-weight:900; font-size:13.5px;}
    .meta{color:rgba(255,255,255,.65); font-size:12.5px; margin-top:4px; line-height:1.35;}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.07);
      font-weight:800; font-size:12px; color:rgba(255,255,255,.75);
      white-space:nowrap;
    }
    .rightActions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .log{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      color:rgba(255,255,255,.80);
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size:12px;
      white-space:pre-wrap;
      min-height:56px;
    }
    .danger{border-color:rgba(255,255,255,.18); background:rgba(255,255,255,.06);}
  </style>
</head>

<body>
  <header class="topbar">
    <div class="container topbar-inner">
      <div class="brand">
        <span class="dot"></span>
        <span>FitnessLady Admin</span>
        <span class="badge" id="meBadge">‚Äî</span>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="pill" id="btnOpenApp" type="button">‚Üó Vev≈ë app</button>
        <button class="pill danger" id="btnLogout" type="button">‚éã Kil√©p√©s</button>
      </div>
    </div>
  </header>

  <main>
    <div class="container page">
      <div class="glass" style="margin-bottom:14px;">
        <h1>V√°s√°rl√≥k / √ºgyfelek kezel√©se</h1>
        <p class="sub">Itt l√°tod a <b>users</b> kollekci√≥t. Kattints egy felhaszn√°l√≥ra ‚Üí jobb oldalon szerkeszted ‚Üí Ment√©s.</p>

        <div style="display:grid; grid-template-columns: 1fr 220px; gap:10px; align-items:center;">
          <input id="q" placeholder="Keres√©s email/uid/csomag/c√©l‚Ä¶" />
          <button class="pill primary" id="btnRefresh" type="button">‚Üª Friss√≠t√©s</button>
        </div>
      </div>

      <div class="grid">
        <!-- LEFT: USERS LIST -->
        <section class="glass">
          <h2>Felhaszn√°l√≥k</h2>
          <div class="list" id="userList"></div>
          <div class="log" id="listLog">Bet√∂lt√©s‚Ä¶</div>
        </section>

        <!-- RIGHT: EDITOR -->
        <section class="glass">
          <h2>Szem√©lyre szab√°s</h2>
          <p class="sub" id="selSub">V√°lassz egy felhaszn√°l√≥t bal oldalon.</p>

          <label>Email</label>
          <input id="f_email" disabled />

          <label>UID</label>
          <input id="f_uid" disabled />

          <label>Csomag</label>
          <select id="f_package">
            <option value="Start">Start</option>
            <option value="Balance">Balance</option>
            <option value="Pro">Pro</option>
          </select>

          <label>C√©l</label>
          <input id="f_goal" placeholder="pl. Form√°l√°s / Fogy√°s / Er≈ë" />

          <label>Szint (1‚Äì4)</label>
          <input id="f_level" type="number" min="1" max="4" />

          <label>Akt√≠v</label>
          <select id="f_active">
            <option value="true">true</option>
            <option value="false">false</option>
          </select>

          <label>Role</label>
          <input id="f_role" disabled />

          <div class="rightActions">
            <button class="pill primary" id="btnSave" type="button">üíæ Ment√©s</button>
            <button class="pill" id="btnOpenAs" type="button">‚Üó Megnyit√°s (app)</button>
          </div>

          <div class="log" id="editLog">‚Äî</div>
        </section>
      </div>
    </div>
  </main>

  <script type="module">
    // =========================
    // GitHub Pages prefix + hero
    // =========================
    const BASE_PREFIX = (location.hostname.endsWith("github.io")) ? "/Fitnesslady" : "";
    document.documentElement.style.setProperty("--hero-url", `url("${BASE_PREFIX}/hero.png")`);

    const $ = (id) => document.getElementById(id);
    const logList = (m) => { $("listLog").textContent = m; console.log(m); };
    const logEdit = (m) => { $("editLog").textContent = m; console.log(m); };

    // =========================
    // Firebase
    // =========================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    import {
      getFirestore, collection, getDocs, doc, getDoc, setDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBl2MzyiRzgCzeg-eEWNHkc9Vxx-PgawfU",
      authDomain: "fitneady-15fd0.firebaseapp.com",
      projectId: "fitneady-15fd0",
      storageBucket: "fitneady-15fd0.firebasestorage.app",
      messagingSenderId: "480597492603",
      appId: "1:480597492603:web:2ba6c266c662b4c79e33de",
      measurementId: "G-MH1YK9C2YF"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // =========================
    // State
    // =========================
    let me = null;
    let meProfile = null;
    let usersCache = [];   // { uid, data }
    let selectedUid = null;

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    async function loadMeProfile(uid){
      const snap = await getDoc(doc(db, "users", uid));
      return snap.exists() ? snap.data() : null;
    }

    function requireAdmin(){
      const isAdmin = (meProfile?.role === "admin");
      if(!isAdmin){
        document.body.innerHTML = `
          <div style="min-height:100vh; display:grid; place-items:center; padding:24px; color:white;">
            <div style="max-width:720px; background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:18px;">
              <h2 style="margin:0 0 10px;">Nincs admin jogosults√°g</h2>
              <p style="margin:0; opacity:.8; line-height:1.5;">
                A bel√©pett fi√≥kod users/${escapeHtml(me?.uid)} doksij√°ban a <b>role</b> nem <b>admin</b>.
                √Åll√≠tsd be Firestore-ban: role = "admin", √©s friss√≠tsd az oldalt.
              </p>
            </div>
          </div>
        `;
        throw new Error("Not admin");
      }
    }

    function renderList(filterText=""){
      const list = $("userList");
      list.innerHTML = "";

      const ft = filterText.trim().toLowerCase();

      const rows = usersCache
        .filter(u=>{
          if(!ft) return true;
          const d = u.data || {};
          const hay = [
            u.uid,
            d.email,
            d.package,
            d.goal,
            String(d.level ?? ""),
            String(d.active ?? "")
          ].join(" ").toLowerCase();
          return hay.includes(ft);
        });

      if(rows.length === 0){
        list.innerHTML = `<div class="sub">Nincs tal√°lat.</div>`;
        return;
      }

      rows.forEach(u=>{
        const d = u.data || {};
        const el = document.createElement("div");
        el.className = "row";
        el.innerHTML = `
          <div>
            <div class="title">${escapeHtml(d.email || "(nincs email)")}</div>
            <div class="meta">
              UID: ${escapeHtml(u.uid)}<br/>
              Csomag: <b>${escapeHtml(d.package || "‚Äî")}</b> ‚Ä¢ C√©l: ${escapeHtml(d.goal || "‚Äî")} ‚Ä¢ Szint: ${escapeHtml(d.level ?? "‚Äî")} ‚Ä¢ Akt√≠v: ${escapeHtml(String(d.active ?? "‚Äî"))}
            </div>
          </div>
          <div class="badge">${escapeHtml(d.role || "user")}</div>
        `;
        el.addEventListener("click", ()=>selectUser(u.uid));
        list.appendChild(el);
      });
    }

    function fillEditor(uid){
      const u = usersCache.find(x=>x.uid===uid);
      if(!u) return;

      const d = u.data || {};
      $("selSub").textContent = `Kijel√∂lve: ${d.email || uid}`;

      $("f_email").value = d.email || "";
      $("f_uid").value = uid;

      $("f_package").value = ["Start","Balance","Pro"].includes(d.package) ? d.package : "Start";
      $("f_goal").value = d.goal || "";
      $("f_level").value = Number(d.level ?? 2);
      $("f_active").value = String(d.active ?? true);

      $("f_role").value = d.role || "user";

      logEdit("Szerkeszthet≈ë mez≈ëk: package/goal/level/active");
    }

    async function selectUser(uid){
      selectedUid = uid;
      fillEditor(uid);
    }

    async function fetchUsers(){
      logList("Users bet√∂lt√©se‚Ä¶");
      const snap = await getDocs(collection(db, "users"));
      usersCache = snap.docs.map(d=>({ uid: d.id, data: d.data() }));
      logList(`K√©sz. √ñsszesen: ${usersCache.length} user`);
      renderList($("q").value || "");
    }

    async function saveSelected(){
      if(!selectedUid) return logEdit("Nincs kijel√∂lt user.");

      const patch = {
        package: $("f_package").value,
        goal: $("f_goal").value.trim(),
        level: Math.max(1, Math.min(4, parseInt($("f_level").value || "2", 10))),
        active: $("f_active").value === "true",
        updatedAt: serverTimestamp()
      };

      logEdit("Ment√©s folyamatban‚Ä¶");
      await setDoc(doc(db, "users", selectedUid), patch, { merge: true });

      // cache friss√≠t√©s
      const idx = usersCache.findIndex(x=>x.uid===selectedUid);
      if(idx >= 0){
        usersCache[idx].data = { ...(usersCache[idx].data||{}), ...patch };
      }

      logEdit("Mentve ‚úÖ");
      renderList($("q").value || "");
      fillEditor(selectedUid);
    }

    // =========================
    // UI events
    // =========================
    $("btnRefresh").addEventListener("click", ()=>fetchUsers().catch(e=>logList("Hiba: " + e.message)));
    $("q").addEventListener("input", ()=>renderList($("q").value || ""));

    $("btnSave").addEventListener("click", ()=>saveSelected().catch(e=>logEdit("Ment√©si hiba: " + e.message)));

    $("btnLogout").addEventListener("click", async ()=>{
      await signOut(auth);
      location.href = `${BASE_PREFIX}/hu/login/`;
    });

    $("btnOpenApp").addEventListener("click", ()=>{
      location.href = `${BASE_PREFIX}/app/`;
    });

    $("btnOpenAs").addEventListener("click", ()=>{
      // ugyanazzal a sessionnel csak az app ny√≠lik meg, nem ‚Äúimperszon√°l‚Äù
      location.href = `${BASE_PREFIX}/app/`;
    });

    // =========================
    // Auth gate
    // =========================
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        location.href = `${BASE_PREFIX}/hu/login/`;
        return;
      }

      me = user;
      $("meBadge").textContent = user.email || user.uid;

      meProfile = await loadMeProfile(user.uid);
      // ha nincs doc, akkor csin√°lunk (de role-t nem √°ll√≠tunk itt)
      if(!meProfile){
        await setDoc(doc(db, "users", user.uid), {
          email: user.email,
          active: true,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge:true });
        meProfile = await loadMeProfile(user.uid);
      }

      requireAdmin(); // dob ha nem admin

      await fetchUsers();
    });
  </script>
</body>
</html>
