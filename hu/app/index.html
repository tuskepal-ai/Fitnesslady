<!-- FILE: /hu/app/index.html -->
<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>FitnessLady ‚Äî Saj√°t program</title>
  <meta name="robots" content="noindex" />

  <style>
    :root{
      --bg:#07060b;
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --pink:#ff4fd8;
      --pink2:#b14cff;
      --gold:#ffd38a;

      --stroke: rgba(255,255,255,.10);
      --shadow: 0 18px 55px rgba(0,0,0,.55);
      --radius:22px;
      --max: 1100px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      overflow-x:hidden;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,79,216,.10), transparent 60%),
        radial-gradient(1000px 700px at 85% 25%, rgba(177,76,255,.10), transparent 62%),
        radial-gradient(900px 520px at 55% 90%, rgba(255,211,138,.07), transparent 55%),
        var(--bg);
      background-attachment: fixed;
    }

    a{ color:inherit; }
    .container{ width:min(var(--max), 92vw); margin:0 auto; padding: 16px 0 44px; }

    .topbar{
      position: sticky; top:0; z-index: 20;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      background: rgba(7,6,11,.55);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .topbar .inner{
      width:min(var(--max), 92vw);
      margin:0 auto;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 12px 0;
    }

    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight: 950;
      letter-spacing:.2px;
      white-space: nowrap;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: radial-gradient(circle at 30% 30%, #ffd0f6, var(--pink));
      box-shadow: 0 0 18px rgba(255,79,216,.7);
    }

    .pill{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(20,12,26,.55);
      color: var(--text);
      box-shadow: 0 12px 34px rgba(0,0,0,.35);
      cursor:pointer;
      user-select:none;
      white-space: nowrap;
      gap:8px;
      transition: transform .18s ease, border-color .18s ease, background .18s ease;
      text-decoration:none;
    }
    .pill:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.20); background: rgba(255,255,255,.07); }
    .pill.primary{
      background: linear-gradient(135deg, var(--pink), var(--pink2));
      color:#140813;
      border-color: rgba(255,255,255,.18);
      font-weight: 950;
    }
    .pill.ghost{
      background: rgba(255,255,255,.05);
    }
    .pill[disabled]{
      opacity:.55; cursor:not-allowed; filter:saturate(.6);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 14px;
      margin-top: 14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      padding: 14px;
      overflow:hidden;
    }

    h1{
      margin: 0 0 6px;
      font-family: ui-serif, Georgia, "Times New Roman", Times, serif;
      letter-spacing: -.3px;
      font-size: 34px;
      line-height: 1.05;
    }
    .sub{
      margin:0;
      color: var(--muted);
      line-height:1.55;
      font-size: 14px;
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .spacer{ height: 10px; }

    .hr{
      height:1px;
      background: rgba(255,255,255,.08);
      margin: 12px 0;
    }

    .kpi{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:stretch;
    }
    .kpi .box{
      flex: 1;
      min-width: 220px;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .kpi .box b{ font-weight: 950; }
    .kpi .box .small{ color: var(--muted2); font-size: 12.8px; margin-top: 3px; }

    .field label{
      display:block;
      margin: 10px 0 6px;
      color: rgba(255,255,255,.72);
      font-weight: 900;
      font-size: 12.8px;
      letter-spacing:.2px;
    }
    .field input, .field select, .field textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline: none;
      font-size: 14px;
    }
    .field textarea{ min-height: 84px; resize: vertical; }
    .field input:focus, .field select:focus, .field textarea:focus{
      border-color: rgba(255,79,216,.35);
      box-shadow: 0 0 0 4px rgba(255,79,216,.12);
    }

    .weekbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .weekchips{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .chip{
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      font-size: 12.5px;
      color: rgba(255,255,255,.86);
    }
    .chip.active{
      background: linear-gradient(135deg, rgba(255,79,216,.22), rgba(177,76,255,.20));
      border-color: rgba(255,79,216,.24);
    }

    .workouts{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .workout{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding: 12px;
    }
    .workout .t{
      font-weight: 950;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .workout .meta{
      margin-top: 6px;
      color: rgba(255,255,255,.70);
      font-size: 12.8px;
      line-height: 1.45;
    }

    .videoWrap{
      margin-top: 10px;
      border-radius: 16px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      aspect-ratio: 16/9;
    }
    .videoWrap iframe{
      width:100%;
      height:100%;
      border:0;
      display:block;
    }

    .msg{
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: rgba(255,255,255,.86);
      display:none;
      white-space: pre-wrap;
    }
    .msg.ok{ border-color: rgba(130,255,200,.35); display:block; }
    .msg.err{ border-color: rgba(255,120,140,.35); display:block; }

    footer{
      margin-top: 16px;
      padding: 14px 0 0;
      display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;
      color: rgba(255,255,255,.70);
      font-size: 13px;
    }

    /* ‚úÖ Chat panel ne legyen t√∫l nagy mobilon (biztons√°gi override) */
    .fl-chat-panel{
      width: min(420px, calc(100vw - 24px)) !important;
      height: min(520px, calc(100vh - 170px)) !important;
      right: 12px !important;
      bottom: 84px !important;
    }
    .fl-chat-fab{
      right: 12px !important;
      bottom: 12px !important;
    }

    @media (prefers-reduced-motion: reduce){
      .pill{ transition:none; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="inner">
      <div class="brand"><span class="dot"></span><span>FitnessLady ‚Ä¢ Saj√°t program</span></div>
      <div class="row">
        <a class="pill ghost" id="btnBack" href="#">‚Üê Vissza</a>
        <button class="pill" id="btnLogout" type="button">Kil√©p√©s</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <h1 id="hello">Szia üëã</h1>
      <p class="sub" id="subtitle">Bet√∂lt√©s‚Ä¶</p>

      <div class="spacer"></div>

      <div class="kpi">
        <div class="box">
          <b>Csomag</b>
          <div class="small" id="kpiPlan">‚Äî</div>
        </div>
        <div class="box">
          <b>St√°tusz</b>
          <div class="small" id="kpiStatus">‚Äî</div>
        </div>
        <div class="box">
          <b>Nyelv</b>
          <div class="small" id="kpiLang">‚Äî</div>
        </div>
      </div>

      <div class="msg" id="msgBox"></div>
    </div>

    <div class="grid">
      <!-- LEFT: PROGRAM -->
      <div class="card">
        <div class="weekbar">
          <div>
            <div style="font-weight:950; letter-spacing:.2px; font-size:16px;">Edz√©sek</div>
            <div class="sub">V√°laszd ki a hetet ‚Äî vide√≥k + id≈ëtartam.</div>
          </div>
          <div class="row">
            <button class="pill ghost" id="btnReload" type="button">‚Üª Friss√≠t√©s</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="weekchips" id="weekChips"></div>

        <div class="workouts" id="workouts"></div>
      </div>

      <!-- RIGHT: DI√âTA + MOTIV√ÅCI√ì + TRACKER -->
      <div class="card">
        <div style="font-weight:950; letter-spacing:.2px; font-size:16px;">Motiv√°ci√≥</div>
        <div class="sub">A mai √ºzeneted.</div>

        <div class="spacer"></div>

        <div class="card" style="padding:12px; border-radius:18px;">
          <div style="font-weight:950;" id="motTitle">‚Äî</div>
          <div class="sub" style="margin-top:6px;" id="motText">‚Äî</div>
        </div>

        <div class="hr"></div>

        <div style="font-weight:950; letter-spacing:.2px; font-size:16px;">Di√©ta terv</div>
        <div class="sub">A coach √°ltal be√°ll√≠tott √©trend.</div>

        <div class="spacer"></div>

        <div class="field">
          <label>Di√©ta (√∂sszefoglal√≥)</label>
          <textarea id="dietText" placeholder="Ha √ºres, akkor m√©g nincs be√°ll√≠tva." readonly></textarea>
        </div>

        <div class="hr"></div>

        <div style="font-weight:950; letter-spacing:.2px; font-size:16px;">Napi trackerek</div>
        <div class="sub">V√≠z, alv√°s, check-in ‚Äî ment√©s Firestore-ba.</div>

        <div class="field">
          <label>V√≠z (poh√°r / nap)</label>
          <div class="row">
            <button class="pill ghost" id="wMinus" type="button">‚àí</button>
            <div class="pill" style="cursor:default;" id="wVal">0</div>
            <button class="pill ghost" id="wPlus" type="button">+</button>
          </div>
          <div class="sub" style="margin-top:6px;">Tipp: 8‚Äì12 poh√°r.</div>
        </div>

        <div class="field">
          <label>Alv√°s (√≥ra)</label>
          <input id="sleepVal" type="number" min="0" max="16" step="0.5" placeholder="pl. 7.5" />
        </div>

        <div class="field">
          <label>Check-in (1‚Äì5)</label>
          <select id="moodVal">
            <option value="">‚Äî</option>
            <option value="1">1 ‚Äî nagyon neh√©z nap</option>
            <option value="2">2</option>
            <option value="3">3 ‚Äî ok√©</option>
            <option value="4">4</option>
            <option value="5">5 ‚Äî szuper</option>
          </select>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="pill primary" id="btnSaveTrackers" type="button">Ment√©s</button>
        </div>

        <div class="msg" id="trkMsg"></div>
      </div>
    </div>

    <footer>
      <div>¬© <span id="y"></span> FitnessLady</div>
      <div>T√ºske web design</div>
    </footer>
  </div>

  <script type="module">
    import {
      BASE_PREFIX,
      auth, db, fs,
      onAuth, logout, toLogin,
      ensureUserDoc,
      escapeHtml,
      todayISO,
      isAdminEmail
    } from "../shared/firebase.js";

    import { initCustomerChatWidget } from "../shared/chat-widget.js";

    // Back link + footer year
    document.getElementById("btnBack").href = `${BASE_PREFIX}/hu/`;
    document.getElementById("y").textContent = new Date().getFullYear();

    const $ = (s) => document.querySelector(s);

    const msgBox = $("#msgBox");
    const trkMsg = $("#trkMsg");

    function showMsg(text, kind="ok"){
      msgBox.className = "msg " + (kind === "err" ? "err" : "ok");
      msgBox.textContent = text;
    }
    function showTrk(text, kind="ok"){
      trkMsg.className = "msg " + (kind === "err" ? "err" : "ok");
      trkMsg.textContent = text;
    }

    // ---- UI refs ----
    const hello = $("#hello");
    const subtitle = $("#subtitle");
    const kpiPlan = $("#kpiPlan");
    const kpiStatus = $("#kpiStatus");
    const kpiLang = $("#kpiLang");

    const weekChips = $("#weekChips");
    const workoutsEl = $("#workouts");
    const btnReload = $("#btnReload");

    const motTitle = $("#motTitle");
    const motText  = $("#motText");
    const dietText = $("#dietText");

    // trackers
    const wMinus = $("#wMinus");
    const wPlus  = $("#wPlus");
    const wValEl = $("#wVal");
    const sleepVal = $("#sleepVal");
    const moodVal  = $("#moodVal");
    const btnSaveTrackers = $("#btnSaveTrackers");

    let CURRENT_USER = null;
    let USER_DOC = null;
    let PLAN_ID = "start_v1";
    let ACTIVE_WEEK = 1;
    let MAX_WEEKS = 12;

    // ---------- helpers ----------
    function clamp(n, a, b){
      const x = Number(n);
      return Math.max(a, Math.min(b, x));
    }

    function normalizeWeek(n){
      const w = parseInt(n, 10);
      return clamp(isFinite(w) ? w : 1, 1, 99);
    }

    function prettyPlan(planId){
      const p = String(planId || "").toLowerCase();
      if(p.includes("pro")) return "PRO";
      if(p.includes("balance")) return "Balance";
      if(p.includes("start")) return "Start";
      return planId || "‚Äî";
    }

    function safeTextFromDiet(diet){
      if(!diet) return "";
      if(typeof diet === "string") return diet;
      if(Array.isArray(diet)) return diet.join("\n");
      if(typeof diet === "object"){
        // egyszer≈± flatten
        try{
          return Object.entries(diet).map(([k,v])=>{
            if(v == null) return `${k}:`;
            if(typeof v === "string") return `${k}: ${v}`;
            return `${k}: ${JSON.stringify(v)}`;
          }).join("\n");
        }catch{
          return "";
        }
      }
      return "";
    }

    function embedUrl(url){
      const u = String(url || "").trim();
      if(!u) return "";

      // Vimeo linkb≈ël csin√°ljunk embed-et (ha m√°r embed, hagyjuk)
      if(u.includes("player.vimeo.com")) return u;

      // vimeo.com/123 -> player.vimeo.com/video/123
      const m = u.match(/vimeo\.com\/(\d+)/);
      if(m && m[1]) return `https://player.vimeo.com/video/${m[1]}?title=0&byline=0&portrait=0`;

      // YouTube fallback (ha k√©s≈ëbb kell)
      if(u.includes("youtube.com/watch")){
        try{
          const uu = new URL(u);
          const id = uu.searchParams.get("v");
          if(id) return `https://www.youtube-nocookie.com/embed/${id}`;
        }catch{}
      }
      if(u.includes("youtu.be/")){
        const id = u.split("youtu.be/")[1]?.split(/[?&]/)[0];
        if(id) return `https://www.youtube-nocookie.com/embed/${id}`;
      }

      return u; // ha m√°r embed jelleg≈±
    }

    function renderWeeks(maxWeeks){
      weekChips.innerHTML = "";
      const mw = clamp(parseInt(maxWeeks,10)||12, 1, 24);
      for(let i=1;i<=mw;i++){
        const b = document.createElement("div");
        b.className = "chip" + (i===ACTIVE_WEEK ? " active" : "");
        b.textContent = `H√©t ${i}`;
        b.addEventListener("click", ()=>{
          ACTIVE_WEEK = i;
          renderWeeks(mw);
          loadWeek();
        });
        weekChips.appendChild(b);
      }
    }

    function renderWorkouts(items){
      workoutsEl.innerHTML = "";
      if(!items || !items.length){
        const div = document.createElement("div");
        div.className = "sub";
        div.textContent = "Ehhez a h√©thez m√©g nincs edz√©s be√°ll√≠tva.";
        workoutsEl.appendChild(div);
        return;
      }

      items.forEach((w, idx)=>{
        const title = String(w?.title || `Edz√©s ${idx+1}`).trim();
        const dur = String(w?.duration || "").trim();
        const url = String(w?.video || "").trim();
        const embed = embedUrl(url);

        const card = document.createElement("div");
        card.className = "workout";
        card.innerHTML = `
          <div class="t">
            <div>${escapeHtml(title)}</div>
            <div style="color:rgba(255,255,255,.70); font-size:12.5px; font-weight:900;">${escapeHtml(dur || "‚Äî")}</div>
          </div>
          <div class="meta">${escapeHtml(url ? "Vide√≥ el√©rhet≈ë" : "Vide√≥ hamarosan")}</div>
          ${embed && url ? `
            <div class="videoWrap">
              <iframe
                src="${escapeHtml(embed)}"
                allow="autoplay; fullscreen; picture-in-picture"
                allowfullscreen
                loading="lazy"
                referrerpolicy="no-referrer"
              ></iframe>
            </div>
          ` : ``}
        `;
        workoutsEl.appendChild(card);
      });
    }

    // ---------- data loading ----------
    async function loadUserAndBootstrap(user){
      CURRENT_USER = user;

      const email = (user.email || "").trim();
      USER_DOC = await ensureUserDoc(user.uid, email);

      const name = (USER_DOC?.name || "").trim();
      hello.textContent = name ? `Szia, ${name} üëã` : "Szia üëã";
      subtitle.textContent = email ? email : "Bejelentkezve";

      PLAN_ID = String(USER_DOC?.planId || "start_v1").trim() || "start_v1";
      kpiPlan.textContent = prettyPlan(PLAN_ID);
      kpiStatus.textContent = (USER_DOC?.paid === true) ? "Fizetett ‚úÖ" : "Nem fizetett ‚õî";
      kpiLang.textContent = String(USER_DOC?.lang || "hu").toUpperCase();

      // motiv√°ci√≥
      motTitle.textContent = String(USER_DOC?.motivationCard?.title || "‚Äî");
      motText.textContent  = String(USER_DOC?.motivationCard?.text || "‚Äî");

      // di√©ta
      dietText.value = safeTextFromDiet(USER_DOC?.dietPlan || "");

      // trackerek bet√∂lt√©se (ma)
      const iso = todayISO();
      const t = (USER_DOC?.trackersByDay && USER_DOC.trackersByDay[iso]) ? USER_DOC.trackersByDay[iso] : {};
      const water = clamp(parseInt(t?.water || 0, 10) || 0, 0, 30);
      wValEl.textContent = String(water);
      sleepVal.value = (t?.sleepHours != null && t.sleepHours !== "") ? String(t.sleepHours) : "";
      moodVal.value  = (t?.mood != null) ? String(t.mood) : "";

      // hetek sz√°ma (alap logika: start/balance/pro)
      // Ha k√©s≈ëbb meta alapj√°n akarod: planTemplates/{planId}.weeksCount ‚Üí akkor azt ide lehet tenni.
      if(String(PLAN_ID).toLowerCase().includes("start")) MAX_WEEKS = 4;
      else if(String(PLAN_ID).toLowerCase().includes("balance")) MAX_WEEKS = 6;
      else MAX_WEEKS = 12;

      ACTIVE_WEEK = 1;
      renderWeeks(MAX_WEEKS);

      await loadWeek();

      // ‚úÖ Chat widget init (k√ºl√∂n f√°jlb√≥l)
      const canUseChat = (USER_DOC?.paid === true) || isAdminEmail(email);
      initCustomerChatWidget({
        db, fs, escapeHtml,
        uid: user.uid,
        email,
        canUseChat,
        brand: "FitnessLady",
        theme: {
          pink: "#ff4fd8",
          pink2: "#b14cff",
          bg: "rgba(10,8,14,.78)"
        }
      });
    }

    async function loadWeek(){
      if(!CURRENT_USER) return;

      try{
        btnReload.disabled = true;

        // 1) template week
        const weekRef = fs.doc(db, "planTemplates", PLAN_ID, "weeks", String(ACTIVE_WEEK));
        const weekSnap = await fs.getDoc(weekRef);
        const base = weekSnap.exists() ? (weekSnap.data() || {}) : {};
        const baseWorkouts = Array.isArray(base.workouts) ? base.workouts : [];

        // 2) override week (user specific)
        const ovRef = fs.doc(db, "users", CURRENT_USER.uid, "overridesWeeks", String(ACTIVE_WEEK));
        const ovSnap = await fs.getDoc(ovRef);
        const ov = ovSnap.exists() ? (ovSnap.data() || {}) : {};
        const ovWorkouts = Array.isArray(ov.workouts) ? ov.workouts : null;

        const workouts = ovWorkouts || baseWorkouts;
        renderWorkouts(workouts);

        showMsg("K√©sz ‚úÖ", "ok");
      }catch(err){
        console.error(err);
        showMsg("Hiba a h√©t bet√∂lt√©sekor: " + (err?.message || String(err)), "err");
      }finally{
        btnReload.disabled = false;
      }
    }

    // ---------- trackers save ----------
    async function saveTrackers(){
      if(!CURRENT_USER) return;
      try{
        btnSaveTrackers.disabled = true;
        showTrk("Ment√©s‚Ä¶");

        const iso = todayISO();
        const water = clamp(parseInt(wValEl.textContent || "0", 10) || 0, 0, 30);

        const sleep = sleepVal.value === "" ? "" : clamp(parseFloat(sleepVal.value), 0, 16);
        const mood  = moodVal.value === "" ? "" : clamp(parseInt(moodVal.value,10), 1, 5);

        const ref = fs.doc(db, "users", CURRENT_USER.uid);

        // ‚úÖ trackersByDay[iso] merge
        const patch = {};
        patch["trackersByDay." + iso] = {
          water,
          sleepHours: sleep,
          mood,
          updatedAtIso: new Date().toISOString()
        };

        await fs.setDoc(ref, patch, { merge:true });

        showTrk("Mentve ‚úÖ", "ok");
      }catch(err){
        console.error(err);
        showTrk("Hiba: " + (err?.message || String(err)), "err");
      }finally{
        btnSaveTrackers.disabled = false;
      }
    }

    // ---------- events ----------
    $("#btnLogout").addEventListener("click", async ()=>{
      try{
        await logout();
      }catch(_){}
      toLogin("hu");
    });

    btnReload.addEventListener("click", loadWeek);

    wMinus.addEventListener("click", ()=>{
      const v = clamp(parseInt(wValEl.textContent||"0",10)||0, 0, 30);
      wValEl.textContent = String(clamp(v-1, 0, 30));
    });
    wPlus.addEventListener("click", ()=>{
      const v = clamp(parseInt(wValEl.textContent||"0",10)||0, 0, 30);
      wValEl.textContent = String(clamp(v+1, 0, 30));
    });
    btnSaveTrackers.addEventListener("click", saveTrackers);

    // ---------- auth guard ----------
    onAuth(async (user)=>{
      if(!user){
        toLogin("hu");
        return;
      }
      try{
        await loadUserAndBootstrap(user);
      }catch(err){
        console.error(err);
        showMsg("Hiba a bet√∂lt√©sn√©l: " + (err?.message || String(err)), "err");
      }
    });
  </script>
</body>
  </html>
