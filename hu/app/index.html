<script type="module">
  // =========================
  // GitHub Pages prefix + hero
  // =========================
  const BASE_PREFIX = (location.hostname.endsWith("github.io")) ? "/Fitnesslady" : "";
  document.documentElement.style.setProperty("--hero-url", `url("${BASE_PREFIX}/hero.png")`);

  // Home link fix
  const homeLink = document.getElementById("homeLink");
  if (homeLink) homeLink.href = `${BASE_PREFIX}/hu/`;

  // =========================
  // Firebase (Auth + Firestore)
  // =========================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    setDoc,
    getDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBl2MzyiRzgCzeg-eEWNHkc9Vxx-PgawfU",
    authDomain: "fitneady-15fd0.firebaseapp.com",
    projectId: "fitneady-15fd0",
    storageBucket: "fitneady-15fd0.firebasestorage.app",
    messagingSenderId: "480597492603",
    appId: "1:480597492603:web:2ba6c266c662b4c79e33de",
    measurementId: "G-MH1YK9C2YF"
  };

  const fbApp = initializeApp(firebaseConfig);
  try { getAnalytics(fbApp); } catch(e) {}

  const auth = getAuth(fbApp);
  const db = getFirestore(fbApp);

  // =========================
  // Helpers + UI shortcuts
  // =========================
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  const todayISO = () => new Date().toISOString().slice(0,10);
  const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
  const daysBetween = (a,b)=>Math.round((new Date(b)-new Date(a))/86400000);
  const fmtDate = (iso)=>{
    if(!iso) return "‚Äî";
    const d = new Date(iso+"T00:00:00");
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = d.getFullYear();
    return `${yy}.${mm}.${dd}`;
  };
  const escapeHtml = (s) => String(s ?? "").replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[c]));

  // Touch glow
  function enableTapGlow(selector=".interactive"){
    $$(selector).forEach(el=>{
      el.addEventListener("touchstart", ()=>{
        el.classList.add("is-active");
        window.clearTimeout(el.__t);
        el.__t = window.setTimeout(()=>el.classList.remove("is-active"), 650);
      }, {passive:true});
    });
  }
  enableTapGlow();

  // =========================
  // Demo adatok (marad a diz√°jn + strukt√∫ra)
  // =========================
  const DEMO = {
    profile: {
      package: "Start",
      goal: "Form√°l√°s",
      level: 2,
      cycleStart: "2026-02-10",
      cycleEnd: "2026-03-10",
      lastUpdated: "2026-02-13",
      checkinDone: 0
    },
    packages: {
      Start: { weeks: 4, workoutsPerWeek: 3, slotsPerWeek: 1 },
      Balance: { weeks: 6, workoutsPerWeek: 4, slotsPerWeek: 2 },
      Pro: { weeks: 8, workoutsPerWeek: 4, slotsPerWeek: 2 }
    },
    plans: {
      Start: [
        { week: 1, workouts: [
            { id:"W1-A", title:"Edz√©s A ‚Äî Full body (alap)", desc:"Technika + ritmus. 35‚Äì45 perc.", video:"https://player.vimeo.com/video/000000001" },
            { id:"W1-B", title:"Edz√©s B ‚Äî Als√≥test f√≥kusz", desc:"Farizom + comb, kontroll√°lt temp√≥.", video:"https://player.vimeo.com/video/000000002" },
            { id:"W1-C", title:"Edz√©s C ‚Äî Core + form√°l√°s", desc:"T√∂rzs stabilit√°s + finisher.", video:"https://player.vimeo.com/video/000000003" }
          ],
          slots: [
            { slot:"Slot 1", title:"Szem√©lyre szabott csere", desc:"Edina hetente 1 alkalommal friss√≠ti.", video:"https://player.vimeo.com/video/000000010", note:"Most: glute f√≥kusz (k√≠m√©l≈ë)." }
          ]
        },
        { week: 2, workouts: [
            { id:"W2-A", title:"Edz√©s A ‚Äî Full body (progresszi√≥)", desc:"Kicsit t√∂bb intenzit√°s, 35‚Äì45 perc.", video:"https://player.vimeo.com/video/000000004" },
            { id:"W2-B", title:"Edz√©s B ‚Äî Als√≥test + core", desc:"Farizom + core komb√≥.", video:"https://player.vimeo.com/video/000000005" },
            { id:"W2-C", title:"Edz√©s C ‚Äî Form√°sod√°s", desc:"Stabil terhel√©s, tarthat√≥.", video:"https://player.vimeo.com/video/000000006" }
          ],
          slots: [
            { slot:"Slot 1", title:"Szem√©lyre szabott csere", desc:"Halad√°s alapj√°n m√≥dos√≠tva.", video:"https://player.vimeo.com/video/000000011", note:"Most: core stabilit√°s (szint 2)." }
          ]
        },
        { week: 3, workouts: [
            { id:"W3-A", title:"Edz√©s A ‚Äî Full body (er≈ësebb)", desc:"R√∂videbb pihen≈ë, 35‚Äì45 perc.", video:"https://player.vimeo.com/video/000000007" },
            { id:"W3-B", title:"Edz√©s B ‚Äî Als√≥test (progresszi√≥)", desc:"T√©rdbar√°t opci√≥kkal.", video:"https://player.vimeo.com/video/000000008" },
            { id:"W3-C", title:"Edz√©s C ‚Äî Core + cardio light", desc:"Low impact finisher.", video:"https://player.vimeo.com/video/000000009" }
          ],
          slots: [
            { slot:"Slot 1", title:"Szem√©lyre szabott csere", desc:"Edina friss√≠tette.", video:"https://player.vimeo.com/video/000000012", note:"Most: glute builder (szint 2)." }
          ]
        },
        { week: 4, workouts: [
            { id:"W4-A", title:"Edz√©s A ‚Äî Deload / finom√≠t√°s", desc:"Technika, min≈ës√©g, nem t√∫ler≈ëltet√©s.", video:"https://player.vimeo.com/video/000000013" },
            { id:"W4-B", title:"Edz√©s B ‚Äî Forma-h√©t", desc:"Feszes√≠t√©s + kontroll.", video:"https://player.vimeo.com/video/000000014" },
            { id:"W4-C", title:"Edz√©s C ‚Äî Teszt & z√°r√°s", desc:"√ârz√©s, ism√©tl√©s, r√∂gz√≠t√©s.", video:"https://player.vimeo.com/video/000000015" }
          ],
          slots: [
            { slot:"Slot 1", title:"Szem√©lyre szabott csere", desc:"Z√°r√≥ h√©t finomhangol√°s.", video:"https://player.vimeo.com/video/000000016", note:"Most: mobilit√°s + core reset." }
          ]
        }
      ]
    },
    tech: {
      categories: [
        { id:"tech_squat", name:"Guggol√°s" },
        { id:"tech_hinge", name:"Cs√≠p≈ë-hajl√≠t√°s" },
        { id:"tech_core", name:"Core" },
        { id:"tech_posture", name:"Tart√°s" }
      ],
      items: {
        tech_squat: [
          { id:"T-SQ-1", title:"Guggol√°s ‚Äî alap be√°ll√≠t√°s", desc:"L√°bfej, t√©rd, t√∂rzs. 2‚Äì3 perc.", video:"https://player.vimeo.com/video/000000101" },
          { id:"T-SQ-2", title:"Guggol√°s ‚Äî gyakori hib√°k", desc:"T√©rd befel√©, t√∫l m√©ly, temp√≥.", video:"https://player.vimeo.com/video/000000102" }
        ],
        tech_hinge: [
          { id:"T-HI-1", title:"RDL / cs√≠p≈ë-hajl√≠t√°s ‚Äî alap", desc:"Cs√≠p≈ë h√°tra, semleges gerinc.", video:"https://player.vimeo.com/video/000000103" },
          { id:"T-HI-2", title:"Hinge ‚Äî der√©k v√©delem", desc:"Mit≈ël f√°j, √©s hogyan jav√≠tsd.", video:"https://player.vimeo.com/video/000000104" }
        ],
        tech_core: [
          { id:"T-CO-1", title:"Plank ‚Äî helyes tart√°s", desc:"Lapocka, medence, l√©gz√©s.", video:"https://player.vimeo.com/video/000000105" },
          { id:"T-CO-2", title:"Dead bug ‚Äî kontroll", desc:"Der√©k leszor√≠t, lass√∫ temp√≥.", video:"https://player.vimeo.com/video/000000106" },
          { id:"T-CO-3", title:"L√©gz√©s ‚Äî core aktiv√°l√°s", desc:"R√∂vid drill edz√©s el≈ëtt.", video:"https://player.vimeo.com/video/000000107" }
        ],
        tech_posture: [
          { id:"T-PO-1", title:"Tart√°s ‚Äî v√°ll/nyak", desc:"1‚Äì2 perces gyors fix.", video:"https://player.vimeo.com/video/000000108" },
          { id:"T-PO-2", title:"Mobilit√°s ‚Äî cs√≠p≈ë", desc:"R√∂vid mobilit√°s blokk.", video:"https://player.vimeo.com/video/000000109" }
        ]
      }
    }
  };

  // =========================
  // User-scoped localStorage (done/diet/checkin)
  // =========================
  const k = (uid, key) => `fl_${uid}_${key}_v1`;
  const lsGet = (uid, key, fallback) => {
    try {
      const v = localStorage.getItem(k(uid,key));
      return v ? JSON.parse(v) : fallback;
    } catch { return fallback; }
  };
  const lsSet = (uid, key, value) => localStorage.setItem(k(uid,key), JSON.stringify(value));

  // =========================
  // Modals
  // =========================
  const authOverlay = $("#authOverlay");
  const settingsOverlay = $("#settingsOverlay");
  const infoOverlay = $("#infoOverlay");
  const infoBody = $("#infoBody");
  const infoTitle = $("#infoTitle");

  function openOverlay(overlay){
    overlay.classList.add("is-open");
    overlay.setAttribute("aria-hidden","false");
  }
  function closeOverlay(overlay){
    overlay.classList.remove("is-open");
    overlay.setAttribute("aria-hidden","true");
  }
  function openInfo(title, html){
    infoTitle.textContent = title;
    infoBody.innerHTML = html;
    openOverlay(infoOverlay);
  }

  $("#authClose").addEventListener("click", ()=>closeOverlay(authOverlay));
  $("#settingsClose").addEventListener("click", ()=>closeOverlay(settingsOverlay));
  $("#infoClose").addEventListener("click", ()=>closeOverlay(infoOverlay));

  authOverlay.addEventListener("click",(e)=>{ if(e.target===authOverlay) closeOverlay(authOverlay); });
  settingsOverlay.addEventListener("click",(e)=>{ if(e.target===settingsOverlay) closeOverlay(settingsOverlay); });
  infoOverlay.addEventListener("click",(e)=>{ if(e.target===infoOverlay) closeOverlay(infoOverlay); });

  document.addEventListener("keydown",(e)=>{
    if(e.key==="Escape"){
      [authOverlay, settingsOverlay, infoOverlay].forEach(ov=>{
        if(ov.classList.contains("is-open")) closeOverlay(ov);
      });
    }
  });

  // =========================
  // Mobile menu + active nav
  // =========================
  const menuBtn = $("#menuBtn");
  let menuOpen = false;

  function closeMobileNav(){
    $("#mobileNav")?.remove();
    menuOpen = false;
  }

  menuBtn?.addEventListener("click", ()=>{
    if(menuOpen){ closeMobileNav(); return; }
    closeMobileNav();

    menuOpen = true;
    const nav = document.createElement("div");
    nav.id = "mobileNav";
    nav.style.position = "fixed";
    nav.style.top = "64px";
    nav.style.left = "14px";
    nav.style.right = "14px";
    nav.style.zIndex = "60";
    nav.style.background = "rgba(20,12,26,.72)";
    nav.style.border = "1px solid rgba(255,255,255,.10)";
    nav.style.borderRadius = "18px";
    nav.style.backdropFilter = "blur(14px)";
    nav.style.boxShadow = "0 20px 70px rgba(0,0,0,.55)";
    nav.style.padding = "12px";
    nav.innerHTML = `
      <a href="#program" style="display:block; padding:10px 10px; color:rgba(255,255,255,.86)">Programom</a>
      <a href="#etrend" style="display:block; padding:10px 10px; color:rgba(255,255,255,.86)">√âtrend</a>
      <a href="#checkin" style="display:block; padding:10px 10px; color:rgba(255,255,255,.86)">C√©lom & Check-in</a>
      <a href="#technika" style="display:block; padding:10px 10px; color:rgba(255,255,255,.86)">Technika</a>
    `;
    document.body.appendChild(nav);
  });

  document.addEventListener("click",(e)=>{
    const nav = $("#mobileNav");
    if(!nav) return;
    if(e.target === menuBtn) return;
    if(nav.contains(e.target)) { closeMobileNav(); return; }
    closeMobileNav();
  });

  (()=> {
    const links = $$('[data-nav]');
    const sections = links
      .map(a => document.querySelector(a.getAttribute('href')))
      .filter(Boolean);

    const setActive = (id) => {
      links.forEach(a => a.classList.toggle('is-active', a.getAttribute('href') === `#${id}`));
    };

    const io = new IntersectionObserver((entries)=>{
      const visible = entries.filter(e=>e.isIntersecting).sort((a,b)=>b.intersectionRatio-a.intersectionRatio)[0];
      if(visible?.target?.id) setActive(visible.target.id);
    }, { threshold: [0.18, 0.28, 0.4] });

    sections.forEach(s=>io.observe(s));
  })();

  // =========================
  // Firestore profile
  // =========================
  async function ensureUserProfile(user){
    const ref = doc(db, "users", user.uid);
    const snap = await getDoc(ref);
    if (snap.exists()) return snap.data();

    const initial = {
      email: user.email,
      package: DEMO.profile.package,
      goal: DEMO.profile.goal,
      level: DEMO.profile.level,
      active: true,
      cycleStart: DEMO.profile.cycleStart,
      cycleEnd: DEMO.profile.cycleEnd,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    };
    await setDoc(ref, initial, { merge: true });
    return initial;
  }

  // =========================
  // App state + render
  // =========================
  let uid = null;
  let state = null;

  function calcWeekIndex(profile){
    const start = profile.cycleStart;
    const end = profile.cycleEnd;
    const totalDays = Math.max(1, daysBetween(start,end));
    const passedDays = clamp(daysBetween(start, todayISO()), 0, totalDays);
    const weeks = DEMO.packages[profile.package]?.weeks ?? 4;
    const week = clamp(Math.floor((passedDays / totalDays) * weeks) + 1, 1, weeks);
    return week - 1;
  }

  function renderHeader(){
    const p = state.profile;
    const pack = DEMO.packages[p.package] ? p.package : "Start";
    p.package = pack;

    $("#chipPackage").textContent = `Csomag: ${p.package}`;
    $("#pillGoal").textContent = `üéØ C√©l: ${p.goal || "‚Äî"}`;
    $("#pillIntensity").textContent = `‚ö° Szint: ${p.level ? `${p.level}/4` : "‚Äî"}`;
    $("#pillUpdated").textContent = `‚ú® Utols√≥ friss√≠t√©s: ${p.updatedAtHuman || "‚Äî"}`;

    const totalDays = Math.max(1, daysBetween(p.cycleStart, p.cycleEnd));
    const passedDays = clamp(daysBetween(p.cycleStart, todayISO()), 0, totalDays);
    const leftDays = clamp(totalDays - passedDays, 0, totalDays);

    const weeks = DEMO.packages[p.package]?.weeks ?? 4;
    const week = clamp(Math.floor((passedDays / totalDays) * weeks) + 1, 1, weeks);

    $("#lblWeek").textContent = `H√©t: ${week}/${weeks}`;
    $("#lblDays").textContent = `H√°tral√©v≈ë napok: ${leftDays}`;

    const pct = Math.round((passedDays / totalDays) * 100);
    $("#barCycle").style.width = `${pct}%`;

    const status = leftDays === 0
      ? `A csomagod lej√°rt (${fmtDate(p.cycleEnd)}). A Technika Vault tov√°bbra is el√©rhet≈ë.`
      : `Akt√≠v id≈ëszak: ${fmtDate(p.cycleStart)} ‚Äî ${fmtDate(p.cycleEnd)} ‚Ä¢ K√∂vetkez≈ë l√©p√©s: tartsd a ritmust √©s pip√°ld a heti edz√©seket.`;
    $("#subStatus").textContent = status;

    $("#goalTitle").textContent = `üéØ C√©l: ${p.goal || "‚Äî"}`;
    $("#goalDesc").textContent = p.goal
      ? `F√≥kusz: ${p.goal}. Heti check-in seg√≠t finomhangolni a k√∂vetkez≈ë edz√©seket √©s az √©trendet.`
      : `√Åll√≠ts be c√©lt, hogy a program m√©g pontosabban illeszkedjen hozz√°d.`;

    const done = state.checkin?.done ? 1 : 0;
    $("#checkinLabel").textContent = `${done}/1`;
    $("#barCheckin").style.width = `${done*100}%`;

    const expired = leftDays === 0;
    $("#program").style.opacity = expired ? .55 : 1;
    $("#program").style.pointerEvents = expired ? "none" : "auto";
    if(expired){
      $("#motivationBox").textContent = "A Technika Vault √∂r√∂k. A teljes programhoz √∫j√≠ts meg vagy v√°lts csomagot.";
    }
  }

  function renderWeekTabs(){
    const p = state.profile;
    const weeks = DEMO.packages[p.package]?.weeks ?? 4;
    const cur = calcWeekIndex(p);
    state.weekIdx = clamp(state.weekIdx ?? cur, 0, weeks-1);

    const tabs = $("#weekTabs");
    tabs.innerHTML = "";
    for(let i=0;i<weeks;i++){
      const b = document.createElement("button");
      b.className = "tab" + (i===state.weekIdx ? " is-active" : "");
      b.type = "button";
      b.textContent = `H√©t ${i+1}`;
      b.addEventListener("click", ()=>{
        state.weekIdx = i;
        renderProgram();
      });
      tabs.appendChild(b);
    }
  }

  function workoutKey(week, id){ return `w${week}_${id}`; }
  function techKey(cat, id){ return `t_${cat}_${id}`; }

  function renderProgram(){
    renderWeekTabs();

    const p = state.profile;
    const packPlan = DEMO.plans[p.package] || DEMO.plans.Start;
    const weekObj = packPlan[state.weekIdx] || packPlan[0];

    const ul = $("#workoutList");
    ul.innerHTML = "";
    weekObj.workouts.forEach(w=>{
      const key = workoutKey(weekObj.week, w.id);
      const done = !!state.done[key];

      const li = document.createElement("li");
      li.className = "row";
      li.innerHTML = `
        <div>
          <div class="title">${escapeHtml(w.title)} ${done ? ' <span class="chip" style="margin-left:6px;">‚úÖ k√©sz</span>' : ''}</div>
          <div class="desc">${escapeHtml(w.desc)}</div>
        </div>
        <div class="actions">
          <button class="pill ghost tiny" data-play="${escapeHtml(w.video)}">‚ñ∂ Lej√°tsz√°s</button>
          <button class="pill ${done ? 'danger' : 'primary'} tiny" data-toggle-done="${escapeHtml(key)}">${done ? 'Visszavon' : 'K√©sz'}</button>
        </div>
      `;
      ul.appendChild(li);
    });

    const sl = $("#slotList");
    sl.innerHTML = "";
    weekObj.slots.forEach((s, idx)=>{
      const key = `slot_w${weekObj.week}_${idx}`;
      const li = document.createElement("li");
      li.className = "row";
      li.innerHTML = `
        <div>
          <div class="title">${escapeHtml(s.slot)} ‚Äî ${escapeHtml(s.title)}</div>
          <div class="desc">${escapeHtml(s.desc)}<br><span style="color:rgba(255,255,255,.72); font-size:12.6px;">Megjegyz√©s: ${escapeHtml(s.note||"‚Äî")}</span></div>
        </div>
        <div class="actions">
          <button class="pill ghost tiny" data-play="${escapeHtml(s.video)}">‚ñ∂ Lej√°tsz√°s</button>
          <button class="pill ghost tiny" data-request-swap="${escapeHtml(key)}">üîÅ Csere k√©r√©se</button>
        </div>
      `;
      sl.appendChild(li);
    });

    $$("[data-play]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const url = b.getAttribute("data-play");
        openInfo("Lej√°tsz√°s (teszt)", `
          <p class="note">Teszt m√≥dban a vide√≥ hely√©re Vimeo embed linket mutatunk. √âlesben itt j√∂n a domain-lockolt Vimeo lej√°tsz√≥.</p>
          <div class="row" style="grid-template-columns: 1fr;">
            <div class="title">Vimeo embed URL</div>
            <div class="desc"><code style="white-space:pre-wrap; word-break:break-word;">${escapeHtml(url)}</code></div>
          </div>
        `);
      });
    });

    $$("[data-toggle-done]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const key = b.getAttribute("data-toggle-done");
        state.done[key] = !state.done[key];
        lsSet(uid, "done", state.done);
        renderProgram();
      });
    });

    $$("[data-request-swap]").forEach(b=>{
      b.addEventListener("click", ()=>{
        openInfo("Csere k√©r√©se (teszt)", `
          <p>√âlesben ez admin ‚Äúto-do‚Äù vagy WhatsApp/Email Edin√°nak.</p>
          <div class="row" style="grid-template-columns: 1fr;">
            <div class="title">√úzenet minta</div>
            <div class="desc">
              <code style="white-space:pre-wrap; word-break:break-word;">
Szia Edina! K√©rlek n√©zd meg a heti szem√©lyre szab√°s slotomat (H√©t ${weekObj.week}).
√ögy √©rzem: [t√∫l k√∂nny≈± / t√∫l neh√©z / f√°j a t√©rdem / t√∂bb glute f√≥kusz]. K√∂szi! üòä
              </code>
            </div>
          </div>
        `);
      });
    });
  }

  function renderTechnika(){
    const tabs = $("#techTabs");
    tabs.innerHTML = "";
    DEMO.tech.categories.forEach(c=>{
      const b = document.createElement("button");
      b.className = "tab" + (c.id===state.techCat ? " is-active" : "");
      b.type = "button";
      b.textContent = c.name;
      b.addEventListener("click", ()=>{
        state.techCat = c.id;
        renderTechnika();
      });
      tabs.appendChild(b);
    });

    const list = $("#techList");
    list.innerHTML = "";
    const items = DEMO.tech.items[state.techCat] || [];
    items.forEach(it=>{
      const key = techKey(state.techCat, it.id);
      const done = !!state.done[key];

      const li = document.createElement("li");
      li.className = "row";
      li.innerHTML = `
        <div>
          <div class="title">${escapeHtml(it.title)} ${done ? ' <span class="chip" style="margin-left:6px;">‚úÖ megvolt</span>' : ''}</div>
          <div class="desc">${escapeHtml(it.desc)}</div>
        </div>
        <div class="actions">
          <button class="pill ghost tiny" data-play="${escapeHtml(it.video)}">‚ñ∂ Lej√°tsz√°s</button>
          <button class="pill ${done ? 'danger' : 'primary'} tiny" data-toggle-tech="${escapeHtml(key)}">${done ? 'Visszavon' : 'Megvolt'}</button>
        </div>
      `;
      list.appendChild(li);
    });

    $$("[data-toggle-tech]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const key = b.getAttribute("data-toggle-tech");
        state.done[key] = !state.done[key];
        lsSet(uid, "done", state.done);
        renderTechnika();
      });
    });

    $$("[data-play]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const url = b.getAttribute("data-play");
        openInfo("Lej√°tsz√°s (teszt)", `
          <p class="note">Teszt m√≥dban csak a Vimeo embed URL-t mutatjuk.</p>
          <div class="row" style="grid-template-columns: 1fr;">
            <div class="title">Vimeo embed URL</div>
            <div class="desc"><code style="white-space:pre-wrap; word-break:break-word;">${escapeHtml(url)}</code></div>
          </div>
        `);
      });
    });
  }

  function refreshDietButtons(){
    const d = state.diet;
    $$("[data-toggle]").forEach(btn=>{
      const key = btn.getAttribute("data-toggle");
      const on = !!d[key];
      btn.classList.toggle("primary", on);
      btn.classList.toggle("ghost", !on);
    });
  }

  function renderAll(){
    renderHeader();
    renderProgram();
    renderTechnika();
    refreshDietButtons();
    enableTapGlow();
  }

  // =========================
  // Buttons (a te megl√©v≈ë gombjaidra k√∂tve)
  // =========================
  $("#btnMarkAll").addEventListener("click", ()=>{
    const p = state.profile;
    const packPlan = DEMO.plans[p.package] || DEMO.plans.Start;
    const weekObj = packPlan[state.weekIdx] || packPlan[0];
    weekObj.workouts.forEach(w=> state.done[workoutKey(weekObj.week, w.id)] = true);
    lsSet(uid, "done", state.done);
    renderProgram();
  });

  $("#btnResetWeek").addEventListener("click", ()=>{
    const p = state.profile;
    const packPlan = DEMO.plans[p.package] || DEMO.plans.Start;
    const weekObj = packPlan[state.weekIdx] || packPlan[0];
    weekObj.workouts.forEach(w=> delete state.done[workoutKey(weekObj.week, w.id)]);
    lsSet(uid, "done", state.done);
    renderProgram();
  });

  $("#btnAddTechDone").addEventListener("click", ()=>{
    const items = DEMO.tech.items[state.techCat] || [];
    items.forEach(it=> state.done[techKey(state.techCat, it.id)] = true);
    lsSet(uid, "done", state.done);
    renderTechnika();
  });

  $$("[data-toggle]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const key = btn.getAttribute("data-toggle");
      state.diet[key] = !state.diet[key];
      lsSet(uid, "diet", state.diet);
      refreshDietButtons();
    });
  });

  const MOTS = [
    "‚ÄûA rendszer nem nyom√°s. A rendszer szabads√°g.‚Äù",
    "‚ÄûA halad√°s nem t√∂k√©letess√©g. Hanem k√∂vetkezetess√©g.‚Äù",
    "‚ÄûNem csak form√°t √©p√≠tesz ‚Äì bizalmat √©s j√∂v≈ët.‚Äù",
    "‚ÄûAmit ma megteszel, az a holnapi √∂nbizalmad.‚Äù"
  ];
  $("#btnMotivation").addEventListener("click", ()=>{
    const m = MOTS[Math.floor(Math.random()*MOTS.length)];
    $("#motivationBox").textContent = m;
  });

  $("#btnDoCheckin").addEventListener("click", ()=>{
    openInfo("Check-in (teszt)", `
      <p class="note">Tesztben: egy kattint√°s ‚Äúk√©sz‚Äù-re √°ll√≠tja.</p>
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <button class="pill primary tiny" id="btnConfirmCheckin" type="button">‚úÖ Check-in k√©sz (teszt)</button>
      </div>
    `);

    setTimeout(()=>{
      $("#btnConfirmCheckin")?.addEventListener("click", ()=>{
        state.checkin = { done: true, at: new Date().toISOString() };
        lsSet(uid, "checkin", state.checkin);
        closeOverlay(infoOverlay);
        renderHeader();
      });
    }, 0);
  });

  $("#btnOpenSettings").addEventListener("click", ()=>{
    const p = state.profile;
    $("#setPackage").value = p.package || "Start";
    $("#setGoal").value = p.goal || "";
    $("#setLevel").value = p.level || 2;
    $("#setStart").value = p.cycleStart || todayISO();
    $("#setEnd").value = p.cycleEnd || todayISO();
    openOverlay(settingsOverlay);
  });

  $("#btnSaveSettings").addEventListener("click", async ()=>{
    const p = state.profile;
    p.package = ($("#setPackage").value || "Start").trim();
    p.goal = ($("#setGoal").value || "Form√°l√°s").trim();
    p.level = clamp(parseInt($("#setLevel").value || "2",10),1,4);
    p.cycleStart = ($("#setStart").value || todayISO()).trim();
    p.cycleEnd = ($("#setEnd").value || todayISO()).trim();
    p.updatedAtHuman = fmtDate(todayISO());

    // ment√©s Firestore-ba is
    await setDoc(doc(db, "users", uid), {
      package: p.package,
      goal: p.goal,
      level: p.level,
      cycleStart: p.cycleStart,
      cycleEnd: p.cycleEnd,
      updatedAt: serverTimestamp()
    }, { merge: true });

    closeOverlay(settingsOverlay);
    renderAll();
  });

  // =========================
  // AUTH: a modal gombok Firebase-re k√∂tve
  // =========================
  function openAuth(){
    $("#authMsg").textContent = "";
    $("#pw").value = "";
    $("#pw1").value = "";
    $("#pw2").value = "";
    openOverlay(authOverlay);
  }

  $("#btnActivate").addEventListener("click", async ()=>{
    const email = ($("#email").value || "").trim().toLowerCase();
    const pw1 = $("#pw1").value || "";
    const pw2 = $("#pw2").value || "";

    if(!email || !email.includes("@")) return $("#authMsg").textContent = "Adj meg √©rv√©nyes e-mailt.";
    if(pw1.length < 6) return $("#authMsg").textContent = "A jelsz√≥ legyen legal√°bb 6 karakter.";
    if(pw1 !== pw2) return $("#authMsg").textContent = "A k√©t jelsz√≥ nem egyezik.";

    try{
      await createUserWithEmailAndPassword(auth, email, pw1);
      $("#authMsg").textContent = "Sikeres regisztr√°ci√≥ ‚úÖ Most bel√©pve vagy.";
    }catch(e){
      $("#authMsg").textContent = e?.message || "Regisztr√°ci√≥s hiba.";
    }
  });

  $("#btnLogin").addEventListener("click", async ()=>{
    const email = ($("#email").value || "").trim().toLowerCase();
    const pw = $("#pw").value || "";

    if(!email || !email.includes("@")) return $("#authMsg").textContent = "Adj meg √©rv√©nyes e-mailt.";
    if(!pw) return $("#authMsg").textContent = "√çrd be a jelsz√≥t.";

    try{
      await signInWithEmailAndPassword(auth, email, pw);
      $("#authMsg").textContent = "Bel√©pve ‚úÖ";
    }catch(e){
      $("#authMsg").textContent = e?.message || "Bel√©p√©si hiba.";
    }
  });

  $("#btnLogout").addEventListener("click", async ()=>{
    await signOut(auth);
    openAuth();
  });

  // =========================
  // INIT + auth state
  // =========================
  document.getElementById("y").textContent = new Date().getFullYear();

  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      uid = null;
      openAuth();
      return;
    }

    uid = user.uid;

    // profil Firestore-b√≥l
    const prof = await ensureUserProfile(user);

    // user-scoped local state
    state = {
      profile: {
        ...DEMO.profile,
        ...prof,
        email: user.email,
        updatedAtHuman: prof?.updatedAt ? "‚Äî" : (prof?.lastUpdated ? fmtDate(prof.lastUpdated) : "‚Äî")
      },
      done: lsGet(uid, "done", {}),
      diet: lsGet(uid, "diet", {}),
      checkin: lsGet(uid, "checkin", null),
      weekIdx: 0,
      techCat: DEMO.tech.categories[0]?.id || "tech_core"
    };

    closeOverlay(authOverlay);
    renderAll();
  });
      </script>
