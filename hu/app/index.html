<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fitness Lady ‚Äî Saj√°t programom</title>
  <meta name="description" content="Fitness Lady ‚Äî Saj√°t programom: csomag, heti edz√©sek, √©trend, check-in, motiv√°ci√≥." />

  <style>
    :root{
      --bg: #07060b;
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --pink: #ff4fd8;
      --pink2: #b14cff;
      --gold: #ffd38a;
      --radius: 22px;
      --max: 1180px;
    }
    
    *{ box-sizing: border-box; }
    html, body { height: 100%; }
    html { scroll-behavior: smooth; }
    
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background-color: var(--bg);
      background-image: 
        radial-gradient(circle at 15% 10%, rgba(255,79,216,.15) 0%, transparent 40%),
        radial-gradient(circle at 85% 80%, rgba(177,76,255,.12) 0%, transparent 45%);
      background-attachment: fixed;
      background-size: cover;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    a { color: inherit; text-decoration: none; }
    button { font: inherit; }
    .container { width: min(var(--max), 92vw); margin: 0 auto; }

    /* Topbar */
    .topbar {
      position: fixed; top: 0; left: 0; right: 0;
      z-index: 50;
      background: rgba(8,6,12,.75);
      border-bottom: 1px solid rgba(255,255,255,.06);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      transform: translateZ(0); 
    }
    .topbar-inner {
      height: 64px;
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
    }
    .brand {
      display: flex; align-items: center; gap: 10px;
      font-weight: 800; letter-spacing: .2px; white-space: nowrap;
    }
    .dot {
      width: 10px; height: 10px; border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #ffd0f6, var(--pink));
      box-shadow: 0 0 16px rgba(255,79,216,.6);
      flex: 0 0 auto;
    }
    .nav {
      display: flex; align-items: center; gap: 14px;
      color: var(--muted); font-size: 13.5px; font-weight: 700;
    }
    .nav a { position: relative; padding: 10px 6px; opacity: .92; transition: color .2s; }
    .nav a:hover { color: var(--text); }
    .nav a::after {
      content: ""; position: absolute; left: 8px; right: 8px; bottom: 4px;
      height: 2px; border-radius: 99px;
      background: linear-gradient(90deg, transparent, rgba(255,215,140,.9), transparent);
      transform: scaleX(0); transition: transform .3s ease;
    }
    .nav a:hover::after { transform: scaleX(1); }

    .pill {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 9px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,.12);
      background: rgba(20,12,26,.65); color: var(--text);
      cursor: pointer; user-select: none; gap: 8px; white-space: nowrap;
      transition: transform .2s, border-color .2s, background .2s;
      transform: translateZ(0);
      will-change: transform;
    }
    .pill:active { transform: scale(0.96); }
    .pill:hover { border-color: rgba(255,255,255,.22); background: rgba(255,255,255,.08); }
    .pill.primary {
      background: linear-gradient(135deg, var(--pink), var(--pink2));
      color: #140813; border-color: transparent; font-weight: 900;
      box-shadow: 0 8px 24px rgba(255,79,216,.2);
    }

    .menu-btn {
      width: 40px; height: 40px; border-radius: 999px;
      background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.10);
      color: var(--text); display: none; align-items: center; justify-content: center; cursor: pointer;
    }

    main { padding-top: 64px; min-height: 100vh; }
    .page { padding: 18px 0 64px; }

    .glass {
      background: rgba(18, 12, 26, 0.55);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 22px;
      box-shadow: 0 16px 40px rgba(0,0,0,.3);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transform: translateZ(0); 
    }

    .grid { display: grid; grid-template-columns: 1.2fr .8fr; gap: 14px; align-items: start; }
    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
      .nav { display: none; }
      .menu-btn { display: inline-flex; }
    }

    .card { padding: 18px; margin-bottom: 14px; }
    .card h2, .card h3 { margin: 0 0 6px; font-family: ui-serif, Georgia, serif; letter-spacing: -.2px; }
    .card h2 { font-size: 22px; }
    .card h3 { font-size: 18px; }
    .sub { margin: 0 0 12px; color: var(--muted); line-height: 1.5; font-size: 13.5px; }

    .meta-row { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; font-size: 12.8px; }
    .meta-pill {
      display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px;
      border-radius: 999px; background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.08);
    }

    .progress {
      background: rgba(0,0,0,.4); border: 1px solid rgba(255,255,255,.08);
      border-radius: 999px; height: 12px; overflow: hidden; position: relative;
    }
    .progress > span {
      display: block; height: 100%; width: 0%; border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,79,216,.9), rgba(177,76,255,.9));
      transition: width .4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .progress.blue > span { background: linear-gradient(90deg, #4facfe, #00f2fe); }
    .progress.green > span { background: linear-gradient(90deg, #43e97b, #38f9d7); }
    
    .progress-label {
      display: flex; justify-content: space-between; font-size: 12.5px;
      color: rgba(255,255,255,.6); margin: 10px 0 6px; font-weight: 600;
    }

    .tabs { display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 0 14px; }
    .tab {
      padding: 8px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05); color: rgba(255,255,255,.85);
      cursor: pointer; font-size: 13px; font-weight: 800; transition: all .2s;
    }
    .tab.is-active {
      background: linear-gradient(135deg, var(--pink), var(--pink2));
      color: #140813; border-color: transparent; box-shadow: 0 4px 12px rgba(255,79,216,.25);
    }

    .list { margin: 0; padding: 0; list-style: none; display: grid; gap: 10px; }
    .row {
      display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;
      padding: 12px; border-radius: 16px; background: rgba(0,0,0,.25); border: 1px solid rgba(255,255,255,.06);
    }
    .row .title { font-weight: 800; font-size: 14px; }
    .row .desc { color: rgba(255,255,255,.65); font-size: 12.8px; margin-top: 4px; line-height: 1.4; }
    .row .actions { display: flex; gap: 8px; justify-content: flex-end; }
    .tiny { padding: 6px 10px; font-size: 12px; }

    .chip {
      display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px;
      border-radius: 999px; border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07); color: rgba(255,255,255,.8); font-weight: 800; font-size: 12px;
    }

    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 80;
      background: rgba(0,0,0,.7); backdrop-filter: blur(8px);
      display: none; align-items: center; justify-content: center; padding: 18px;
    }
    .modal-overlay.is-open { display: flex; }
    .modal { width: min(980px, 94vw); max-height: min(85vh, 760px); border-radius: 22px; overflow: hidden; position: relative; }
    .modal-header {
      display: flex; align-items: center; justify-content: space-between; padding: 14px 18px;
      border-bottom: 1px solid rgba(255,255,255,.08); background: rgba(18,12,26,.9);
    }
    .modal-title { margin: 0; font-family: ui-serif; font-size: 20px; }
    .modal-close {
      width: 36px; height: 36px; border-radius: 999px; border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06); color: #fff; cursor: pointer;
    }
    .modal-body { padding: 16px; overflow-y: auto; max-height: calc(min(85vh, 760px) - 64px); background: #0a080f; }
    
    .field { display: grid; gap: 6px; margin: 10px 0; }
    .field label { color: rgba(255,255,255,.7); font-size: 12.5px; font-weight: 700; }
    .field input {
      height: 44px; border-radius: 12px; border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.3); color: #fff; padding: 0 12px; outline: none;
    }

    footer { padding: 18px 0 36px; border-top: 1px solid rgba(255,255,255,.05); text-align: center; font-size: 13px; color: var(--muted); }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="container topbar-inner">
      <a class="brand" id="homeLink" href="#" aria-label="Vissza a f≈ëoldalra">
        <span class="dot"></span><span>Fitness Lady</span>
      </a>
      <nav class="nav" aria-label="Vev≈ë men√º">
        <a href="#program" data-nav>Programom</a>
        <a href="#etrend" data-nav>√âtrend</a>
        <a href="#checkin" data-nav>Napi C√©lok</a>
        <a href="#technika" data-nav>Technika</a>
      </nav>
      <div style="display:flex; align-items:center; gap:10px;">
        <button class="menu-btn" id="menuBtn" type="button">‚ò∞</button>
        <button class="pill ghost" id="btnLogout" type="button" title="Kijelentkez√©s">‚éã Kil√©p√©s</button>
      </div>
    </div>
  </header>

  <main>
    <div class="container page">
      
      <section id="top" class="glass card">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;">
          <div>
            <div class="chip" id="chipPackage">Csomag: ‚Äî</div>
            <h2 style="margin-top:10px;" id="titleProgram">Saj√°t programom</h2>
            <p class="sub" id="subStatus">Bet√∂lt√©s‚Ä¶</p>
          </div>
          <div>
            <button class="pill ghost" id="btnOpenSettings" type="button">‚öô Be√°ll√≠t√°sok</button>
          </div>
        </div>

        <div class="progress-label">
          <span id="lblWeek">H√©t: ‚Äî</span>
          <span id="lblDays">St√°tusz: ‚Äî</span>
        </div>
        <div class="progress"><span id="barCycle"></span></div>

        <div class="meta-row">
          <div class="meta-pill" id="pillGoal">üéØ C√©l: ‚Äî</div>
          <div class="meta-pill" id="pillIntensity">‚ö° Szint: ‚Äî</div>
        </div>
      </section>

      <div class="grid">
        <section id="program" class="glass card">
          <h3 id="hWorkouts">Heti edz√©sek</h3>
          <p class="sub" id="pWorkouts">Heti bont√°sban l√°tod az edz√©seidet. A szem√©lyre szab√°sokat Edina friss√≠ti.</p>

          <div class="tabs" id="weekTabs" aria-label="H√©t v√°laszt√≥"></div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin: 0 0 10px;">
            <button class="pill ghost tiny" id="btnResetWeek" type="button">‚Ü∫ H√©t √∫jraind√≠t√°sa</button>
          </div>

          <ul class="list" id="workoutList"></ul>

          <hr style="border:none; height:1px; background:rgba(255,255,255,.08); margin: 18px 0;" />
          <h3 id="hSlots">Szem√©lyre szab√°s</h3>
          <p class="sub" id="pSlots">A te programodhoz tartoz√≥ egyedi extra vide√≥k.</p>
          <ul class="list" id="slotList"></ul>
        </section>

        <div style="display:grid; gap:14px;">
          
          <section id="etrend" class="glass card">
            <h3>Napi √âtrend</h3>
            <p class="sub">A kiv√°lasztott h√©thez tartoz√≥, napokra bontott √©tkez√©seid.</p>

            <div class="tabs" id="dietDays" style="margin-bottom:12px;"></div>
            <div id="dietDetails" style="display:grid; gap:8px;"></div>
          </section>

          <section id="checkin" class="glass card">
            <h3>Napi C√©lok & Check-in</h3>
            <p class="sub">K√∂vesd a napi folyad√©kot, alv√°st √©s pip√°ld ki a napot!</p>

            <div style="display:grid; gap:14px;">
              
               <div>
                <div class="progress-label" style="margin-top:0;"><span>üíß V√≠z</span><span id="lblWater">0/8 poh√°r</span></div>
                <div class="progress blue"><span id="barWater"></span></div>
                <div style="margin-top:8px;"><button class="pill ghost tiny" id="btnAddWater" type="button">+1 Poh√°r</button></div>
              </div>

               <div>
                <div class="progress-label" style="margin-top:0;"><span>üåô Alv√°s</span><span id="lblSleep">0/8 √≥ra</span></div>
                <div class="progress green"><span id="barSleep"></span></div>
                <div style="margin-top:8px;"><button class="pill ghost tiny" id="btnAddSleep" type="button">+1 √ìra</button></div>
              </div>

              <div>
                <div class="progress-label" style="margin-top:0;"><span>Heti check-in</span><span id="checkinLabel">0/1</span></div>
                <div class="progress"><span id="barCheckin"></span></div>
                <div style="margin-top:8px;">
                  <button class="pill primary tiny" id="btnDoCheckin" type="button">‚úÖ Check-in k√©sz</button>
                  <button class="pill ghost tiny" id="btnResetTrackers" type="button">‚Ü∫ Null√°z√°s</button>
                </div>
              </div>

              <div style="margin-top:8px; padding:14px; background:rgba(255,79,216,.08); border-left:4px solid var(--pink); border-radius:12px;">
                <strong id="motivationTitle" style="color:#fff; display:block; margin-bottom:6px; font-size:14px;">‚Äî</strong>
                <span id="motivationBox" style="color:rgba(255,255,255,.8); font-size:13.5px; line-height:1.5;">‚Äî</span>
              </div>

            </div>
          </section>
        </div>
      </div>

      <section id="technika" class="glass card" style="margin-top:14px;">
        <h3>Technika Vault</h3>
        <p class="sub">Hamarosan √©rkeznek a technika vide√≥k!</p>
        <ul class="list" id="techList"></ul>
      </section>
    </div>
  </main>

  <footer>
    <div class="container footer-inner">
      <div>¬© <span id="y"></span> Fitness Lady</div>
      <div>T√ºske web design</div>
    </div>
  </footer>

  <div class="modal-overlay" id="settingsOverlay">
    <div class="glass modal">
      <div class="modal-header">
        <h2 class="modal-title" id="settingsTitle">Be√°ll√≠t√°sok</h2>
        <button class="modal-close" id="settingsClose" type="button">‚úï</button>
      </div>
      <div class="modal-body">
        <p style="color:rgba(255,255,255,.6); font-size:13px;">A csomagodat √©s id≈ëtartamot az Admin kezeli.</p>
        <div class="field"><label>C√©l</label><input id="setGoal" type="text" /></div>
        <div class="field"><label>Szint (1‚Äì4)</label><input id="setLevel" type="number" min="1" max="4" /></div>
        <div class="field"><label>Nyelv (hu / de)</label><input id="setLang" type="text" /></div>
        <div style="margin-top:14px;"><button class="pill primary" id="btnSaveSettings" type="button">Ment√©s</button></div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="infoOverlay">
    <div class="glass modal">
      <div class="modal-header">
        <h2 class="modal-title" id="infoTitle">Info</h2>
        <button class="modal-close" id="infoClose" type="button">‚úï</button>
      </div>
      <div class="modal-body" id="infoBody"></div>
    </div>
  </div>

  <script type="module">
    import {
      BASE_PREFIX, auth, db, fs,
      onAuth, logout, toLogin,
      escapeHtml, safeJsonParse, todayISO, clamp, daysBetween
    } from "../shared/firebase.js";

    const homeLink = document.getElementById("homeLink");
    if (homeLink) homeLink.href = `${BASE_PREFIX}/hu/`;

    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    // Modals
    const settingsOverlay = $("#settingsOverlay");
    const infoOverlay = $("#infoOverlay");
    const infoBody = $("#infoBody");
    const infoTitle = $("#infoTitle");

    function openOverlay(ov){ ov.classList.add("is-open"); }
    function closeOverlay(ov){ ov.classList.remove("is-open"); }
    function openInfo(title, html){
      infoTitle.textContent = title;
      infoBody.innerHTML = html;
      openOverlay(infoOverlay);
    }
    $("#settingsClose").addEventListener("click", ()=>closeOverlay(settingsOverlay));
    $("#infoClose").addEventListener("click", ()=>{ closeOverlay(infoOverlay); infoBody.innerHTML = ""; });
    $("#btnOpenSettings").addEventListener("click", ()=>openOverlay(settingsOverlay));

    // LocalStorage helpers
    const k = (uid, key) => `fl_${uid}_${key}_v1`;
    const lsGet = (uid, key, fallback) => safeJsonParse(localStorage.getItem(k(uid,key)), fallback);
    const lsSet = (uid, key, value) => localStorage.setItem(k(uid,key), JSON.stringify(value));

    // √Ållapot (State)
    let UID = null;
    let profile = null;
    let planMeta = null;
    const weekCache = new Map();

    const state = {
      weekIdx: 0,
      selectedDay: "mon",
      done: {},
      checkin: null,
      water: 0,
      sleep: 0,
      lang: "hu"
    };

    const DAYS = [
      { id:"mon", name:"H√©" }, { id:"tue", name:"Ke" }, { id:"wed", name:"Sze" },
      { id:"thu", name:"Cs√º" }, { id:"fri", name:"P√©" }, { id:"sat", name:"Szo" }, { id:"sun", name:"Va" }
    ];

    // Adatbet√∂lt√©s
    async function loadUserProfile(uid){
      const snap = await fs.getDoc(fs.doc(db, "users", uid));
      return snap.exists() ? snap.data() : null;
    }
    async function loadPlanMeta(planId){
      const snap = await fs.getDoc(fs.doc(db, "planTemplates", planId));
      return snap.exists() ? snap.data() : {};
    }
    async function loadPlanWeek(planId, weekNo){
      const snap = await fs.getDoc(fs.doc(db, "planTemplates", planId, "weeks", String(weekNo)));
      return snap.exists() ? snap.data() : {};
    }
    async function loadOverridesWeek(uid, weekNo){
      const snap = await fs.getDoc(fs.doc(db, "users", uid, "overridesWeeks", String(weekNo)));
      return snap.exists() ? snap.data() : null;
    }

    function mergeWorkout(templateW, ovW){
      const w = { ...templateW };
      if(ovW?.vimeoId) w.vimeoId = ovW.vimeoId;
      w._title = ovW?.title || templateW?.title || "‚Äî";
      w._desc = ovW?.desc || templateW?.desc || "";
      return w;
    }
    function mergeSlot(templateS, ovS){
      const s = { ...templateS };
      s.vimeoId = ovS?.vimeoId || templateS?.defaultVimeoId || "";
      s._title = templateS?.title || "‚Äî";
      s._desc = templateS?.desc || "";
      s._note = ovS?.note || templateS?.defaultNote || "‚Äî";
      return s;
    }

    function calcWeekIndex(p){
      if(p?.lifetimeAccess || !p?.cycleStart || !p?.cycleEnd) return 0;
      const totalDays = Math.max(1, daysBetween(p.cycleStart, p.cycleEnd));
      const passedDays = clamp(daysBetween(p.cycleStart, todayISO()), 0, totalDays);
      const weeks = planMeta?.weeks ?? 4;
      const week = clamp(Math.floor((passedDays / totalDays) * weeks) + 1, 1, weeks);
      return week - 1;
    }

    // UI Friss√≠t≈ë met√≥dusok
    function renderHeader(){
      const p = profile;
      $("#chipPackage").textContent = `Csomag: ${planMeta?.name?.hu || p.planId || "‚Äî"}`;
      $("#pillGoal").textContent = `üéØ C√©l: ${p.goal || "‚Äî"}`;
      $("#pillIntensity").textContent = `‚ö° Szint: ${p.level ? `${p.level}/4` : "‚Äî"}`;

      if(p.lifetimeAccess || !p.cycleStart || !p.cycleEnd){
        $("#lblWeek").textContent = `H√©t: ${state.weekIdx + 1}/${planMeta?.weeks || 4}`;
        $("#lblDays").textContent = `Akt√≠v (V√©gtelen)`;
        $("#barCycle").style.width = `100%`;
        $("#subStatus").textContent = `V√°laszd ki a hetet az edz√©sekhez!`;
      } else {
        const tDays = Math.max(1, daysBetween(p.cycleStart, p.cycleEnd));
        const pDays = clamp(daysBetween(p.cycleStart, todayISO()), 0, tDays);
        $("#lblWeek").textContent = `H√©t: ${state.weekIdx + 1}/${planMeta?.weeks || 4}`;
        $("#lblDays").textContent = `H√°tra: ${tDays - pDays} nap`;
        $("#barCycle").style.width = `${Math.round((pDays / tDays) * 100)}%`;
      }
    }

    function renderTrackers(){
      // V√≠z
      $("#lblWater").textContent = `${state.water}/8 poh√°r`;
      $("#barWater").style.width = `${clamp((state.water/8)*100, 0, 100)}%`;
      
      // Alv√°s
      $("#lblSleep").textContent = `${state.sleep}/8 √≥ra`;
      $("#barSleep").style.width = `${clamp((state.sleep/8)*100, 0, 100)}%`;

      // Check-in
      const done = state.checkin?.done ? 1 : 0;
      $("#checkinLabel").textContent = `${done}/1`;
      $("#barCheckin").style.width = `${done*100}%`;
    }

    function renderDiet(){
      const weekKey = `w${state.weekIdx + 1}`;
      const dietDaysContainer = $("#dietDays");
      dietDaysContainer.innerHTML = "";

      DAYS.forEach(d => {
        const btn = document.createElement("button");
        btn.className = "tab" + (state.selectedDay === d.id ? " is-active" : "");
        btn.textContent = d.name;
        btn.onclick = () => {
          state.selectedDay = d.id;
          renderDiet(); 
        };
        dietDaysContainer.appendChild(btn);
      });

      const dayPlan = profile?.dietPlan?.[weekKey]?.[state.selectedDay] || {};
      const meals = [
        { label:"Reggeli", val: dayPlan.breakfast },
        { label:"T√≠z√≥rai", val: dayPlan.snack1 },
        { label:"Eb√©d", val: dayPlan.lunch },
        { label:"Uzsonna", val: dayPlan.snack2 },
        { label:"Vacsora", val: dayPlan.dinner }
      ];

      const html = meals.map(m => {
        if(!m.val) return `<div class="row" style="opacity:0.4;"><div><div class="title">${m.label}</div><div class="desc">Nincs adat</div></div></div>`;
        return `<div class="row"><div><div class="title">${m.label}</div><div class="desc">${escapeHtml(m.val)}</div></div></div>`;
      }).join("");

      $("#dietDetails").innerHTML = html;
    }

    function renderMotivation(){
      const mc = profile?.motivationCard;
      $("#motivationTitle").textContent = mc?.title || "A rendszer szabads√°g.";
      $("#motivationBox").textContent = mc?.text || "Nem kell t√∂k√©letesnek lenned. El√©g, ha k√∂vetkezetes vagy.";
    }

    // ‚úÖ JAV√çT√ÅS: Nem fagy ki a bet√∂lt√©s √ºres csomag eset√©n
    async function ensureWeekLoaded(weekNo){
      if(weekCache.has(weekNo)) return weekCache.get(weekNo);
      
      const pId = profile?.planId || "start_v1"; 
      const templateWeek = await loadPlanWeek(pId, weekNo);
      
      const overridesWeek = await loadOverridesWeek(UID, weekNo);
      const ovWorkouts = overridesWeek?.workouts || {};
      const ovSlots = overridesWeek?.slots || {};

      const merged = {
        weekNo,
        workouts: (templateWeek.workouts || []).map(w => mergeWorkout(w, ovWorkouts[w.id])),
        slots: (templateWeek.slots || []).map(s => mergeSlot(s, ovSlots[String(s.slotIndex)]))
      };
      weekCache.set(weekNo, { merged });
      return weekCache.get(weekNo);
    }

    function renderProgram(){
      const weeks = planMeta?.weeks || 4;
      const tabs = $("#weekTabs");
      tabs.innerHTML = "";
      for(let i=0;i<weeks;i++){
        const b = document.createElement("button");
        b.className = "tab" + (i===state.weekIdx ? " is-active" : "");
        b.textContent = `H√©t ${i+1}`;
        b.addEventListener("click", async ()=>{
          state.weekIdx = i;
          await ensureWeekLoaded(i+1);
          renderProgram();
          renderDiet(); 
          renderHeader();
        });
        tabs.appendChild(b);
      }

      const weekNo = state.weekIdx + 1;
      const pack = weekCache.get(weekNo);
      if(!pack) return;

      const ul = $("#workoutList");
      ul.innerHTML = "";
      pack.merged.workouts.forEach(w=>{
        const key = `w${weekNo}_${w.id}`;
        const done = !!state.done[key];
        ul.innerHTML += `
          <li class="row">
            <div>
              <div class="title">${escapeHtml(w._title)} ${done ? '‚úÖ' : ''}</div>
              <div class="desc">${escapeHtml(w._desc)}</div>
            </div>
            <div class="actions">
              <button class="pill ghost tiny" data-play="${escapeHtml(w.vimeoId || "")}">‚ñ∂</button>
              <button class="pill ${done ? 'danger' : 'primary'} tiny" data-toggle-done="${escapeHtml(key)}">${done?'Visszavon':'K√©sz'}</button>
            </div>
          </li>`;
      });

      const sl = $("#slotList");
      sl.innerHTML = "";
      pack.merged.slots.forEach(s=>{
        sl.innerHTML += `
          <li class="row">
            <div>
              <div class="title">${escapeHtml(s._title)}</div>
              <div class="desc">${escapeHtml(s._desc)}<br><span style="color:#aaa;">Jegyzet: ${escapeHtml(s._note)}</span></div>
            </div>
            <div class="actions">
              <button class="pill ghost tiny" data-play="${escapeHtml(s.vimeoId || "")}">‚ñ∂</button>
            </div>
          </li>`;
      });

      $$("[data-play]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const vId = b.getAttribute("data-play");
          if(!vId) return openInfo("Info", "Ehhez m√©g nincs vide√≥ be√°ll√≠tva.");
          const src = `https://player.vimeo.com/video/${encodeURIComponent(vId)}`;
          openInfo("Lej√°tsz√°s", `<iframe src="${src}" width="100%" height="400" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>`);
        });
      });

      $$("[data-toggle-done]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const key = b.getAttribute("data-toggle-done");
          state.done[key] = !state.done[key];
          lsSet(UID, "done", state.done);
          renderProgram();
        });
      });
    }

    // --- ESEM√âNYKEZEL≈êK ---
    $("#btnLogout").addEventListener("click", async ()=>{
      await logout();
      toLogin(state.lang);
    });

    $("#btnResetWeek").addEventListener("click", ()=>{
      const weekNo = state.weekIdx + 1;
      Object.keys(state.done).forEach(k => {
        if(k.startsWith(`w${weekNo}_`)) delete state.done[k];
      });
      lsSet(UID, "done", state.done);
      renderProgram();
    });

    // Trackerek gombjai
    $("#btnAddWater").addEventListener("click", ()=>{
      state.water = Math.min(8, state.water + 1);
      lsSet(UID, "water", state.water);
      renderTrackers();
    });
    $("#btnAddSleep").addEventListener("click", ()=>{
      state.sleep = Math.min(8, state.sleep + 1);
      lsSet(UID, "sleep", state.sleep);
      renderTrackers();
    });
    $("#btnDoCheckin").addEventListener("click", ()=>{
      state.checkin = { done: true, at: new Date().toISOString() };
      lsSet(UID, "checkin", state.checkin);
      renderTrackers();
    });
    $("#btnResetTrackers").addEventListener("click", ()=>{
      state.water = 0; state.sleep = 0; state.checkin = null;
      lsSet(UID, "water", 0); lsSet(UID, "sleep", 0); lsSet(UID, "checkin", null);
      renderTrackers();
    });

    // --- ALKALMAZ√ÅS IND√çT√ÅSA ---
    onAuth(async (user)=>{
      if(!user) return toLogin("hu");
      UID = user.uid;

      // Helyi ment√©sek bet√∂lt√©se
      state.done = lsGet(UID, "done", {});
      state.checkin = lsGet(UID, "checkin", null);
      state.water = lsGet(UID, "water", 0);
      state.sleep = lsGet(UID, "sleep", 0);
      
      profile = await loadUserProfile(UID) || {};
      planMeta = await loadPlanMeta(profile.planId || "start_v1");
      state.weekIdx = calcWeekIndex(profile);

      // Jelenlegi h√©t adatainak let√∂lt√©se
      await ensureWeekLoaded(state.weekIdx + 1);

      // UI friss√≠t√©se
      renderHeader();
      renderTrackers();
      renderProgram();
      renderDiet();
      renderMotivation();

      document.getElementById("y").textContent = new Date().getFullYear();
    });
  </script>
</body>
</html>
