<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fitness Lady — Saját programom</title>
  <style>
    :root{ --bg:#07060b; --text:rgba(255,255,255,.92); --muted:rgba(255,255,255,.70); --pink:#ff4fd8; --pink2:#b14cff; --radius:22px; --max:1180px; }
    *{ box-sizing:border-box; }
    html,body{ height:100%; scroll-behavior:smooth; }
    body{ margin:0; font-family:ui-sans-serif,system-ui,sans-serif; color:var(--text); background:radial-gradient(1200px 700px at 20% 10%, rgba(255,79,216,.10), transparent 60%), var(--bg); background-attachment:fixed; }
    .container{ width:min(var(--max), 92vw); margin:0 auto; padding-top:80px; }
    .topbar{ position:fixed; top:0; left:0; right:0; z-index:50; background:rgba(8,6,12,.75); border-bottom:1px solid rgba(255,255,255,.06); backdrop-filter:blur(12px); }
    .topbar-inner{ height:64px; display:flex; align-items:center; justify-content:space-between; padding:0 4%; }
    .glass{ background:rgba(18,12,26,0.55); border:1px solid rgba(255,255,255,0.08); border-radius:22px; padding:18px; margin-bottom:14px; backdrop-filter:blur(10px); }
    h2{ font-family:serif; font-size:26px; margin:0 0 10px; }
    .meal-card{ padding:16px; background:rgba(0,0,0,0.2); border-radius:18px; border:1px solid rgba(255,255,255,0.05); margin-bottom:12px; }
    .label{ font-size:11px; font-weight:900; color:var(--pink); text-transform:uppercase; letter-spacing:1px; margin-bottom:6px; }
    .list{ margin:0; padding:0; list-style:none; }
    .row{ display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; padding:12px; border-radius:16px; background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,0.06); margin-bottom:10px; }
    .row .title{ font-weight:800; font-size:14px; }
    .row .desc{ color:rgba(255,255,255,.65); font-size:12.5px; margin-top:4px; }
    .pill{ padding:8px 14px; border-radius:999px; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.1); color:#fff; cursor:pointer; font-size:12px; font-weight:800; }
    .pill.primary{ background:linear-gradient(135deg, var(--pink), var(--pink2)); color:#140813; border:none; }
    .pill.danger{ background:rgba(255,255,255,0.15); }
    .tabs{ display:flex; flex-wrap:wrap; gap:8px; margin-bottom:15px; }
    .progress{ background:rgba(0,0,0,.4); border-radius:999px; height:10px; overflow:hidden; margin:5px 0; }
    .progress span{ display:block; height:100%; background:var(--pink); width:0; transition:width 0.3s; }
    .modal-overlay{ position:fixed; inset:0; z-index:80; background:rgba(0,0,0,.7); backdrop-filter:blur(8px); display:none; align-items:center; justify-content:center; padding:18px; }
    .modal-overlay.is-open{ display:flex; }
    .modal{ width:min(980px, 94vw); border-radius:22px; overflow:hidden; background:#0a080f; position:relative; }
    .modal-header{ display:flex; justify-content:space-between; padding:14px 18px; border-bottom:1px solid rgba(255,255,255,.08); }
  </style>
</head>
<body>
  <header class="topbar"><div class="topbar-inner"><div style="font-weight:800;">Fitness Lady</div><button class="pill" id="btnLogout">Kilépés</button></div></header>
  <main class="container">
    <section class="glass"><h2 id="greetingHeader">Szia!</h2><div id="subStatus">Program aktív</div></section>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:14px;">
      <section class="glass">
        <div id="intro-container"></div>
        <h3>Heti edzések</h3>
        <div class="tabs" id="weekTabs"></div>
        <ul class="list" id="workoutList"></ul>
        <hr style="opacity:.1; margin:20px 0;">
        <h3>Személyre szabás</h3>
        <ul class="list" id="slotList"></ul>
      </section>
      <section class="glass">
        <h3>Napi Étrend</h3>
        <div class="tabs" id="dietDays"></div>
        <div id="dietDetails"></div>
        <hr style="opacity:.1; margin:15px 0;">
        <h3>Célok</h3>
        <div style="margin-bottom:15px;">Víz <div class="progress"><span id="waterBar"></span></div><button class="pill" id="addWater">+1 Pohár</button></div>
        <div style="padding:16px; background:rgba(255,79,216,.1); border-radius:18px;"><strong id="motTitle"></strong><p id="motBox" style="font-size:13px; line-height:1.6;"></p></div>
      </section>
    </div>
    <section class="glass"><h3>Technika Vault</h3><ul class="list" id="techList"></ul></section>
  </main>
  <div class="modal-overlay" id="infoOverlay"><div class="modal"><div class="modal-header"><h3 id="infoTitle"></h3><button class="pill" onclick="$('#infoOverlay').classList.remove('is-open')">✕</button></div><div id="infoBody"></div></div></div>
  <script type="module">
    import { db, fs, onAuth, logout, toLogin, escapeHtml, safeJsonParse } from "../shared/firebase.js";
    const $ = s => document.querySelector(s);
    let UID = null; let profile = null; let planMeta = null; let weekData = null;
    const state = { weekIdx: 0, selectedDay: "mon", water: 0, done: {} };
    const DAYS = [{id:"mon",name:"Hé"},{id:"tue",name:"Ke"},{id:"wed",name:"Sze"},{id:"thu",name:"Cs"},{id:"fri",name:"Pé"},{id:"sat",name:"Szo"},{id:"sun",name:"Va"}];

    window.playVideo = (id, title="Edzés") => {
      $("#infoTitle").textContent = title;
      $("#infoBody").innerHTML = `<iframe src="https://player.vimeo.com/video/${id}" width="100%" height="450" frameborder="0" allowfullscreen></iframe>`;
      $("#infoOverlay").classList.add("is-open");
    };

    function getAiGreeting(name){ const h = new Date().getHours(); const n = name ? `, ${name}` : ""; if(h<10) return `Jó reggelt${n}!`; if(h<18) return `Szia${n}!`; return `Szép estét${n}!`; }

    async function renderProgram(){
      const weekNo = state.weekIdx + 1;
      const snap = await fs.getDoc(fs.doc(db, "planTemplates", profile.planId || "start_v1", "weeks", String(weekNo)));
      weekData = snap.data() || { workouts: [] };
      
      const ul = $("#workoutList"); ul.innerHTML = "";
      (weekData.workouts || []).forEach(w => {
        const key = `w${weekNo}_${w.id}`; const done = !!state.done[key];
        ul.innerHTML += `<li class="row"><div><div class="title">${w.title.hu} ${done?'✅':''}</div></div><div style="display:flex; gap:8px;"><button class="pill ghost" onclick="playVideo('${w.vimeoId}', '${w.title.hu}')">▶</button><button class="pill ${done?'danger':'primary'}" onclick="window.toggleDone('${key}')">${done?'Vissza':'Kész'}</button></div></li>`;
      });

      const oSnap = await fs.getDoc(fs.doc(db, "users", UID, "overridesWeeks", String(weekNo)));
      const slots = oSnap.data()?.slots || {};
      const sl = $("#slotList"); sl.innerHTML = "";
      Object.keys(slots).forEach(k => {
        sl.innerHTML += `<li class="row"><div><div class="title">${k}. Személyes feladat</div><div class="desc">${slots[k].note?.hu || ""}</div></div><button class="pill ghost" onclick="playVideo('${slots[k].vimeoId}', 'Személyes feladat')">▶</button></li>`;
      });
    }

    window.toggleDone = (key) => { state.done[key] = !state.done[key]; localStorage.setItem(`fl_${UID}_done`, JSON.stringify(state.done)); renderProgram(); };

    function renderDiet(){
      const day = profile?.dietPlan?.[`w${state.weekIdx+1}`]?.[state.selectedDay] || {};
      $("#dietDetails").innerHTML = `<div class="meal-card"><div class="label">REGGELI</div><div>${day.breakfast || "Nincs megadva"}</div></div><div class="meal-card"><div class="label">EBÉD</div><div>${day.lunch || "Nincs megadva"}</div></div><div class="meal-card"><div class="label">VACSORA</div><div>${day.dinner || "Nincs megadva"}</div></div>`;
      $("#dietDays").innerHTML = DAYS.map(d => `<button class="pill ${state.selectedDay===d.id?'primary':''}" onclick="window.setDay('${d.id}')">${d.name}</button>`).join(" ");
    }
    window.setDay = (id) => { state.selectedDay=id; renderDiet(); };

    onAuth(async u => {
      if(!u) return toLogin("hu"); UID = u.uid;
      state.done = JSON.parse(localStorage.getItem(`fl_${UID}_done`) || "{}");
      state.water = parseInt(localStorage.getItem(`fl_${UID}_water`) || "0");
      const snap = await fs.getDoc(fs.doc(db, "users", UID)); profile = snap.data() || {};
      const mSnap = await fs.getDoc(fs.doc(db, "planTemplates", profile.planId || "start_v1")); planMeta = mSnap.data() || {};
      
      $("#greetingHeader").textContent = getAiGreeting(profile.firstName);
      $("#motTitle").textContent = profile.motivationCard?.title || "A rendszer szabadság.";
      $("#motBox").textContent = profile.motivationCard?.text || "";
      $("#waterBar").style.width = (state.water/8*100)+"%";
      
      $("#weekTabs").innerHTML = ""; for(let i=0; i<4; i++){ $("#weekTabs").innerHTML += `<button class="pill ${state.weekIdx===i?'primary':''}" onclick="window.setWeek(${i})">${i+1}. hét</button> `; }
      
      renderProgram(); renderDiet();
      if(state.weekIdx===0 && planMeta.introVideo) $("#intro-container").innerHTML = `<div class="box" style="background:rgba(255,211,138,.1); padding:15px; border-radius:18px; margin-bottom:15px;"><h3>Ismerj meg</h3><button class="pill primary" onclick="playVideo('${planMeta.introVideo}', 'Bemutatkozás')">Videó indítása</button></div>`;
      const vSnap = await fs.getDoc(fs.doc(db, "settings", "vault"));
      $("#techList").innerHTML = (vSnap.data()?.items || []).map(v => `<li class="row" onclick="window.openText('${escapeHtml(v.title)}','${escapeHtml(v.desc)}')"><div class="title">${v.title}</div><button class="pill ghost tiny">Megnyitás</button></li>`).join("");
    });

    window.setWeek = (i) => { state.weekIdx = i; renderProgram(); renderDiet(); };
    window.openText = (t,d) => { $("#infoTitle").textContent=t; $("#infoBody").innerHTML=`<div style="padding:20px; white-space:pre-wrap;">${d}</div>`; $("#infoOverlay").classList.add("is-open"); };
    $("#addWater").onclick = () => { state.water = Math.min(8, state.water+1); localStorage.setItem(`fl_${UID}_water`, state.water); $("#waterBar").style.width = (state.water/8*100)+"%"; };
    $("#btnLogout").onclick = async () => { await logout(); toLogin("hu"); };
  </script>
</body>
</html>
