<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fitness Lady ‚Äî Saj√°t programom</title>
  <meta name="description" content="Fitness Lady ‚Äî Saj√°t programom: csomag, heti edz√©sek, szem√©lyre szab√°s, √©trend, check-in." />

  <style>
    :root{
      --bg:#07060b;
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --pink:#ff4fd8;
      --pink2:#b14cff;
      --gold:#ffd38a;
      --radius:22px;
      --shadow: 0 18px 55px rgba(0,0,0,.55);
      --max: 1180px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    html{ scroll-behavior:smooth; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background-color: var(--bg);
      overflow-x:hidden;
    }
    
    /* ‚úÖ G√ñRGET√âS OPTIMALIZ√ÅL√ÅS: K√ºl√∂n r√©teg a bonyolult h√°tt√©rnek */
    .bg-fx {
      position: fixed;
      inset: 0;
      z-index: -1;
      background:
        radial-gradient(1200px 700px at 30% 10%, rgba(255,79,216,.16), transparent 60%),
        radial-gradient(1000px 700px at 75% 20%, rgba(177,76,255,.14), transparent 60%),
        radial-gradient(1000px 700px at 60% 90%, rgba(255,211,138,.06), transparent 55%);
      will-change: transform;
      transform: translateZ(0);
      pointer-events: none;
    }

    a{ color:inherit; text-decoration:none; }
    button{ font:inherit; }
    .container{ width: min(var(--max), 92vw); margin: 0 auto; }

    .topbar{
      position: fixed; top:0; left:0; right:0; z-index: 50;
      background: rgba(8,6,12,.65);
      border-bottom: 1px solid rgba(255,255,255,.06);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .topbar-inner{
      height: 64px; display:flex; align-items:center; justify-content: space-between; gap: 12px;
    }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px; white-space: nowrap; }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, #ffd0f6, var(--pink));
      box-shadow: 0 0 18px rgba(255,79,216,.7);
    }
    .nav{ display:flex; align-items:center; gap: 14px; color: var(--muted); font-size: 13.5px; font-weight: 700; }
    .nav a{ position: relative; padding: 10px 6px; opacity:.92; }
    .nav a:hover, .nav a.is-active{ opacity:1; color: var(--text); }

    .pill{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 9px 12px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(20,12,26,.65);
      color: var(--text); font-size: 13.5px;
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
      cursor:pointer; transition: transform .18s ease, border-color .18s ease;
      white-space: nowrap; gap:8px;
    }
    .pill:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.20); }
    .pill.primary{
      background: linear-gradient(135deg, var(--pink), var(--pink2));
      color:#140813; border-color: rgba(255,255,255,.18); font-weight: 900;
    }
    .pill.ghost{ background: rgba(255,255,255,.06); }
    .pill.danger{ background: rgba(255,255,255,.06); border-color: rgba(255,91,107,.4); color:#ff5b6b; }

    .menu-btn{
      width: 40px; height: 40px; border-radius: 999px; background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10); color: var(--text);
      display:none; align-items:center; justify-content:center; cursor:pointer;
    }

    main{ padding-top: 64px; min-height: 100vh; }
    .page{ padding: 18px 0 64px; }

    /* ‚úÖ √úveghat√°s optimaliz√°l√°sa (gyorsabb g√∂rget√©s) */
    .glass{
      background: linear-gradient(180deg, rgba(30,20,40,.65), rgba(20,10,30,.45));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 22px;
      box-shadow: 0 12px 40px rgba(0,0,0,.45);
      backdrop-filter: blur(10px); 
      -webkit-backdrop-filter: blur(10px);
    }
    
    .grid{ display:grid; grid-template-columns: 1.2fr .8fr; gap: 14px; align-items:start; }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .nav{ display:none; }
      .menu-btn{ display:inline-flex; }
    }

    .card{ padding: 18px; }
    .card h2, .card h3{ margin:0 0 8px; font-family: ui-serif, Georgia, serif; letter-spacing: -.2px; }
    .card h2{ font-size: 22px; }
    .card h3{ font-size: 18px; }
    .sub{ margin:0 0 12px; color: var(--muted); line-height: 1.55; font-size: 13.5px; }

    .meta-row{ display:flex; flex-wrap:wrap; gap: 10px; margin-top: 10px; font-size: 12.8px; color: var(--muted); }
    .meta-pill{
      display:inline-flex; align-items:center; gap:8px; padding: 7px 12px;
      border-radius: 999px; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.10);
    }

    .progress{
      background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.10);
      border-radius: 999px; height: 12px; overflow:hidden; position:relative;
    }
    .progress > span{
      display:block; height:100%; width: 0%;
      background: linear-gradient(90deg, rgba(255,79,216,.95), rgba(177,76,255,.90));
      border-radius: 999px; transition: width .35s ease;
    }
    .progress-label{ display:flex; justify-content: space-between; gap: 10px; font-size: 12.5px; color: var(--muted); margin: 10px 0 6px; }

    .tabs{ display:flex; flex-wrap:wrap; gap: 8px; margin: 8px 0 14px; }
    .tab{
      padding: 8px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06); color: var(--text); cursor:pointer; font-size: 13px; font-weight: 800;
    }
    .tab.is-active{ background: linear-gradient(135deg, var(--pink), var(--pink2)); color:#140813; border-color: rgba(255,255,255,.18); }

    .list{ margin:0; padding:0; list-style:none; display:grid; gap:10px; }
    .row{
      display:grid; grid-template-columns: 1fr auto; gap: 10px; align-items:center;
      padding: 12px; border-radius: 18px; background: rgba(0,0,0,.25); border: 1px solid rgba(255,255,255,.08);
    }
    .row .title{ font-weight: 900; font-size: 14px; }
    .row .desc{ color: var(--muted); font-size: 13px; margin-top: 4px; line-height: 1.45; }
    .row .actions{ display:flex; gap: 8px; justify-content:flex-end; flex-wrap:wrap; }

    .chip{ display:inline-flex; align-items:center; padding: 4px 8px; border-radius: 999px; background: rgba(46,229,157,.15); color: #2ee59d; font-size: 11px; font-weight: 800; border: 1px solid rgba(46,229,157,.3); }

    /* Diet UI */
    .diet-select{
      width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.15);
      background: rgba(0,0,0,.4); color: white; font-size: 14px; margin-bottom: 12px; outline: none;
    }
    .meal-box{
      background: rgba(255,255,255,.03); border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px; padding: 10px 12px; margin-bottom: 8px;
    }
    .meal-box strong{ display:block; color: var(--gold); font-size: 12.5px; margin-bottom: 4px; text-transform: uppercase; letter-spacing: .5px; }
    .meal-box p{ margin:0; font-size: 13.5px; line-height: 1.5; color: rgba(255,255,255,.85); white-space: pre-wrap; }

    section{ scroll-margin-top: 82px; }

    /* Modal */
    .modal-overlay{
      position: fixed; inset: 0; z-index: 80; background: rgba(0,0,0,.7);
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      display: none; align-items: center; justify-content: center; padding: 18px;
    }
    .modal-overlay.is-open{ display:flex; }
    .modal{ width: min(800px, 94vw); max-height: min(82vh, 760px); border-radius: 22px; overflow: hidden; position: relative; background: #0c0812; border: 1px solid rgba(255,255,255,.1); box-shadow: 0 20px 60px rgba(0,0,0,.8); }
    .modal-header{ display:flex; align-items:center; justify-content: space-between; padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,.08); background: rgba(255,255,255,.03); }
    .modal-title{ margin:0; font-family: ui-serif, Georgia, serif; font-size: 20px; }
    .modal-close{ width: 36px; height: 36px; border-radius: 999px; border: 1px solid rgba(255,255,255,.15); background: transparent; color: white; cursor: pointer; display:flex; align-items:center; justify-content:center; }
    .modal-body{ padding: 16px; overflow: auto; max-height: calc(min(82vh, 760px) - 64px); }

    footer{ padding: 18px 0 46px; border-top:1px solid rgba(255,255,255,.05); text-align: center; color:var(--muted); font-size:13px; }
  </style>
</head>

<body>
  <div class="bg-fx"></div>

  <header class="topbar">
    <div class="container topbar-inner">
      <a class="brand" id="homeLink" href="#" aria-label="F≈ëoldal">
        <span class="dot"></span><span>Fitness Lady</span>
      </a>

      <nav class="nav">
        <a href="#program" data-nav>Programom</a>
        <a href="#etrend" data-nav>√âtrend</a>
        <a href="#checkin" data-nav>Motiv√°ci√≥</a>
      </nav>

      <div style="display:flex; align-items:center; gap:10px;">
        <button class="menu-btn" id="menuBtn">‚ò∞</button>
        <button class="pill ghost" id="btnLogout" title="Kijelentkez√©s">‚éã Kil√©p√©s</button>
      </div>
    </div>
  </header>

  <main>
    <div class="container page">
      <section id="top" class="glass card" style="margin-bottom:14px;">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; gap:12px;">
          <div>
            <div class="meta-pill" id="chipPackage" style="color:var(--gold); border-color:rgba(255,211,138,.3)">Csomag: ‚Äî</div>
            <h2 style="margin-top:10px;" id="titleProgram">Saj√°t programom</h2>
            <p class="sub" id="subStatus">Bet√∂lt√©s‚Ä¶</p>
          </div>
        </div>

        <div class="progress-label">
          <span id="lblWeek">H√©t: ‚Äî</span>
          <span id="lblDays">St√°tusz: ‚Äî</span>
        </div>
        <div class="progress"><span id="barCycle"></span></div>

        <div class="meta-row">
          <div class="meta-pill" id="pillGoal">üéØ C√©l: ‚Äî</div>
          <div class="meta-pill" id="pillIntensity">‚ö° Szint: ‚Äî</div>
        </div>
      </section>

      <div class="grid">
        <section id="program" class="glass card">
          <h3>Heti edz√©sek</h3>
          <p class="sub">V√°laszd ki a hetet, √©s ind√≠tsd el a mai edz√©sedet!</p>

          <div class="tabs" id="weekTabs"></div>

          <ul class="list" id="workoutList"></ul>

          <hr style="border:none; height:1px; background:rgba(255,255,255,.08); margin: 18px 0;" />

          <h3>Szem√©lyre szabott feladatok</h3>
          <p class="sub">Ha az edz≈ëd (Edina) √≠rt el≈ë extr√°t, itt l√°tod.</p>
          <ul class="list" id="slotList"></ul>
        </section>

        <div style="display:grid; gap:14px; align-content:start;">
          
          <section id="etrend" class="glass card">
            <h3>Szem√©lyes √âtrended</h3>
            <p class="sub">A c√©lodhoz igaz√≠tva.</p>

            <select id="dietDaySelector" class="diet-select">
              <option value="mon">H√©tf≈ë</option>
              <option value="tue">Kedd</option>
              <option value="wed">Szerda</option>
              <option value="thu">Cs√ºt√∂rt√∂k</option>
              <option value="fri">P√©ntek</option>
              <option value="sat">Szombat</option>
              <option value="sun">Vas√°rnap</option>
            </select>

            <div id="dietContent">
               <p style="color:var(--muted); font-size:13px;">K√©rlek v√°rj, √©trend bet√∂lt√©se...</p>
            </div>
          </section>

          <section id="checkin" class="glass card">
            <h3 id="motTitle">Napi √úzenet</h3>
            <p class="sub" id="motDesc" style="color:var(--text); font-size:14px; font-style:italic;">...</p>
            
            <div style="margin-top:14px;">
                <div class="progress-label" style="margin:0;">
                  <span>Heti check-in (√∂nellen≈ërz√©s)</span>
                  <span id="checkinLabel">0/1</span>
                </div>
                <div class="progress" style="margin-bottom:10px;"><span id="barCheckin"></span></div>
                <button class="pill primary" id="btnDoCheckin" style="width:100%; justify-content:center;">Check-in K√©sz</button>
            </div>
          </section>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">¬© <span id="y"></span> Fitness Lady</div>
  </footer>

  <div class="modal-overlay" id="infoOverlay" role="dialog">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="infoTitle">Info</h2>
        <button class="modal-close" id="infoClose">‚úï</button>
      </div>
      <div class="modal-body" id="infoBody"></div>
    </div>
  </div>

  <script type="module">
    import {
      BASE_PREFIX, auth, db, fs,
      onAuth, logout, toLogin,
      escapeHtml, safeJsonParse, todayISO, clamp, fmtDate, daysBetween
    } from "../shared/firebase.js";

    const homeLink = document.getElementById("homeLink");
    if (homeLink) homeLink.href = `${BASE_PREFIX}/hu/`;

    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    // Modals
    const infoOverlay = $("#infoOverlay");
    const infoBody = $("#infoBody");
    const infoTitle = $("#infoTitle");

    function openInfo(title, html){
      infoTitle.textContent = title;
      infoBody.innerHTML = html;
      infoOverlay.classList.add("is-open");
    }
    $("#infoClose").addEventListener("click", ()=> infoOverlay.classList.remove("is-open"));
    infoOverlay.addEventListener("click",(e)=>{ if(e.target===infoOverlay) infoOverlay.classList.remove("is-open"); });

    // LocalStorage
    const k = (uid, key) => `fl_${uid}_${key}_v1`;
    const lsGet = (uid, key, fallback) => safeJsonParse(localStorage.getItem(k(uid,key)), fallback);
    const lsSet = (uid, key, value) => localStorage.setItem(k(uid,key), JSON.stringify(value));

    // Data Loaders
    async function loadUserProfile(uid){
      const ref = fs.doc(db, "users", uid);
      const snap = await fs.getDoc(ref);
      return snap.exists() ? snap.data() : null;
    }

    async function loadPlanMeta(planId){
      const ref = fs.doc(db, "planTemplates", planId);
      const snap = await fs.getDoc(ref);
      return snap.exists() ? snap.data() : { weeks: 4, name: "Program" };
    }

    async function loadPlanWeek(planId, weekNo){
      const ref = fs.doc(db, "planTemplates", planId, "weeks", String(weekNo));
      const snap = await fs.getDoc(ref);
      return snap.exists() ? snap.data() : { workouts: [], slots: [] };
    }

    // ‚úÖ JAV√çT√ÅS: overridesWeeks mapp√°ban keress√ºk!
    async function loadOverridesWeek(uid, weekNo){
      const ref = fs.doc(db, "users", uid, "overridesWeeks", String(weekNo));
      const snap = await fs.getDoc(ref);
      return snap.exists() ? snap.data() : null;
    }

    function mergeWorkout(templateW, ovW){
      const w = { ...templateW };
      if(ovW?.vimeoId) w.vimeoId = ovW.vimeoId;
      w._title = ovW?.title || templateW.title || "‚Äî";
      w._desc = ovW?.desc || templateW.desc || "";
      return w;
    }

    function mergeSlot(templateS, ovS){
      const s = { ...templateS };
      s.vimeoId = (ovS?.vimeoId) ? ovS.vimeoId : (templateS.defaultVimeoId || "");
      s._title = templateS.title || "‚Äî";
      s._desc = templateS.desc || "";
      s._note = ovS?.note || templateS.defaultNote || "‚Äî";
      return s;
    }

    let UID = null;
    let profile = null;
    let planMeta = null;
    const weekCache = new Map();

    const state = {
      weekIdx: 0,
      done: {},
      checkin: null
    };

    function workoutKey(weekNo, id){ return `w${weekNo}_${id}`; }

    function renderHeader(){
      const p = profile;
      $("#chipPackage").textContent = `Csomag: ${planMeta?.name?.hu || planMeta?.name || p.planId || "‚Äî"}`;
      $("#pillGoal").textContent = `üéØ C√©l: ${p.goal || "‚Äî"}`;
      $("#pillIntensity").textContent = `‚ö° Szint: ${p.level ? `${p.level}/4` : "‚Äî"}`;

      if(p.lifetimeAccess || !p.cycleStart || !p.cycleEnd){
        $("#lblWeek").textContent = `H√©t: ${state.weekIdx + 1}/${planMeta.weeks || 4}`;
        $("#lblDays").textContent = `St√°tusz: Akt√≠v`;
        $("#barCycle").style.width = `100%`;
        $("#subStatus").textContent = `√údv, ${p.email || "!"} ‚Ä¢ V√°laszd ki a hetet √©s kezdj bele!`;
      }else{
        const tD = Math.max(1, daysBetween(p.cycleStart, p.cycleEnd));
        const pD = clamp(daysBetween(p.cycleStart, todayISO()), 0, tD);
        $("#lblWeek").textContent = `H√©t: ${clamp(Math.floor((pD/tD)*(planMeta.weeks||4))+1, 1, planMeta.weeks||4)}/${planMeta.weeks||4}`;
        $("#lblDays").textContent = `H√°tral√©v≈ë napok: ${tD - pD}`;
        $("#barCycle").style.width = `${Math.round((pD/tD)*100)}%`;
        $("#subStatus").textContent = `Akt√≠v: ${fmtDate(p.cycleStart)} - ${fmtDate(p.cycleEnd)}`;
      }

      // ‚úÖ JAV√çT√ÅS: Motiv√°ci√≥ bet√∂lt√©se
      const mc = p.motivationCard;
      if(mc){
          $("#motTitle").textContent = mc.title || "Napi √úzenet";
          $("#motDesc").textContent = mc.text || "Folytasd a kem√©ny munk√°t!";
      } else {
          $("#motTitle").textContent = "C√©lod";
          $("#motDesc").textContent = p.goal || "√Åll√≠ts be egy c√©lt magadnak!";
      }

      const done = state.checkin?.done ? 1 : 0;
      $("#checkinLabel").textContent = `${done}/1`;
      $("#barCheckin").style.width = `${done*100}%`;
    }

    // ‚úÖ √öJ: √âtrend Megjelen√≠t≈ë
    function renderDiet(){
        const day = $("#dietDaySelector").value;
        const wKey = `w${state.weekIdx + 1}`;
        const dayPlan = profile?.dietPlan?.[wKey]?.[day];

        const container = $("#dietContent");
        
        if(!dayPlan || (!dayPlan.breakfast && !dayPlan.lunch && !dayPlan.dinner)){
            container.innerHTML = `<p style="color:var(--muted); font-size:13.5px;">Erre a napra nincs megadva k√ºl√∂n √©trend.</p>`;
            return;
        }

        let html = '';
        const meals = [
            { id: 'breakfast', label: 'Reggeli' },
            { id: 'snack1', label: 'T√≠z√≥rai' },
            { id: 'lunch', label: 'Eb√©d' },
            { id: 'snack2', label: 'Uzsonna' },
            { id: 'dinner', label: 'Vacsora' }
        ];

        meals.forEach(m => {
            if(dayPlan[m.id]){
                html += `
                <div class="meal-box">
                    <strong>${m.label}</strong>
                    <p>${escapeHtml(dayPlan[m.id])}</p>
                </div>`;
            }
        });

        container.innerHTML = html;
    }

    $("#dietDaySelector").addEventListener("change", renderDiet);

    function renderWeekTabs(){
      const weeks = planMeta.weeks || 4;
      const tabs = $("#weekTabs");
      tabs.innerHTML = "";
      for(let i=0;i<weeks;i++){
        const b = document.createElement("button");
        b.className = "tab" + (i===state.weekIdx ? " is-active" : "");
        b.textContent = `H√©t ${i+1}`;
        b.addEventListener("click", async ()=>{
          state.weekIdx = i;
          await ensureWeekLoaded(i+1);
          renderProgram();
          renderHeader();
          renderDiet(); // V√°lt√°skor friss√≠ti az √©trendet is!
        });
        tabs.appendChild(b);
      }
    }

    async function ensureWeekLoaded(weekNo){
      if(weekCache.has(weekNo)) return weekCache.get(weekNo);

      const templateWeek = await loadPlanWeek(profile.planId, weekNo);
      const overridesWeek = await loadOverridesWeek(UID, weekNo);

      const ovWorkouts = overridesWeek?.workouts || {};
      const ovSlots = overridesWeek?.slots || {};

      const merged = {
        weekNo,
        workouts: (templateWeek.workouts || []).map(w => mergeWorkout(w, ovWorkouts[w.id])),
        slots: (templateWeek.slots || []).map(s => mergeSlot(s, ovSlots[String(s.slotIndex)]))
      };

      weekCache.set(weekNo, merged);
      return merged;
    }

    function renderProgram(){
      renderWeekTabs();

      const weekNo = state.weekIdx + 1;
      const merged = weekCache.get(weekNo);
      
      const ul = $("#workoutList");
      ul.innerHTML = "";
      merged.workouts.forEach(w=>{
        const key = workoutKey(weekNo, w.id);
        const done = !!state.done[key];

        const li = document.createElement("li");
        li.className = "row";
        li.innerHTML = `
          <div>
            <div class="title">${escapeHtml(w._title)} ${done ? '<span class="chip" style="margin-left:6px;">‚úÖ K√©sz</span>' : ''}</div>
            <div class="desc">${escapeHtml(w._desc || "")}</div>
          </div>
          <div class="actions">
            <button class="pill ghost" type="button" data-play="${escapeHtml(w.vimeoId || "")}">‚ñ∂</button>
            <button class="pill ${done ? 'danger' : 'primary'}" type="button" data-toggle-done="${escapeHtml(key)}">${done ? 'Visszavon' : 'K√©sz'}</button>
          </div>
        `;
        ul.appendChild(li);
      });

      const sl = $("#slotList");
      sl.innerHTML = "";
      if(merged.slots.length === 0){
          sl.innerHTML = `<li class="row"><div><div class="desc">Nincs megadva extra feladat erre a h√©tre.</div></div></li>`;
      } else {
          merged.slots.forEach((s)=>{
            const li = document.createElement("li");
            li.className = "row";
            li.innerHTML = `
              <div>
                <div class="title">${escapeHtml(s._title)}</div>
                <div class="desc">${escapeHtml(s._desc)}<br><span style="color:var(--gold);">Megjegyz√©s/Feladat: ${escapeHtml(s._note)}</span></div>
              </div>
              <div class="actions">
                <button class="pill ghost" type="button" data-play="${escapeHtml(s.vimeoId || "")}">‚ñ∂</button>
              </div>
            `;
            sl.appendChild(li);
          });
      }

      // Vimeo lej√°tsz√≥ esem√©ny
      $$("[data-play]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const vimeoId = b.getAttribute("data-play");
          if(!vimeoId){
            openInfo("Vide√≥", `<p style="color:var(--muted)">Ehhez az edz√©shez nincs vide√≥ csatolva.</p>`);
            return;
          }
          const src = `https://player.vimeo.com/video/${encodeURIComponent(vimeoId)}`;
          openInfo("Lej√°tsz√°s", `
            <div style="border-radius:14px; overflow:hidden; background:#000;">
              <iframe src="${src}" width="100%" height="480" frameborder="0" allow="autoplay; fullscreen" allowfullscreen style="display:block"></iframe>
            </div>
          `);
        });
      });

      // Pip√°l√°s esem√©ny
      $$("[data-toggle-done]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const key = b.getAttribute("data-toggle-done");
          state.done[key] = !state.done[key];
          lsSet(UID, "done", state.done);
          renderProgram();
        });
      });
    }

    $("#btnDoCheckin").addEventListener("click", ()=>{
      state.checkin = { done: true, at: new Date().toISOString() };
      lsSet(UID, "checkin", state.checkin);
      renderHeader();
      openInfo("Check-in", `<p style="color:var(--muted)">Check-in elmentve! √úgyes vagy!</p>`);
    });

    $("#btnLogout").addEventListener("click", async ()=>{
      await logout();
      toLogin("hu");
    });

    $("#y").textContent = new Date().getFullYear();

    // Init
    onAuth(async (user)=>{
      try{
        if(!user){ toLogin("hu"); return; }
        UID = user.uid;

        state.done = lsGet(UID, "done", {});
        state.checkin = lsGet(UID, "checkin", null);

        profile = await loadUserProfile(UID);
        if(!profile){
            openInfo("Hiba", "<p>Nem tal√°lhat√≥ profil. K√©rlek √≠rj az adminnak!</p>");
            return;
        }

        planMeta = await loadPlanMeta(profile.planId);
        
        // Setup initial week (1. h√©t)
        state.weekIdx = 0; 
        
        // Select today's day for diet based on actual real-world day
        const days = ['sun','mon','tue','wed','thu','fri','sat'];
        let currentDay = days[new Date().getDay()];
        $("#dietDaySelector").value = currentDay;

        await ensureWeekLoaded(state.weekIdx + 1);

        renderHeader();
        renderProgram();
        renderDiet();

      }catch(err){
        console.error(err);
        openInfo("Hiba", `<p style="color:#ff5b6b;">${escapeHtml(err.message)}</p>`);
      }
    });
  </script>
</body>
</html>
