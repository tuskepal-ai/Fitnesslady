<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fitness Lady ‚Äî Saj√°t programom</title>

  <style>
    :root{ --bg: #07060b; --text: #fff; --pink: #ff4fd8; --pink2: #b14cff; --max: 1180px; }
    *{ box-sizing: border-box; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, sans-serif; color: var(--text);
      background-color: var(--bg);
      background-image: radial-gradient(circle at 15% 10%, rgba(255,79,216,.15) 0%, transparent 40%), radial-gradient(circle at 85% 80%, rgba(177,76,255,.12) 0%, transparent 45%);
      background-attachment: fixed; background-size: cover; padding-top: 70px; padding-bottom: 50px;
    }
    .container { width: min(var(--max), 92vw); margin: 0 auto; }
    .topbar { position: fixed; top: 0; left: 0; right: 0; z-index: 50; background: rgba(8,6,12,.75); border-bottom: 1px solid rgba(255,255,255,.06); backdrop-filter: blur(12px); height: 64px; display: flex; align-items: center; }
    
    .glass { background: rgba(18, 12, 26, 0.55); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 22px; padding: 18px; margin-bottom: 14px; }
    h2, h3 { margin: 0 0 6px; font-family: ui-serif, Georgia, serif; }
    .sub { color: rgba(255,255,255,.6); font-size: 13.5px; margin: 0 0 12px; }

    .tabs { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
    .tab { padding: 8px 14px; border-radius: 999px; border: 1px solid rgba(255,255,255,.1); background: rgba(255,255,255,.05); color: #ccc; cursor: pointer; font-weight: bold; font-size: 13px; transition: 0.2s; }
    .tab.is-active { background: linear-gradient(135deg, var(--pink), var(--pink2)); color: #140813; border-color: transparent; }

    .grid { display: grid; grid-template-columns: 1.2fr .8fr; gap: 14px; align-items: start; }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }

    .list { margin: 0; padding: 0; list-style: none; display: grid; gap: 10px; }
    .row { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; padding: 12px; border-radius: 16px; background: rgba(0,0,0,.3); border: 1px solid rgba(255,255,255,.06); }
    .row .title { font-weight: bold; font-size: 14px; }
    .row .desc { color: rgba(255,255,255,.6); font-size: 12.5px; margin-top: 4px; }
    
    .pill { display: inline-flex; align-items: center; padding: 8px 12px; border-radius: 999px; background: rgba(255,255,255,.1); border: none; color: #fff; cursor: pointer; font-size: 12px; font-weight: bold; }
    .pill.primary { background: linear-gradient(135deg, var(--pink), var(--pink2)); color: #140813; }
    .pill.danger { background: rgba(255,255,255,.15); color: #fff; }

    .modal-overlay { position: fixed; inset: 0; z-index: 80; background: rgba(0,0,0,.8); display: none; align-items: center; justify-content: center; padding: 18px; }
    .modal-overlay.is-open { display: flex; }
    .modal { width: min(900px, 100%); background: #0a080f; border-radius: 20px; border: 1px solid rgba(255,255,255,.1); overflow: hidden; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="container" style="display:flex; justify-content:space-between; align-items:center;">
      <b style="color:var(--pink);">Fitness Lady</b>
      <button class="pill" id="btnLogout">Kil√©p√©s</button>
    </div>
  </header>

  <main class="container">
    <section class="glass">
      <h2 style="margin-bottom:12px;">Napi Vez√©rl≈ëpult</h2>
      <div class="tabs" id="weekTabs"></div>
      <div class="tabs" id="dayTabs" style="margin-bottom:0;"></div>
    </section>

    <div class="grid">
      <section class="glass">
        <h3>Mai Edz√©sek</h3>
        <p class="sub">Csak azokat az edz√©seket l√°tod itt, amik erre a napra lettek kijel√∂lve.</p>
        <ul class="list" id="workoutList"></ul>

        <h3 style="margin-top:20px;">Szem√©lyre szabott vide√≥k</h3>
        <ul class="list" id="slotList"></ul>
      </section>

      <div style="display:grid; gap:14px;">
        <section class="glass">
          <h3>Mai √âtrend</h3>
          <p class="sub">A kiv√°lasztott naphoz tartoz√≥ √©tkez√©sek.</p>
          <div id="dietDetails" style="display:grid; gap:8px;"></div>
        </section>

        <section class="glass">
          <h3>Napi C√©lok</h3>
          <div style="margin-bottom:14px;">
            <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px;"><span>üíß V√≠z</span><b id="lblWater">0/8</b></div>
            <div style="background:#222; height:8px; border-radius:9px; overflow:hidden;"><div id="barWater" style="background:#00f2fe; height:100%; width:0%;"></div></div>
            <button class="pill" id="btnAddWater" style="margin-top:6px;">+1 poh√°r</button>
          </div>
          <div>
            <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px;"><span>üåô Alv√°s</span><b id="lblSleep">0/8</b></div>
            <div style="background:#222; height:8px; border-radius:9px; overflow:hidden;"><div id="barSleep" style="background:#38f9d7; height:100%; width:0%;"></div></div>
            <button class="pill" id="btnAddSleep" style="margin-top:6px;">+1 √≥ra</button>
          </div>
          
          <div style="margin-top:16px; padding:12px; background:rgba(255,79,216,.1); border-left:4px solid var(--pink); border-radius:8px;">
            <strong id="motivationTitle" style="display:block; margin-bottom:4px; font-size:14px;">‚Äî</strong>
            <span id="motivationBox" style="color:rgba(255,255,255,.8); font-size:13px;">‚Äî</span>
          </div>
        </section>
      </div>
    </div>
  </main>

  <div class="modal-overlay" id="infoOverlay">
    <div class="modal">
      <div style="padding:14px; background:#111; display:flex; justify-content:space-between;">
        <b>Lej√°tsz√°s</b><button class="pill" id="infoClose">‚úï</button>
      </div>
      <div id="infoBody" style="padding:16px;"></div>
    </div>
  </div>

  <script type="module">
    import { db, fs, onAuth, logout, toLogin } from "../shared/firebase.js";
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    const k = (uid, key) => `fl_${uid}_${key}_v1`;
    const lsGet = (uid, key, def) => { try { return JSON.parse(localStorage.getItem(k(uid,key))) || def; } catch { return def; } };
    const lsSet = (uid, key, val) => localStorage.setItem(k(uid,key), JSON.stringify(val));

    const DAYS = [
      { id:"mon", name:"H√©tf≈ë" }, { id:"tue", name:"Kedd" }, { id:"wed", name:"Szerda" },
      { id:"thu", name:"Cs√ºt√∂rt√∂k" }, { id:"fri", name:"P√©ntek" }, { id:"sat", name:"Szombat" }, { id:"sun", name:"Vas√°rnap" }
    ];

    let UID = null, profile = {}, planMeta = {}, weekCache = new Map();
    const state = { weekIdx: 0, selectedDay: "mon", done: {}, water: 0, sleep: 0 };

    $("#infoClose").onclick = () => { $("#infoOverlay").classList.remove("is-open"); $("#infoBody").innerHTML = ""; };
    $("#btnLogout").onclick = async () => { await logout(); toLogin(); };

    async function loadData() {
      profile = (await fs.getDoc(fs.doc(db, "users", UID))).data() || {};
      const planId = profile.planId || "start_v1";
      planMeta = (await fs.getDoc(fs.doc(db, "planTemplates", planId))).data() || { weeks:4 };
      await ensureWeek(state.weekIdx + 1);
      renderAll();
    }

    async function ensureWeek(wNo){
      if(weekCache.has(wNo)) return;
      const planId = profile.planId || "start_v1";
      const wDoc = (await fs.getDoc(fs.doc(db, "planTemplates", planId, "weeks", String(wNo)))).data() || {};
      const oDoc = (await fs.getDoc(fs.doc(db, "users", UID, "overridesWeeks", String(wNo)))).data() || {};
      
      const mergedW = (wDoc.workouts||[]).map(w => ({ ...w, _title: oDoc.workouts?.[w.id]?.title || w.title, vimeoId: oDoc.workouts?.[w.id]?.vimeoId || w.vimeoId }));
      const mergedS = (wDoc.slots||[]).map(s => ({ ...s, _title: s.title, vimeoId: oDoc.slots?.[s.slotIndex]?.vimeoId || s.defaultVimeoId }));
      weekCache.set(wNo, { workouts: mergedW, slots: mergedS });
    }

    function renderAll(){
      // F√ºlek rajzol√°sa
      $("#weekTabs").innerHTML = Array.from({length: planMeta.weeks || 4}).map((_, i) => 
        `<button class="tab ${i===state.weekIdx?'is-active':''}" data-w="${i}">H√©t ${i+1}</button>`
      ).join("");
      
      $("#dayTabs").innerHTML = DAYS.map(d => 
        `<button class="tab ${d.id===state.selectedDay?'is-active':''}" data-d="${d.id}">${d.name}</button>`
      ).join("");

      $$("#weekTabs .tab").forEach(b => b.onclick = async () => { state.weekIdx = parseInt(b.dataset.w); await ensureWeek(state.weekIdx + 1); renderAll(); });
      $$("#dayTabs .tab").forEach(b => b.onclick = () => { state.selectedDay = b.dataset.d; renderAll(); });

      const wNo = state.weekIdx + 1;
      const pack = weekCache.get(wNo);

      // ‚úÖ OKOS VIDE√ì SZ≈∞R√âS:
      // Ha egy vide√≥nak van "day" mez≈ëje, csak aznap mutatjuk. Ha nincs, betessz√ºk a "Rugalmas" kateg√≥ri√°ba.
      const dailyW = pack.workouts.filter(w => w.day === state.selectedDay);
      const flexW = pack.workouts.filter(w => !w.day);
      
      let wHtml = "";
      if(dailyW.length > 0) { wHtml += `<div style="color:var(--pink); font-size:12px; margin-bottom:8px; text-transform:uppercase; font-weight:bold;">Mai k√∂telez≈ë</div>` + dailyW.map(w => buildLi(w, wNo, false)).join(""); }
      if(flexW.length > 0) { wHtml += `<div style="color:#aaa; font-size:12px; margin:14px 0 8px; text-transform:uppercase; font-weight:bold;">Rugalmas / B√°rmelyik napra</div>` + flexW.map(w => buildLi(w, wNo, false)).join(""); }
      if(!wHtml) wHtml = `<li class="row"><div class="desc">M√°ra nincs edz√©s.</div></li>`;
      $("#workoutList").innerHTML = wHtml;

      $("#slotList").innerHTML = pack.slots.map(s => buildLi(s, wNo, true)).join("") || `<li class="row"><div class="desc">Nincs extra vide√≥.</div></li>`;

      // Esem√©nykezel≈ëk a gombokra
      $$("[data-play]").forEach(btn => btn.onclick = () => {
        const vid = btn.dataset.play;
        if(!vid) return;
        $("#infoBody").innerHTML = `<iframe src="https://player.vimeo.com/video/${vid}" width="100%" height="400" frameborder="0" allow="autoplay; fullscreen"></iframe>`;
        $("#infoOverlay").classList.add("is-open");
      });
      $$("[data-toggle]").forEach(btn => btn.onclick = () => {
        state.done[btn.dataset.toggle] = !state.done[btn.dataset.toggle];
        lsSet(UID, "done", state.done); renderAll();
      });

      // √âtrend
      const dPlan = profile.dietPlan?.[`w${wNo}`]?.[state.selectedDay] || {};
      $("#dietDetails").innerHTML = [
        {k:"breakfast", l:"Reggeli"},{k:"snack1", l:"T√≠z√≥rai"},{k:"lunch", l:"Eb√©d"},{k:"snack2", l:"Uzsonna"},{k:"dinner", l:"Vacsora"}
      ].map(m => `<div class="row" style="${!dPlan[m.k]?'opacity:0.4':''}"><div><div class="title">${m.l}</div><div class="desc">${dPlan[m.k] || "‚Äî"}</div></div></div>`).join("");

      // C√©lok
      $("#lblWater").textContent = `${state.water}/8`; $("#barWater").style.width = `${(state.water/8)*100}%`;
      $("#lblSleep").textContent = `${state.sleep}/8`; $("#barSleep").style.width = `${(state.sleep/8)*100}%`;
      $("#motivationTitle").textContent = profile.motivationCard?.title || "F√≥kusz";
      $("#motivationBox").textContent = profile.motivationCard?.text || "Tartsd a ritmust!";
    }

    function buildLi(item, wNo, isSlot){
      const key = isSlot ? `s${wNo}_${item.slotIndex}` : `w${wNo}_${item.id}`;
      const done = state.done[key];
      return `<li class="row">
        <div><div class="title">${item._title||item.title} ${done?'‚úÖ':''}</div><div class="desc">${item._desc||item.desc||""}</div></div>
        <div style="display:flex; gap:8px;">
          <button class="pill" data-play="${item.vimeoId||''}">‚ñ∂</button>
          ${!isSlot ? `<button class="pill ${done?'danger':'primary'}" data-toggle="${key}">${done?'Visszavon':'K√©sz'}</button>` : ''}
        </div>
      </li>`;
    }

    $("#btnAddWater").onclick = () => { state.water = Math.min(8, state.water+1); lsSet(UID,"water",state.water); renderAll(); };
    $("#btnAddSleep").onclick = () => { state.sleep = Math.min(8, state.sleep+1); lsSet(UID,"sleep",state.sleep); renderAll(); };

    onAuth(user => {
      if(!user) return toLogin();
      UID = user.uid;
      state.done = lsGet(UID, "done", {}); state.water = lsGet(UID, "water", 0); state.sleep = lsGet(UID, "sleep", 0);
      loadData();
    });
  </script>
</body>
</html>
