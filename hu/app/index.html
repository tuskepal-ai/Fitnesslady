<!-- FILE: /hu/app/index.html -->
<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>Fitness Lady ‚Äî Saj√°t programom</title>

  <!-- ‚úÖ PWA -->
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#07060b" />

  <!-- ‚úÖ iOS PWA (Add to Home Screen) -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="FitnessLady" />
  <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png" />
  <!-- extra fallback -->
  <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512.png" />

  <style>
    :root{
      --bg:#07060b;
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --pink:#ff4fd8;
      --pink2:#b14cff;
      --gold:#ffd38a;
      --radius:22px;
      --shadow: 0 18px 55px rgba(0,0,0,.55);
      --max: 1180px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; scroll-behavior: smooth; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      overflow-x:hidden;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,79,216,.10), transparent 60%),
        radial-gradient(1000px 700px at 85% 25%, rgba(177,76,255,.10), transparent 62%),
        radial-gradient(900px 520px at 55% 90%, rgba(255,211,138,.07), transparent 55%),
        var(--bg);
      background-attachment: fixed;
    }

    a{ color:inherit; text-decoration:none; }
    button{ font:inherit; }
    .container{ width: min(var(--max), 92vw); margin: 0 auto; }

    .topbar{
      position: fixed; top:0; left:0; right:0; z-index: 50;
      background: rgba(8,6,12,.75); border-bottom: 1px solid rgba(255,255,255,.06);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      transform: translateZ(0);
    }
    .topbar-inner{ height: 64px; display:flex; align-items:center; justify-content: space-between; gap: 12px; }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px; white-space: nowrap; }
    .dot{ width:10px;height:10px;border-radius:999px; background: radial-gradient(circle at 30% 30%, #ffd0f6, var(--pink)); box-shadow: 0 0 18px rgba(255,79,216,.7); flex: 0 0 auto; }
    .nav{ display:flex; align-items:center; gap: 14px; color: var(--muted); font-size: 13.5px; font-weight: 800; }
    .nav a{ position: relative; padding: 10px 6px; opacity:.92; }
    .nav a:hover{ opacity:1; color: var(--text); }
    .nav a::after{
      content:""; position:absolute; left: 8px; right: 8px; bottom: 6px; height: 2px; border-radius: 99px;
      background: linear-gradient(90deg, rgba(255,215,140,0), rgba(255,215,140,.9), rgba(255,215,140,0));
      transform: scaleX(0); transition: transform .3s ease;
    }
    .nav a:hover::after, .nav a.is-active::after{ transform: scaleX(1); }

    .pill{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 9px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,.12);
      background: rgba(20,12,26,.65); color: var(--text); cursor:pointer; gap:8px;
      transition: transform .2s, border-color .2s, background .2s;
      transform: translateZ(0);
      user-select:none;
    }
    .pill:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.22); background: rgba(255,255,255,.08); }
    .pill.primary{ background: linear-gradient(135deg, var(--pink), var(--pink2)); color:#140813; font-weight: 900; border-color:transparent; }
    .pill.ghost{ background: rgba(255,255,255,.06); }
    .pill.danger{ background: rgba(255,255,255,.15); color: #fff; }
    .menu-btn{ width: 40px; height: 40px; border-radius: 999px; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.10); display:none; align-items:center; justify-content:center; cursor:pointer; }

    main{ padding-top: 64px; min-height: 100vh; }
    .page{ padding: 18px 0 64px; }
    .glass{
      background: rgba(18, 12, 26, 0.55); border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 22px; box-shadow: 0 16px 40px rgba(0,0,0,.3);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      padding: 18px; margin-bottom: 14px; transform: translateZ(0);
    }
    .grid{ display:grid; grid-template-columns: 1.2fr .8fr; gap: 14px; align-items:start; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } .nav{ display:none; } .menu-btn{ display:inline-flex; } }

    h2, h3{ margin:0 0 6px; font-family: ui-serif, Georgia, serif; letter-spacing: -.2px; }
    .sub{ margin:0 0 12px; color: var(--muted); line-height: 1.5; font-size: 13.5px; }
    .meta-row{ display:flex; flex-wrap:wrap; gap: 10px; margin-top: 10px; font-size: 12.8px; }
    .meta-pill{ display:inline-flex; align-items:center; gap:8px; padding: 8px 12px; border-radius: 999px; background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.08); }

    .progress{ background: rgba(0,0,0,.4); border: 1px solid rgba(255,255,255,.08); border-radius: 999px; height: 12px; overflow:hidden; position:relative; }
    .progress > span{ display:block; height:100%; width: 0%; background: linear-gradient(90deg, rgba(255,79,216,.9), rgba(177,76,255,.9)); border-radius: 999px; transition: width .4s ease; }
    .progress.blue > span { background: linear-gradient(90deg, #4facfe, #00f2fe); }
    .progress.green > span { background: linear-gradient(90deg, #43e97b, #38f9d7); }
    .progress-label{ display:flex; justify-content: space-between; font-size: 12.5px; color: rgba(255,255,255,.6); margin: 10px 0 6px; font-weight: 600; }

    .tabs{ display:flex; flex-wrap:wrap; gap: 8px; margin: 8px 0 14px; }
    .tab{ padding: 8px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.05); color: rgba(255,255,255,.85); cursor:pointer; font-size: 13px; font-weight: 800; transition: all .2s; user-select:none; }
    .tab.is-active{ background: linear-gradient(135deg, var(--pink), var(--pink2)); color:#140813; border-color:transparent; box-shadow: 0 4px 12px rgba(255,79,216,.25); }

    .list{ margin:0; padding:0; list-style:none; display:grid; gap:10px; }
    .row{ display:grid; grid-template-columns: 1fr auto; gap: 10px; align-items:center; padding: 12px; border-radius: 16px; background: rgba(0,0,0,.25); border: 1px solid rgba(255,255,255,.06); }
    .row .title{ font-weight: 800; font-size: 14px; }
    .row .desc{ color: rgba(255,255,255,.65); font-size: 12.8px; margin-top: 4px; line-height: 1.4; }
    .row .actions{ display:flex; gap: 8px; justify-content:flex-end; }
    .tiny{ padding: 6px 10px; font-size: 12px; }
    .chip{ display:inline-flex; align-items:center; gap:8px; padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.07); color: rgba(255,255,255,.8); font-weight: 800; font-size: 12px; }

    .interactive{ transition: transform .2s, border-color .2s; }
    .interactive:hover{ transform: translateY(-3px); border-color: rgba(255,255,255,.16); }

    .modal-overlay{ position: fixed; inset: 0; z-index: 80; background: rgba(0,0,0,.7); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; padding: 18px; }
    .modal-overlay.is-open{ display:flex; }
    .modal{ width: min(980px, 94vw); max-height: min(85vh, 760px); border-radius: 22px; overflow: hidden; position: relative; }
    .modal-header{ display:flex; align-items:center; justify-content: space-between; padding: 14px 18px; border-bottom: 1px solid rgba(255,255,255,.08); background: rgba(18,12,26,.9); }
    .modal-title{ margin:0; font-family: ui-serif; font-size: 20px; }
    .modal-close{ width: 36px; height: 36px; border-radius: 999px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); color: #fff; cursor: pointer; display:inline-flex; align-items:center; justify-content:center; }
    .modal-body{ padding: 16px; overflow-y: auto; max-height: calc(min(85vh, 760px) - 64px); background: #0a080f; }
    .field{ display:grid; gap: 6px; margin: 10px 0; }
    .field label{ color: rgba(255,255,255,.7); font-size: 12.5px; font-weight: 700; }
    .field input{ height: 44px; border-radius: 12px; border: 1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.3); color: #fff; padding: 0 12px; outline: none; }

    footer{ padding: 18px 0 36px; border-top:1px solid rgba(255,255,255,.05); text-align:center; font-size:13px; color:var(--muted); }

    /* ‚úÖ iOS install help card */
    .ios-install{
      display:none;
      margin-top: 12px;
      padding: 14px 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,211,138,.18);
      background: rgba(255,211,138,.06);
      color: rgba(255,255,255,.86);
      font-size: 13px;
      line-height: 1.5;
    }
    .ios-install b{ color:#fff; }
    .ios-install .pill{ margin-top: 10px; }

    /* =========================
       ‚úÖ CHAT (Vev≈ë) ‚Äî 3D bubble + Apple-like half-sheet
    ========================== */

    .chat-fab{
      position: fixed;
      right: 18px;
      bottom: calc(18px + env(safe-area-inset-bottom));
      z-index: 120;
      width: 62px;
      height: 62px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;

      background:
        radial-gradient(18px 18px at 28% 26%, rgba(255,255,255,.85), rgba(255,255,255,0) 60%),
        radial-gradient(26px 26px at 75% 78%, rgba(255,211,138,.30), rgba(255,211,138,0) 62%),
        linear-gradient(145deg, rgba(255,79,216,.95), rgba(177,76,255,.95));
      box-shadow:
        0 18px 46px rgba(0,0,0,.55),
        0 10px 28px rgba(255,79,216,.18),
        inset 0 1px 0 rgba(255,255,255,.25);

      display:flex;
      align-items:center;
      justify-content:center;

      transform: translateZ(0);
      animation: chatFloat 3.2s ease-in-out infinite;
    }
    .chat-fab:active{ transform: scale(.98); }
    .chat-fab svg{ width: 26px; height: 26px; filter: drop-shadow(0 6px 12px rgba(0,0,0,.35)); }
    .chat-badge{
      position:absolute;
      top: -6px;
      right: -6px;
      min-width: 22px;
      height: 22px;
      padding: 0 7px;
      border-radius: 999px;
      background: rgba(0,0,0,.85);
      border: 1px solid rgba(255,255,255,.18);
      color:#fff;
      font-size: 12px;
      font-weight: 900;
      display:none;
      align-items:center;
      justify-content:center;
      box-shadow: 0 14px 30px rgba(0,0,0,.55);
    }
    .chat-badge.is-on{ display:flex; }

    @keyframes chatFloat{
      0%,100%{ transform: translateY(0); }
      50%{ transform: translateY(-6px); }
    }

    .chat-overlay{
      position: fixed;
      inset: 0;
      z-index: 140;
      display:none;
      align-items:flex-end;
      justify-content:center;
      background: rgba(0,0,0,.58);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding-bottom: env(safe-area-inset-bottom);
    }
    .chat-overlay.is-open{ display:flex; }

    .chat-panel{
      width: min(980px, 100vw);
      height: min(56vh, 560px);
      border-radius: 26px 26px 0 0;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(10,8,14,.92);
      box-shadow: 0 30px 120px rgba(0,0,0,.70);
      overflow:hidden;
      transform: translateY(18px) scale(.985);
      opacity: 0;
      transition: transform .22s ease, opacity .22s ease;
    }
    .chat-overlay.is-open .chat-panel{
      transform: translateY(0) scale(1);
      opacity: 1;
    }

    @media (min-width: 980px){
      .chat-overlay{ align-items: stretch; justify-content:flex-end; padding-bottom:0; }
      .chat-panel{
        height: 100vh;
        width: min(420px, 100vw);
        border-radius: 26px 0 0 26px;
        transform: translateX(18px) scale(.985);
      }
      .chat-overlay.is-open .chat-panel{
        transform: translateX(0) scale(1);
      }
    }

    .chat-head{
      height: 58px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background:
        radial-gradient(900px 240px at 10% 20%, rgba(255,79,216,.14), transparent 55%),
        radial-gradient(900px 240px at 90% 10%, rgba(177,76,255,.12), transparent 55%),
        rgba(18,12,26,.95);
    }
    .chat-who{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .avatar{
      width: 34px; height: 34px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.18);
      display:flex; align-items:center; justify-content:center;
      font-weight: 950;
      color: rgba(255,255,255,.92);
      overflow:hidden;
      flex: 0 0 auto;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .chat-title{ display:grid; gap:2px; min-width: 0; }
    .chat-title b{
      font-size: 13.5px;
      letter-spacing:.2px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .chat-title span{
      font-size: 12px;
      color: rgba(255,255,255,.68);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .chat-x{
      width: 38px; height: 38px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: #fff;
      cursor: pointer;
      display:flex; align-items:center; justify-content:center;
    }

    .chat-body{
      height: calc(100% - 58px - 66px);
      padding: 12px;
      overflow:auto;
      background:
        radial-gradient(1000px 600px at 30% 5%, rgba(255,79,216,.08), transparent 52%),
        radial-gradient(900px 560px at 80% 20%, rgba(177,76,255,.07), transparent 52%),
        rgba(6,5,10,.92);
    }

    .msgRow{ display:flex; margin: 10px 0; gap: 8px; }
    .msgRow.me{ justify-content:flex-end; }

    .msgCol{
      display:flex;
      flex-direction:column;
      gap: 6px;
      max-width: 78%;
      min-width: 0;
    }
    .msgRow.me .msgCol{ align-items:flex-end; }

    .bubble{
      width: fit-content;
      min-width: 64px;
      max-width: 100%;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      line-height: 1.45;
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
      white-space: pre-wrap;
      word-break: normal;
      overflow-wrap: break-word;
    }
    .bubble.me{
      border-color: rgba(255,79,216,.22);
      background: linear-gradient(135deg, rgba(255,79,216,.92), rgba(177,76,255,.92));
      color: #140813;
      font-weight: 800;
      box-shadow:
        0 18px 46px rgba(0,0,0,.40),
        0 12px 28px rgba(255,79,216,.12);
    }
    .metaTime{
      font-size: 11px;
      color: rgba(255,255,255,.55);
      text-align: right;
    }
    .metaTime.me{ color: rgba(20,8,19,.70); }

    .chat-foot{
      height: 66px;
      padding: 10px;
      border-top: 1px solid rgba(255,255,255,.08);
      background: rgba(12,10,16,.92);
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .chat-input{
      flex:1;
      height: 44px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      padding: 0 12px;
      outline:none;
    }
    .chat-send{
      height: 44px;
      padding: 0 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      cursor:pointer;
      background: linear-gradient(135deg, var(--pink), var(--pink2));
      color:#140813;
      font-weight: 950;
      box-shadow: 0 18px 46px rgba(255,79,216,.14);
    }

    .chat-empty{
      padding: 14px;
      border-radius: 18px;
      border: 1px dashed rgba(255,255,255,.14);
      color: rgba(255,255,255,.70);
      background: rgba(255,255,255,.04);
      text-align:center;
      margin-top: 10px;
    }

    @media (prefers-reduced-motion: reduce){
      .chat-fab{ animation:none; }
      .chat-panel{ transition:none; }
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="container topbar-inner">
      <a class="brand" id="homeLink" href="#" aria-label="Vissza a f≈ëoldalra">
        <span class="dot"></span><span>Fitness Lady</span>
      </a>
      <nav class="nav" aria-label="Vev≈ë men√º">
        <a href="#program" data-nav>Programom</a>
        <a href="#etrend" data-nav>√âtrend</a>
        <a href="#checkin" data-nav>C√©lok</a>
        <a href="#technika" data-nav>Technika</a>
      </nav>
      <div style="display:flex; align-items:center; gap:10px;">
        <button class="menu-btn" id="menuBtn" aria-label="Men√º">‚ò∞</button>
        <button class="pill ghost" id="btnLogout" type="button" title="Kijelentkez√©s">Kil√©p√©s</button>
      </div>
    </div>
  </header>

  <main class="container page">

    <section id="top" class="glass card">
      <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;">
        <div>
          <div class="chip" id="chipPackage">Csomag: ‚Äî</div>
          <h2 style="margin-top:10px;" id="welcomeTitle">Saj√°t programom</h2>
          <p class="sub" id="subStatus">Bet√∂lt√©s‚Ä¶</p>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="pill ghost" id="btnOpenSettings" type="button">Be√°ll√≠t√°sok</button>
        </div>
      </div>

      <!-- ‚úÖ iOS install help (csak iPhone Safari eset√©n, ha nincs telep√≠tve) -->
      <div class="ios-install" id="iosInstallHelp">
        <b>iPhone telep√≠t√©s:</b> Safari ‚Üí <b>Megoszt√°s</b> (‚§¥Ô∏é) ‚Üí <b>Add to Home Screen</b>.
        <div style="opacity:.85; margin-top:6px;">Ut√°na ikonk√©nt lesz a kezd≈ëk√©perny≈ën, ‚Äûappk√©nt‚Äù ny√≠lik meg.</div>
      </div>

      <div class="progress-label">
        <span id="lblWeek">H√©t: ‚Äî</span>
        <span id="lblDays">St√°tusz: ‚Äî</span>
      </div>
      <div class="progress"><span id="barCycle"></span></div>

      <div class="meta-row">
        <div class="meta-pill" id="pillGoal">C√©l: ‚Äî</div>
        <div class="meta-pill" id="pillIntensity">Szint: ‚Äî</div>
      </div>
    </section>

    <div class="grid">
      <section id="program" class="glass card">
        <h3>Heti edz√©sek</h3>
        <p class="sub">Heti bont√°sban l√°tod az edz√©seidet. A szem√©lyre szab√°s slotokat Edina friss√≠ti.</p>

        <div class="glass interactive" id="introCard" style="display:none; margin: 12px 0 14px; padding:16px; border:1px solid rgba(255,211,138,.18); background: rgba(255,211,138,.05);">
          <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap;">
            <div style="flex:1;">
              <div style="font-family: ui-serif, Georgia, serif; font-weight:800; font-size:16px; color:rgba(255,255,255,.94);" id="introTitle">‚Äî</div>
              <div style="margin-top:6px; color:rgba(255,255,255,.78); font-size:13.5px; line-height:1.6; white-space:pre-wrap;" id="introText">‚Äî</div>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <button class="pill primary tiny" id="btnPlayIntro" type="button" style="display:none;">Megn√©zem</button>
            </div>
          </div>
        </div>

        <div class="tabs" id="weekTabs" aria-label="H√©t v√°laszt√≥"></div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin: 0 0 10px;">
          <button class="pill ghost tiny" id="btnResetWeek" type="button">H√©t √∫jraind√≠t√°sa</button>
        </div>

        <ul class="list" id="workoutList"></ul>

        <hr style="border:none; height:1px; background:rgba(255,255,255,.08); margin: 18px 0;" />

        <h3>Szem√©lyre szab√°s</h3>
        <p class="sub">A slotok csak a te programodhoz tartoz√≥ egyedi vide√≥kat mutatj√°k.</p>
        <ul class="list" id="slotList"></ul>
      </section>

      <div style="display:grid; gap:14px;">
        <section id="etrend" class="glass card">
          <h3>Napi √©trend</h3>
          <p class="sub">V√°laszd ki a napot az √©tkez√©sek megtekint√©s√©hez.</p>
          <div class="tabs" id="dietDays" style="margin-bottom:12px;"></div>
          <div id="dietDetails"></div>
        </section>

        <section id="checkin" class="glass card">
          <h3>Napi c√©lok</h3>
          <p class="sub">A nap √°llapota Firestore-ban van mentve, adminb√≥l is kezelhet≈ë.</p>

          <div style="display:grid; gap:14px;">
            <div>
              <div class="progress-label" style="margin-top:0;"><span>V√≠z</span><span id="lblWater">0/8</span></div>
              <div class="progress blue"><span id="barWater"></span></div>
              <div style="margin-top:8px;"><button class="pill ghost tiny" id="btnAddWater" type="button">+1</button></div>
            </div>

            <div>
              <div class="progress-label" style="margin-top:0;"><span>Alv√°s</span><span id="lblSleep">0/8</span></div>
              <div class="progress green"><span id="barSleep"></span></div>
              <div style="margin-top:8px;"><button class="pill ghost tiny" id="btnAddSleep" type="button">+1</button></div>
            </div>

            <div>
              <div class="progress-label" style="margin-top:0;"><span>Check-in</span><span id="checkinLabel">0/1</span></div>
              <div class="progress"><span id="barCheckin"></span></div>
              <div style="margin-top:8px;">
                <button class="pill primary tiny" id="btnDoCheckin" type="button">K√©sz</button>
                <button class="pill ghost tiny" id="btnResetTrackers" type="button">Null√°z√°s</button>
              </div>
            </div>

            <div class="interactive" style="margin-top:8px; padding:16px; background:rgba(255,79,216,.08); border:1px solid rgba(255,79,216,.2); border-radius:18px;">
              <strong id="motivationTitle" style="color:#fff; display:block; margin-bottom:6px; font-size:15px; font-family: ui-serif, Georgia, serif;">‚Äî</strong>
              <span id="motivationBox" style="color:rgba(255,255,255,.8); font-size:13.5px; line-height:1.6; white-space:pre-wrap;">‚Äî</span>
            </div>
          </div>
        </section>
      </div>
    </div>

    <section id="technika" class="glass card" style="margin-top:14px;">
      <h3>Technika Vault</h3>
      <p class="sub">Admin √°ltal mentett technikai anyagok.</p>
      <ul class="list" id="techList"></ul>
    </section>
  </main>

  <footer>
    <div class="container footer-inner">
      <div>¬© <span id="y"></span> Fitness Lady</div>
      <div>T√ºske web design</div>
    </div>
  </footer>

  <!-- Settings -->
  <div class="modal-overlay" id="settingsOverlay" role="dialog" aria-modal="true" aria-labelledby="settingsTitle" aria-hidden="true">
    <div class="glass modal" role="document">
      <div class="modal-header">
        <h2 class="modal-title" id="settingsTitle">Be√°ll√≠t√°sok</h2>
        <button class="modal-close" id="settingsClose" type="button" aria-label="Bez√°r√°s">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="field"><label for="setGoal">C√©l</label><input id="setGoal" type="text" placeholder="pl. form√°l√°s" /></div>
        <div class="field"><label for="setLevel">Szint (1‚Äì4)</label><input id="setLevel" type="number" min="1" max="4" /></div>
        <div class="field"><label for="setPhoto">Profilk√©p URL (opcion√°lis)</label><input id="setPhoto" type="text" placeholder="https://..." /></div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:16px;">
          <button class="pill primary" id="btnSaveSettings" type="button">Ment√©s</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Info modal -->
  <div class="modal-overlay" id="infoOverlay" role="dialog" aria-modal="true" aria-labelledby="infoTitle" aria-hidden="true">
    <div class="glass modal" role="document">
      <div class="modal-header">
        <h2 class="modal-title" id="infoTitle">Info</h2>
        <button class="modal-close" id="infoClose" type="button" aria-label="Bez√°r√°s">‚úï</button>
      </div>
      <div class="modal-body" id="infoBody"></div>
    </div>
  </div>

  <!-- ‚úÖ CHAT Bubble -->
  <button class="chat-fab" id="chatFab" type="button" aria-label="Chat megnyit√°sa" title="Chat">
    <span class="chat-badge" id="chatBadge">1</span>
    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M7 8h10M7 12h7M12 20c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.1.33 2.13.93 3.05L4 20l3.18-.79c1.37.51 2.99.79 4.82.79Z"
            stroke="white" stroke-opacity=".92" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>

  <!-- ‚úÖ CHAT Overlay + Panel -->
  <div class="chat-overlay" id="chatOverlay" aria-hidden="true">
    <div class="chat-panel" role="dialog" aria-modal="true" aria-label="Chat">
      <div class="chat-head">
        <div class="chat-who">
          <div class="avatar" id="chatAvatar">FL</div>
          <div class="chat-title">
            <b id="chatName">Chat</b>
            <span id="chatSub">√çrj nyugodtan ‚Äî 24 √≥r√°n bel√ºl v√°laszolunk.</span>
          </div>
        </div>
        <button class="chat-x" id="chatClose" type="button" aria-label="Bez√°r√°s">‚úï</button>
      </div>

      <div class="chat-body" id="chatBody">
        <div class="chat-empty" id="chatEmpty" style="display:none;">
          M√©g nincs √ºzenet. √çrj egy √ºzenetet Edin√°nak! üí¨
        </div>
      </div>

      <div class="chat-foot">
        <input class="chat-input" id="chatInput" type="text" placeholder="√çrj ide..." autocomplete="off" />
        <button class="chat-send" id="chatSend" type="button">K√ºld√©s</button>
      </div>
    </div>
  </div>

  <script type="module">
    import {
      BASE_PREFIX, auth, db, fs,
      onAuth, logout, toLogin,
      escapeHtml, safeJsonParse, todayISO, clamp, daysBetween, fmtDate
    } from "../shared/firebase.js";

    const homeLink = document.getElementById("homeLink");
    if (homeLink) homeLink.href = `${BASE_PREFIX}/hu/`;

    // ‚úÖ iOS install help (csak iOS Safari + nem standalone)
    (function iosInstallHint(){
      const el = document.getElementById("iosInstallHelp");
      if(!el) return;
      const ua = navigator.userAgent || "";
      const isIOS = /iPhone|iPad|iPod/i.test(ua);
      const isStandalone = window.matchMedia && window.matchMedia("(display-mode: standalone)").matches;
      // iOS Safari standalone r√©gi jelz≈ë:
      const iosStandalone = (navigator.standalone === true);
      if(isIOS && !(isStandalone || iosStandalone)){
        el.style.display = "block";
      }
    })();

    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const settingsOverlay = $("#settingsOverlay");
    const infoOverlay = $("#infoOverlay");
    function openOverlay(ov){ ov.classList.add("is-open"); }
    function closeOverlay(ov){ ov.classList.remove("is-open"); }
    function openInfo(title, html){ $("#infoTitle").textContent = title; $("#infoBody").innerHTML = html; openOverlay(infoOverlay); }

    $("#settingsClose").addEventListener("click", ()=>closeOverlay(settingsOverlay));
    $("#infoClose").addEventListener("click", ()=>{ closeOverlay(infoOverlay); $("#infoBody").innerHTML = ""; });
    $("#btnOpenSettings").addEventListener("click", ()=>openOverlay(settingsOverlay));

    const k = (uid, key) => `fl_${uid}_${key}_v1`;
    const lsGet = (uid, key, fallback) => safeJsonParse(localStorage.getItem(k(uid,key)), fallback);
    const lsSet = (uid, key, value) => localStorage.setItem(k(uid,key), JSON.stringify(value));

    let UID = null;
    let profile = null;
    let planMeta = null;
    const weekCache = new Map();

    const state = {
      weekIdx: 0,
      selectedDay: "mon",
      done: {},
      trackers: { day: todayISO(), water:0, sleep:0, checkinDone:false, checkinAt:null },
      lang: "hu"
    };

    const DAYS = [
      { id:"mon", name:"H√©" }, { id:"tue", name:"Ke" }, { id:"wed", name:"Sze" },
      { id:"thu", name:"Cs" }, { id:"fri", name:"P√©" }, { id:"sat", name:"Szo" }, { id:"sun", name:"Va" }
    ];

    function vimeoEmbedSrc(raw){
      const v = String(raw || "").trim();
      if(!v) return "";
      if(v.includes("player.vimeo.com/video/")) return v;
      const m1 = v.match(/vimeo\.com\/(?:video\/)?(\d+)/i);
      if(m1 && m1[1]) return `https://player.vimeo.com/video/${m1[1]}`;
      const m2 = v.match(/^(\d{6,})$/);
      if(m2 && m2[1]) return `https://player.vimeo.com/video/${m2[1]}`;
      if(/^https?:\/\//i.test(v)) return v;
      return "";
    }

    function pickLang(obj, lang, fallback="‚Äî"){
      if(!obj) return fallback;
      if(typeof obj === "string") return obj;
      if(obj[lang]) return obj[lang];
      if(obj["hu"]) return obj["hu"];
      if(obj["de"]) return obj["de"];
      return fallback;
    }

    function formatMultiline(s) {
      const t = String(s ?? "").trim();
      if (!t) return "";
      return t.split("\n").map(line => escapeHtml(line.trim())).join("<br>");
    }

    function timeGreetingHu(){
      const h = new Date().getHours();
      if(h < 5) return "J√≥ √©jt";
      if(h < 11) return "J√≥ reggelt";
      if(h < 18) return "J√≥ napot";
      return "J√≥ est√©t";
    }

    async function loadUserProfile(uid){
      const snap = await fs.getDoc(fs.doc(db, "users", uid));
      return snap.exists() ? snap.data() : null;
    }
    async function loadPlanMeta(planId){
      const snap = await fs.getDoc(fs.doc(db, "planTemplates", planId));
      return snap.exists() ? snap.data() : { weeks: 4, name: {hu: planId} };
    }
    async function loadPlanWeek(planId, weekNo){
      const snap = await fs.getDoc(fs.doc(db, "planTemplates", planId, "weeks", String(weekNo)));
      return snap.exists() ? snap.data() : {};
    }
    async function loadOverridesWeek(uid, weekNo){
      const snap = await fs.getDoc(fs.doc(db, "users", uid, "overridesWeeks", String(weekNo)));
      return snap.exists() ? snap.data() : null;
    }

    async function loadTrackersForToday(){
      const day = todayISO();
      const snap = await fs.getDoc(fs.doc(db, "users", UID));
      const data = snap.data() || {};
      const byDay = data.trackersByDay || {};
      const t = byDay[day] || { water:0, sleep:0, checkinDone:false, checkinAt:null };
      state.trackers = { day, ...t };
    }

    async function saveTrackers(partial){
      const day = todayISO();
      const next = {
        water: clamp(parseInt(partial.water ?? state.trackers.water ?? 0, 10) || 0, 0, 8),
        sleep: clamp(parseInt(partial.sleep ?? state.trackers.sleep ?? 0, 10) || 0, 0, 8),
        checkinDone: typeof partial.checkinDone === "boolean" ? partial.checkinDone : !!state.trackers.checkinDone,
        checkinAt: (partial.checkinAt !== undefined) ? partial.checkinAt : (state.trackers.checkinAt || null),
        updatedAt: new Date().toISOString()
      };
      await fs.updateDoc(fs.doc(db, "users", UID), {
        [`trackersByDay.${day}`]: next,
        updatedAt: fs.serverTimestamp()
      });
      state.trackers = { day, ...next };
    }

    function mergeWorkout(templateW, ovW, lang){
      const w = { ...templateW };
      const rawVideo = ovW?.vimeoId || ovW?.video || templateW?.vimeoId || templateW?.video || "";
      w._rawVideo = String(rawVideo || "").trim();
      w._embedSrc = vimeoEmbedSrc(w._rawVideo);

      const tTitle = pickLang(templateW.title, lang, "");
      const oTitle = ovW?.title ? pickLang(ovW.title, lang, "") : "";
      w._title = oTitle || tTitle || "‚Äî";

      const tDesc = pickLang(templateW.desc, lang, "");
      const oDesc = ovW?.desc ? pickLang(ovW.desc, lang, "") : "";
      w._desc = oDesc || tDesc || "";

      return w;
    }

    function mergeSlot(templateS, ovS, lang){
      const s = { ...templateS };
      const rawVideo = (ovS?.vimeoId || ovS?.video || templateS?.defaultVimeoId || "");
      s._rawVideo = String(rawVideo || "").trim();
      s._embedSrc = vimeoEmbedSrc(s._rawVideo);

      s._title = pickLang(templateS.title, lang, "") || "‚Äî";
      s._desc = pickLang(templateS.desc, lang, "") || "";
      const tNote = pickLang(templateS.defaultNote, lang, "‚Äî");
      const oNote = ovS?.note ? pickLang(ovS.note, lang, "") : "";
      s._note = oNote || tNote || "‚Äî";
      return s;
    }

    function calcWeekIndex(p){
      if(p?.lifetimeAccess || !p?.cycleStart || !p?.cycleEnd) return 0;
      const totalDays = Math.max(1, daysBetween(p.cycleStart, p.cycleEnd));
      const passedDays = clamp(daysBetween(p.cycleStart, todayISO()), 0, totalDays);
      const weeks = planMeta?.weeks ?? 4;
      const week = clamp(Math.floor((passedDays / totalDays) * weeks) + 1, 1, weeks);
      return week - 1;
    }

    function renderWelcome(){
      const name = (profile?.name || "").trim();
      const g = timeGreetingHu();
      $("#welcomeTitle").textContent = name ? `${g}, ${name}` : `${g}`;
    }

    function renderHeader(){
      const p = profile;
      $("#chipPackage").textContent = `Csomag: ${pickLang(planMeta?.name, state.lang, p.planId || "‚Äî")}`;
      $("#pillGoal").textContent = `C√©l: ${p.goal || "‚Äî"}`;
      $("#pillIntensity").textContent = `Szint: ${p.level ? `${p.level}/4` : "‚Äî"}`;

      $("#lblWeek").textContent = `H√©t: ${state.weekIdx + 1}/${planMeta?.weeks || 4}`;
      $("#lblDays").textContent = `Akt√≠v`;
      $("#barCycle").style.width = `100%`;
      $("#subStatus").textContent = `V√°laszd ki a hetet az edz√©sekhez.`;
    }

    function renderTrackers(){
      const t = state.trackers || {};
      $("#lblWater").textContent = `${clamp(t.water||0,0,8)}/8`;
      $("#barWater").style.width = `${clamp(((t.water||0)/8)*100, 0, 100)}%`;
      $("#lblSleep").textContent = `${clamp(t.sleep||0,0,8)}/8`;
      $("#barSleep").style.width = `${clamp(((t.sleep||0)/8)*100, 0, 100)}%`;

      const done = t.checkinDone ? 1 : 0;
      $("#checkinLabel").textContent = `${done}/1`;
      $("#barCheckin").style.width = `${done*100}%`;
    }

    function renderDiet(){
      const weekKey = `w${state.weekIdx + 1}`;
      const dietDaysContainer = $("#dietDays");
      dietDaysContainer.innerHTML = "";

      DAYS.forEach(d => {
        const btn = document.createElement("button");
        btn.className = "tab" + (state.selectedDay === d.id ? " is-active" : "");
        btn.textContent = d.name;
        btn.onclick = () => { state.selectedDay = d.id; renderDiet(); };
        dietDaysContainer.appendChild(btn);
      });

      const dayPlan = profile?.dietPlan?.[weekKey]?.[state.selectedDay] || {};
      const meals = [
        { label:"Reggeli", val: dayPlan.breakfast },
        { label:"T√≠z√≥rai", val: dayPlan.snack1 },
        { label:"Eb√©d", val: dayPlan.lunch },
        { label:"Uzsonna", val: dayPlan.snack2 },
        { label:"Vacsora", val: dayPlan.dinner }
      ];

      $("#dietDetails").innerHTML = meals.map(m => {
        const formattedVal = formatMultiline(m.val);
        if(!formattedVal) {
          return `
            <div class="glass interactive" style="padding:14px 16px; margin-bottom:12px; display:flex; gap:14px; align-items:center; opacity:0.45;">
              <div style="width:10px; height:10px; border-radius:999px; background:rgba(255,255,255,.20); box-shadow:0 0 18px rgba(255,255,255,.10); flex-shrink:0;"></div>
              <div>
                <div style="font-size:12px; font-weight:900; color:var(--muted); text-transform:uppercase; letter-spacing:1px;">${escapeHtml(m.label)}</div>
                <div style="font-size:13px; color:var(--muted); margin-top:4px;">Nincs megadva erre a napra.</div>
              </div>
            </div>`;
        }
        return `
          <div class="glass interactive" style="padding:16px; margin-bottom:12px; display:flex; gap:14px; align-items:flex-start;">
            <div style="width:10px; height:10px; border-radius:999px; background:rgba(255,79,216,.85); box-shadow:0 0 18px rgba(255,79,216,.35); margin-top:6px; flex-shrink:0;"></div>
            <div style="flex:1;">
              <div style="font-size:12px; font-weight:900; color:var(--pink); text-transform:uppercase; letter-spacing:1px; margin-bottom:6px;">${escapeHtml(m.label)}</div>
              <div style="font-size:13.5px; color:rgba(255,255,255,.95); line-height:1.6;">${formattedVal}</div>
            </div>
          </div>`;
      }).join("");
    }

    function renderMotivation(){
      const mc = profile?.motivationCard;
      $("#motivationTitle").innerHTML = escapeHtml(mc?.title || "A rendszer szabads√°g.");
      $("#motivationBox").innerHTML = formatMultiline(mc?.text || "Nem kell t√∂k√©letesnek lenned. El√©g, ha k√∂vetkezetes vagy.");
    }

    function renderIntroCard(){
      const ic = profile?.welcomeCard || profile?.introCard || null;
      const title = String(ic?.title || "").trim();
      const text  = String(ic?.text || "").trim();
      const raw   = String(ic?.video || "").trim();
      const src   = vimeoEmbedSrc(raw);

      const wrap = $("#introCard");
      if(!wrap) return;

      if(!title && !text && !src){
        wrap.style.display = "none";
        $("#btnPlayIntro").style.display = "none";
        return;
      }

      $("#introTitle").textContent = title || "Bemutatkoz√≥";
      $("#introText").textContent = text || "";
      if(src){
        $("#btnPlayIntro").style.display = "inline-flex";
        $("#btnPlayIntro").onclick = () => {
          openInfo($("#introTitle").textContent || "Bemutatkoz√≥", `
            <div style="border:1px solid rgba(255,255,255,.12); border-radius:18px; overflow:hidden; background:rgba(0,0,0,.25)">
              <iframe src="${escapeHtml(src)}" width="100%" height="480" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen style="display:block"></iframe>
            </div>
          `);
        };
      } else {
        $("#btnPlayIntro").style.display = "none";
      }
      wrap.style.display = "block";
    }

    async function ensureWeekLoaded(weekNo){
      if(weekCache.has(weekNo)) return weekCache.get(weekNo);

      const pId = profile?.planId || "start_v1";
      const templateWeek = await loadPlanWeek(pId, weekNo);
      const overridesWeek = await loadOverridesWeek(UID, weekNo);

      const ovWorkouts = overridesWeek?.workouts || {};
      const ovSlots = overridesWeek?.slots || {};

      const merged = {
        weekNo,
        workouts: (templateWeek.workouts || []).map(w => mergeWorkout(w, ovWorkouts[w.id], state.lang)),
        slots: (templateWeek.slots || []).map(s => mergeSlot(s, ovSlots[String(s.slotIndex)], state.lang))
      };
      weekCache.set(weekNo, { merged });
      return weekCache.get(weekNo);
    }

    function renderProgram(){
      const weeks = planMeta?.weeks || 4;
      const tabs = $("#weekTabs");
      tabs.innerHTML = "";
      for(let i=0;i<weeks;i++){
        const b = document.createElement("button");
        b.className = "tab" + (i===state.weekIdx ? " is-active" : "");
        b.textContent = `H√©t ${i+1}`;
        b.addEventListener("click", async ()=>{
          state.weekIdx = i;
          await ensureWeekLoaded(i+1);
          renderProgram();
          renderDiet();
          renderHeader();
        });
        tabs.appendChild(b);
      }

      const weekNo = state.weekIdx + 1;
      const pack = weekCache.get(weekNo);
      if(!pack) return;

      const ul = $("#workoutList");
      ul.innerHTML = "";
      pack.merged.workouts.forEach(w=>{
        const key = `w${weekNo}_${w.id}`;
        const done = !!(state.done && state.done[key]);
        ul.innerHTML += `
          <li class="row">
            <div>
              <div class="title">${escapeHtml(w._title)} ${done ? '‚úì' : ''}</div>
              <div class="desc">${escapeHtml(w._desc)}</div>
            </div>
            <div class="actions">
              <button class="pill ghost tiny" data-play="${escapeHtml(w._embedSrc || "")}">Lej√°tsz√°s</button>
              <button class="pill ${done ? 'danger' : 'primary'} tiny" data-toggle-done="${escapeHtml(key)}">${done?'Visszavon':'K√©sz'}</button>
            </div>
          </li>`;
      });

      const sl = $("#slotList");
      sl.innerHTML = "";
      pack.merged.slots.forEach(s=>{
        sl.innerHTML += `
          <li class="row">
            <div>
              <div class="title">${escapeHtml(s._title)}</div>
              <div class="desc">${escapeHtml(s._desc)}<br><span style="color:#aaa;">Jegyzet: ${escapeHtml(s._note)}</span></div>
            </div>
            <div class="actions">
              <button class="pill ghost tiny" data-play="${escapeHtml(s._embedSrc || "")}">Lej√°tsz√°s</button>
            </div>
          </li>
        `;
      });

      $$("[data-play]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const src = b.getAttribute("data-play");
          if(!src) return openInfo("Info", "Ehhez m√©g nincs vide√≥ be√°ll√≠tva.");
          openInfo("Lej√°tsz√°s", `
            <div style="border:1px solid rgba(255,255,255,.12); border-radius:18px; overflow:hidden; background:rgba(0,0,0,.25)">
              <iframe src="${escapeHtml(src)}" width="100%" height="480" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen style="display:block"></iframe>
            </div>
          `);
        });
      });

      $$("[data-toggle-done]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const key = b.getAttribute("data-toggle-done");
          if(!state.done) state.done = {};
          state.done[key] = !state.done[key];
          lsSet(UID, "done", state.done);
          renderProgram();
        });
      });
    }

    function renderTechVault(){
      const list = $("#techList");
      list.innerHTML = "";
      const raw = profile?.techVault;
      const items = Array.isArray(raw) ? raw : (raw?.items || []);
      if(!items.length){
        list.innerHTML = `
          <li class="row">
            <div>
              <div class="title">Nincs m√©g technika anyag</div>
              <div class="desc">Edina hamarosan felt√∂lti.</div>
            </div>
            <div class="actions"></div>
          </li>`;
        return;
      }
      items.forEach(it=>{
        const title = String(it?.title || "‚Äî");
        const text  = String(it?.text || "");
        const src   = vimeoEmbedSrc(String(it?.video || ""));
        list.innerHTML += `
          <li class="row">
            <div>
              <div class="title">${escapeHtml(title)}</div>
              <div class="desc">${escapeHtml(text)}</div>
            </div>
            <div class="actions">
              <button class="pill ghost tiny" data-tech-play="${escapeHtml(src)}">Lej√°tsz√°s</button>
            </div>
          </li>`;
      });
      $$("[data-tech-play]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const src = b.getAttribute("data-tech-play") || "";
          if(!src) return openInfo("Info", "Ehhez m√©g nincs vide√≥ be√°ll√≠tva.");
          openInfo("Lej√°tsz√°s", `
            <div style="border:1px solid rgba(255,255,255,.12); border-radius:18px; overflow:hidden; background:rgba(0,0,0,.25)">
              <iframe src="${escapeHtml(src)}" width="100%" height="480" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen style="display:block"></iframe>
            </div>`);
        });
      });
    }

    $("#btnLogout").addEventListener("click", async ()=>{
      await logout();
      toLogin(state.lang || "hu");
    });

    $("#btnResetWeek").addEventListener("click", ()=>{
      const weekNo = state.weekIdx + 1;
      if(!state.done) state.done = {};
      Object.keys(state.done).forEach(k => { if(k.startsWith(`w${weekNo}_`)) delete state.done[k]; });
      lsSet(UID, "done", state.done);
      renderProgram();
    });

    $("#btnAddWater").addEventListener("click", async ()=>{
      try{ await saveTrackers({ water: Math.min(8, (state.trackers.water || 0) + 1) }); renderTrackers(); }
      catch(e){ console.error(e); openInfo("Hiba", escapeHtml(e.message || String(e))); }
    });
    $("#btnAddSleep").addEventListener("click", async ()=>{
      try{ await saveTrackers({ sleep: Math.min(8, (state.trackers.sleep || 0) + 1) }); renderTrackers(); }
      catch(e){ console.error(e); openInfo("Hiba", escapeHtml(e.message || String(e))); }
    });
    $("#btnDoCheckin").addEventListener("click", async ()=>{
      try{ await saveTrackers({ checkinDone:true, checkinAt: new Date().toISOString() }); renderTrackers(); }
      catch(e){ console.error(e); openInfo("Hiba", escapeHtml(e.message || String(e))); }
    });
    $("#btnResetTrackers").addEventListener("click", async ()=>{
      try{ await saveTrackers({ water:0, sleep:0, checkinDone:false, checkinAt:null }); renderTrackers(); }
      catch(e){ console.error(e); openInfo("Hiba", escapeHtml(e.message || String(e))); }
    });

    $("#btnSaveSettings").addEventListener("click", async ()=>{
      try{
        const goal = ($("#setGoal").value || "").trim();
        const level = clamp(parseInt($("#setLevel").value || "2", 10) || 2, 1, 4);
        const photoURL = ($("#setPhoto").value || "").trim();
        await fs.updateDoc(fs.doc(db, "users", UID), { goal, level, photoURL, updatedAt: fs.serverTimestamp() });
        profile.goal = goal; profile.level = level; profile.photoURL = photoURL;
        renderHeader(); renderChatHeader();
        closeOverlay(settingsOverlay);
      }catch(e){ console.error(e); openInfo("Hiba", escapeHtml(e.message || String(e))); }
    });

    /* =========================
       ‚úÖ CHAT (Vev≈ë) ‚Äî realtime
    ========================== */
    const chatFab = $("#chatFab");
    const chatBadge = $("#chatBadge");
    const chatOverlay = $("#chatOverlay");
    const chatClose = $("#chatClose");
    const chatBody = $("#chatBody");
    const chatEmpty = $("#chatEmpty");
    const chatInput = $("#chatInput");
    const chatSend = $("#chatSend");
    const chatAvatar = $("#chatAvatar");
    const chatName = $("#chatName");

    let chatUnsub = null;
    let chatOpen = false;
    let lastSeenCount = 0;

    function initials(name){
      const n = String(name || "").trim();
      if(!n) return "FL";
      const parts = n.split(" ").filter(Boolean);
      const a = (parts[0] || "F").slice(0,1);
      const b = (parts[1] || "L").slice(0,1);
      return (a + b).toUpperCase();
    }

    function renderChatHeader(){
      const n = (profile?.name || "").trim();
      const url = String(profile?.photoURL || "").trim();
      chatAvatar.innerHTML = "";
      if(url){
        const img = document.createElement("img");
        img.src = url;
        img.alt = "Profilk√©p";
        img.referrerPolicy = "no-referrer";
        img.onerror = ()=>{ chatAvatar.textContent = initials(n); };
        chatAvatar.appendChild(img);
      }else{
        chatAvatar.textContent = initials(n);
      }
      chatName.textContent = n ? `Chat ‚Ä¢ ${n}` : "Chat ‚Ä¢ FitnessLady";
    }

    function openChat(){
      chatOpen = true;
      chatOverlay.classList.add("is-open");
      chatOverlay.setAttribute("aria-hidden","false");
      chatBadge.classList.remove("is-on");
      chatInput.focus({ preventScroll:true });
      ensureChatListener();
    }
    function closeChat(){
      chatOpen = false;
      chatOverlay.classList.remove("is-open");
      chatOverlay.setAttribute("aria-hidden","true");
    }

    chatFab.addEventListener("click", openChat);
    chatClose.addEventListener("click", closeChat);
    chatOverlay.addEventListener("click", (e)=>{ if(e.target === chatOverlay) closeChat(); });

    function msgTime(ts){
      try{
        const d = ts?.toDate ? ts.toDate() : (ts ? new Date(ts) : null);
        if(!d) return "";
        return d.toLocaleTimeString("hu-CH", { hour:"2-digit", minute:"2-digit" });
      }catch{ return ""; }
    }

    function renderMessages(items){
      chatBody.innerHTML = "";
      if(!items || items.length === 0){
        chatEmpty.style.display = "block";
        chatBody.appendChild(chatEmpty);
        return;
      }
      chatEmpty.style.display = "none";

      items.forEach(m=>{
        const sender = String(m.sender || "").toLowerCase();
        const isMe = sender === "user";

        const row = document.createElement("div");
        row.className = "msgRow " + (isMe ? "me" : "other");

        const col = document.createElement("div");
        col.className = "msgCol";

        const bub = document.createElement("div");
        bub.className = "bubble " + (isMe ? "me" : "other");
        bub.textContent = String(m.text || "");

        const t = document.createElement("div");
        t.className = "metaTime " + (isMe ? "me" : "other");
        t.textContent = msgTime(m.createdAt);

        col.appendChild(bub);
        col.appendChild(t);

        row.appendChild(col);
        chatBody.appendChild(row);
      });

      chatBody.scrollTop = chatBody.scrollHeight;
    }

    async function ensureThreadDoc(){
      const ref = fs.doc(db, "chats", UID);
      const snap = await fs.getDoc(ref);
      if(!snap.exists()){
        await fs.setDoc(ref, {
          uid: UID,
          createdAt: fs.serverTimestamp(),
          lastMessageAt: null,
          lastMessageSender: null,
          lastMessageText: "",
          lastAdminReadAt: null,
          lastUserReadAt: fs.serverTimestamp()
        }, { merge:true });
      }
    }

    function ensureChatListener(){
      if(chatUnsub) return;
      const q = fs.query(
        fs.collection(db, "chats", UID, "messages"),
        fs.orderBy("createdAt","asc"),
        fs.limit(200)
      );
      chatUnsub = fs.onSnapshot(q, (snap)=>{
        const items = snap.docs.map(d => ({ id:d.id, ...(d.data()||{}) }));
        renderMessages(items);

        if(!chatOpen){
          if(lastSeenCount > 0 && items.length > lastSeenCount){
            chatBadge.textContent = String(items.length - lastSeenCount);
            chatBadge.classList.add("is-on");
          }
          lastSeenCount = items.length;
        }else{
          lastSeenCount = items.length;
          chatBadge.classList.remove("is-on");
        }
      }, (err)=>{
        console.error(err);
        openInfo("Chat hiba", escapeHtml(err?.message || String(err)));
      });
    }

    async function sendChat(){
      try{
        const text = String(chatInput.value || "").trim();
        if(!text) return;
        chatInput.value = "";

        await ensureThreadDoc();
        await fs.addDoc(fs.collection(db, "chats", UID, "messages"), {
          sender: "user",
          type: "text",
          text,
          createdAt: fs.serverTimestamp()
        });

        await fs.setDoc(fs.doc(db, "chats", UID), {
          lastMessageAt: fs.serverTimestamp(),
          lastMessageSender: "user",
          lastMessageText: text.slice(0, 180),
          lastUserReadAt: fs.serverTimestamp()
        }, { merge:true });
      }catch(e){
        console.error(e);
        openInfo("Chat hiba", escapeHtml(e.message || String(e)));
      }
    }

    chatSend.addEventListener("click", sendChat);
    chatInput.addEventListener("keydown", (e)=>{ if(e.key === "Enter") sendChat(); });

    onAuth(async (user)=>{
      try {
        if(!user) return toLogin("hu");
        UID = user.uid;

        state.done = lsGet(UID, "done", {}) || {};
        profile = await loadUserProfile(UID) || {};
        state.lang = profile.lang || "hu";

        planMeta = await loadPlanMeta(profile.planId || "start_v1");
        state.weekIdx = calcWeekIndex(profile);

        await loadTrackersForToday();
        await ensureWeekLoaded(state.weekIdx + 1);

        renderWelcome();
        renderHeader();
        renderTrackers();
        renderIntroCard();
        renderProgram();
        renderDiet();
        renderMotivation();
        renderTechVault();

        $("#setGoal").value = profile.goal || "";
        $("#setLevel").value = profile.level || 2;
        $("#setPhoto").value = profile.photoURL || "";

        renderChatHeader();
        ensureChatListener();

        document.getElementById("y").textContent = new Date().getFullYear();
      } catch (err) {
        console.error(err);
        $("#subStatus").textContent = `Hiba a bet√∂lt√©sn√©l: ${err.message}`;
      }
    });
  </script>
</body>
</html>
