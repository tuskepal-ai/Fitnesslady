<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FitnessLady ‚Äî Admin</title>

  <style>
    :root{
      --bg:#07060b;
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);

      --pink:#ff4fd8;
      --pink2:#b14cff;
      --gold:#ffd38a;

      --radius:22px;
      --shadow: 0 18px 55px rgba(0,0,0,.55);
      --max: 1180px;

      --glassA: rgba(255,255,255,.06);
      --glassB: rgba(255,255,255,.02);
      --stroke: rgba(255,255,255,.10);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 700px at 30% 10%, rgba(255,79,216,.16), transparent 60%),
        radial-gradient(1000px 700px at 75% 20%, rgba(177,76,255,.14), transparent 60%),
        radial-gradient(1000px 700px at 60% 90%, rgba(255,211,138,.06), transparent 55%),
        var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }

    body::before{
      content:"";
      position: fixed;
      inset: 0;
      z-index: -1;
      background-image: var(--hero-url);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      opacity:.92;
      transform: translateZ(0);
    }

    a{ color:inherit; text-decoration:none; }
    button, input, select{ font:inherit; }

    .container{ width: min(var(--max), 92vw); margin: 0 auto; }

    .topbar{
      position: fixed; top:0; left:0; right:0; z-index: 50;
      background: rgba(8,6,12,.55);
      border-bottom: 1px solid rgba(255,255,255,.06);
      backdrop-filter: blur(12px);
    }
    .topbar-inner{
      height: 64px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900; letter-spacing:.2px; white-space: nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, #ffd0f6, var(--pink));
      box-shadow: 0 0 18px rgba(255,79,216,.7);
      flex: 0 0 auto;
    }

    .pill{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(20,12,26,.55);
      backdrop-filter: blur(10px);
      color: var(--text);
      cursor:pointer;
      transition: transform .18s ease, border-color .18s ease, background .18s ease;
      user-select:none;
      white-space: nowrap;
      gap:8px;
    }
    .pill:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.20); }
    .pill.primary{
      background: linear-gradient(135deg, var(--pink), var(--pink2));
      color:#140813;
      border-color: rgba(255,255,255,.18);
      font-weight: 900;
    }
    .pill.ghost{ background: rgba(255,255,255,.06); }
    .pill.danger{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.14); }

    main{ padding-top: 64px; min-height: 100vh; }
    .page{ padding: 18px 0 64px; }

    .glass{
      background: linear-gradient(180deg, var(--glassA), var(--glassB));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
    }

    .card{ padding: 16px; }
    h1,h2,h3{ margin:0 0 10px; font-family: ui-serif, Georgia, "Times New Roman", Times, serif; letter-spacing:-.2px; }
    h1{ font-size: 22px; }
    .sub{ margin:0 0 12px; color: var(--muted); line-height:1.55; font-size: 13.5px; }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .field{
      display:grid; gap: 7px; margin: 10px 0;
    }
    label{ font-size: 12.5px; color: var(--muted2); font-weight: 850; }
    input, select{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.92);
      outline: none;
    }

    .tableWrap{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      overflow:hidden;
      background: rgba(0,0,0,.18);
    }
    table{ width:100%; border-collapse: collapse; }
    thead th{
      text-align:left;
      padding: 12px;
      font-size: 12.5px;
      color: rgba(255,255,255,.78);
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    tbody td{
      padding: 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      font-size: 13px;
      color: rgba(255,255,255,.88);
      vertical-align: top;
    }
    tbody tr:hover{ background: rgba(255,255,255,.04); cursor:pointer; }
    .muted{ color: var(--muted); font-size: 12.6px; }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      color: var(--muted);
      white-space: nowrap;
      font-weight: 850;
      font-size: 12px;
    }
    .log{
      white-space:pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 12px;
      min-height: 64px;
      color: rgba(255,255,255,.86);
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="container topbar-inner">
      <a class="brand" id="homeLink" href="/hu/">
        <span class="dot"></span>
        <span>FitnessLady Admin</span>
      </a>

      <div class="row">
        <a class="pill ghost" id="openApp" href="/hu/app/">‚Üó Vev≈ë app</a>
        <button class="pill ghost" id="btnRefresh" type="button">‚ü≥ Friss√≠t√©s</button>
        <button class="pill danger" id="btnLogout" type="button">‚éã Kil√©p√©s</button>
      </div>
    </div>
  </header>

  <main>
    <div class="container page">
      <section class="glass card" style="margin-bottom:14px;">
        <h1>Admin panel ‚Äî √ºgyfelek kezel√©se</h1>
        <p class="sub">
          Itt l√°tod a <b>users</b> collectiont √©s tudod szerkeszteni a vev≈ëk profilj√°t (csomag, c√©l, szint, akt√≠v).
        </p>
        <div class="row">
          <span class="chip" id="meChip">Bet√∂lt√©s‚Ä¶</span>
          <span class="chip" id="roleChip">Role: ‚Äî</span>
        </div>
      </section>

      <div class="grid">
        <!-- LEFT: USERS LIST -->
        <section class="glass card">
          <div class="row" style="justify-content:space-between;">
            <div>
              <h3>Vev≈ëk</h3>
              <div class="muted">Kattints egy userre a szerkeszt√©shez.</div>
            </div>
            <div style="min-width:260px; width: min(420px, 100%);">
              <input id="q" type="search" placeholder="Keres√©s email / uid / csomag / c√©l‚Ä¶" />
            </div>
          </div>

          <div style="height:10px;"></div>
          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>Email</th>
                  <th>Csomag</th>
                  <th>Szint</th>
                  <th>Akt√≠v</th>
                </tr>
              </thead>
              <tbody id="usersTbody">
                <tr><td colspan="4" class="muted">Bet√∂lt√©s‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>

          <div style="height:12px;"></div>
          <div class="log" id="log">Log: indul‚Ä¶</div>
        </section>

        <!-- RIGHT: EDIT -->
        <section class="glass card">
          <h3>Kiv√°lasztott vev≈ë</h3>
          <p class="sub">Kattints bal oldalt egy vev≈ëre, majd itt m√≥dos√≠tsd √©s mentsd.</p>

          <div class="field">
            <label>UID</label>
            <input id="e_uid" type="text" disabled />
          </div>

          <div class="field">
            <label>Email</label>
            <input id="e_email" type="text" disabled />
          </div>

          <div class="field">
            <label>Csomag</label>
            <select id="e_package">
              <option value="Start">Start</option>
              <option value="Balance">Balance</option>
              <option value="Pro">Pro</option>
            </select>
          </div>

          <div class="field">
            <label>C√©l</label>
            <input id="e_goal" type="text" placeholder="pl. Form√°l√°s / Fogy√°s / Er≈ë" />
          </div>

          <div class="field">
            <label>Szint (1‚Äì4)</label>
            <input id="e_level" type="number" min="1" max="4" />
          </div>

          <div class="field">
            <label>Akt√≠v</label>
            <select id="e_active">
              <option value="true">true</option>
              <option value="false">false</option>
            </select>
          </div>

          <hr style="border:none; height:1px; background:rgba(255,255,255,.08); margin: 14px 0;" />

          <div class="field">
            <label>Role (opcion√°lis)</label>
            <select id="e_role">
              <option value="">(nincs)</option>
              <option value="admin">admin</option>
              <option value="user">user</option>
            </select>
            <div class="muted">
              Megjegyz√©s: a <b>role mez≈ë Firestore-ban √∂nmag√°ban nem el√©g biztons√°gra</b>, a Rules-t is ehhez kell k√∂tni.
            </div>
          </div>

          <div class="row">
            <button class="pill primary" id="btnSave" type="button">üíæ Ment√©s</button>
            <button class="pill ghost" id="btnClear" type="button">‚úï Kiv√°laszt√°s t√∂rl√©se</button>
          </div>

          <div style="height:12px;"></div>
          <div class="log" id="selLog">Nincs kiv√°lasztott user.</div>
        </section>
      </div>
    </div>
  </main>

  <script type="module">
    // =========================
    // GitHub Pages prefix + hero
    // =========================
    const BASE_PREFIX = (location.hostname.endsWith("github.io")) ? "/Fitnesslady" : "";
    document.documentElement.style.setProperty("--hero-url", `url("${BASE_PREFIX}/hero.png")`);
    document.getElementById("homeLink").href = `${BASE_PREFIX}/hu/`;
    document.getElementById("openApp").href = `${BASE_PREFIX}/hu/app/`;

    // =========================
    // Firebase
    // =========================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      getDocs,
      doc,
      getDoc,
      updateDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBl2MzyiRzgCzeg-eEWNHkc9Vxx-PgawfU",
      authDomain: "fitneady-15fd0.firebaseapp.com",
      projectId: "fitneady-15fd0",
      storageBucket: "fitneady-15fd0.firebasestorage.app",
      messagingSenderId: "480597492603",
      appId: "1:480597492603:web:2ba6c266c662b4c79e33de",
      measurementId: "G-MH1YK9C2YF"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // =========================
    // Helpers
    // =========================
    const $ = (id) => document.getElementById(id);
    const log = (msg) => { $("log").textContent = "Log: " + msg; console.log(msg); };
    const selLog = (msg) => { $("selLog").textContent = msg; };

    const escapeHtml = (s) => String(s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));

    // =========================
    // ADMIN GATE (gyors, praktikus)
    // =========================
    // 1) ide tedd a SAJ√ÅT admin emailedet
    // (k√©s≈ëbb Rules + Custom Claims lesz a "profi" megold√°s)
    const ADMIN_EMAIL_ALLOWLIST = new Set([
      "tuskepal@gmail.com" // <-- EZT hagyd √≠gy, ha ez a ti√©d
    ]);

    async function isAdminUser(user){
      if(!user?.email) return false;
      if(ADMIN_EMAIL_ALLOWLIST.has(user.email.toLowerCase())) return true;

      // plusz ellen≈ërz√©s: ha a saj√°t users/{uid} docban role=admin
      try{
        const snap = await getDoc(doc(db, "users", user.uid));
        if(snap.exists() && (snap.data()?.role === "admin")) return true;
      }catch(e){ /* ignore */ }

      return false;
    }

    // =========================
    // State
    // =========================
    let me = null;
    let users = []; // {uid, ...data}
    let filtered = [];
    let selectedUid = null;

    function renderTable(){
      const tb = $("usersTbody");
      tb.innerHTML = "";
      if(filtered.length === 0){
        tb.innerHTML = `<tr><td colspan="4" class="muted">Nincs tal√°lat.</td></tr>`;
        return;
      }

      for(const u of filtered){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <div style="font-weight:850;">${escapeHtml(u.email || "‚Äî")}</div>
            <div class="muted">${escapeHtml(u.uid)}</div>
          </td>
          <td>${escapeHtml(u.package || "‚Äî")}</td>
          <td>${escapeHtml(String(u.level ?? "‚Äî"))}</td>
          <td>${u.active === false ? "false" : "true"}</td>
        `;
        tr.addEventListener("click", ()=>selectUser(u.uid));
        tb.appendChild(tr);
      }
    }

    function applyFilter(){
      const q = ($("q").value || "").trim().toLowerCase();
      if(!q){
        filtered = [...users];
      }else{
        filtered = users.filter(u => {
          const hay = [
            u.uid,
            u.email,
            u.package,
            u.goal,
            String(u.level ?? ""),
            String(u.active ?? "")
          ].join(" ").toLowerCase();
          return hay.includes(q);
        });
      }
      renderTable();
    }

    async function loadUsers(){
      log("Users bet√∂lt√©se Firestore-b√≥l‚Ä¶");
      const snap = await getDocs(collection(db, "users"));
      users = snap.docs.map(d => ({ uid: d.id, ...d.data() }));
      users.sort((a,b)=>String(a.email||"").localeCompare(String(b.email||"")));
      filtered = [...users];
      applyFilter();
      log(`K√©sz: ${users.length} user bet√∂ltve.`);
    }

    function clearSelection(){
      selectedUid = null;
      $("e_uid").value = "";
      $("e_email").value = "";
      $("e_package").value = "Start";
      $("e_goal").value = "";
      $("e_level").value = 2;
      $("e_active").value = "true";
      $("e_role").value = "";
      selLog("Nincs kiv√°lasztott user.");
    }

    function selectUser(uid){
      const u = users.find(x=>x.uid===uid);
      if(!u) return;

      selectedUid = uid;
      $("e_uid").value = u.uid;
      $("e_email").value = u.email || "";
      $("e_package").value = (u.package || "Start");
      $("e_goal").value = (u.goal || "");
      $("e_level").value = (u.level ?? 2);
      $("e_active").value = (u.active === false ? "false" : "true");
      $("e_role").value = (u.role || "");
      selLog(`Kiv√°lasztva: ${u.email || u.uid}`);
    }

    async function saveSelected(){
      if(!selectedUid) return selLog("Nincs kiv√°lasztott user.");

      const ref = doc(db, "users", selectedUid);

      const payload = {
        package: $("e_package").value,
        goal: ($("e_goal").value || "").trim(),
        level: Math.max(1, Math.min(4, parseInt($("e_level").value || "2", 10))),
        active: $("e_active").value === "true",
        updatedAt: serverTimestamp()
      };

      const roleVal = $("e_role").value;
      if(roleVal) payload.role = roleVal;
      else payload.role = ""; // vagy hagyd ki, ha nem akarod t√°rolni

      await updateDoc(ref, payload);

      // friss√≠ts√ºk a list√°t lok√°lisan is
      const idx = users.findIndex(x=>x.uid===selectedUid);
      if(idx >= 0){
        users[idx] = { ...users[idx], ...payload, updatedAt: new Date() };
      }
      applyFilter();
      selLog("Mentve ‚úÖ");
      log(`Mentve: ${selectedUid}`);
    }

    // =========================
    // UI events
    // =========================
    $("q").addEventListener("input", applyFilter);
    $("btnRefresh").addEventListener("click", ()=>loadUsers().catch(e=>log("Hiba: "+(e?.message||e))));
    $("btnClear").addEventListener("click", clearSelection);
    $("btnSave").addEventListener("click", ()=>saveSelected().catch(e=>selLog("Ment√©si hiba: "+(e?.message||e))));

    $("btnLogout").addEventListener("click", async ()=>{
      await signOut(auth);
      location.href = `${BASE_PREFIX}/hu/login/`;
    });

    // =========================
    // Auth gate + init
    // =========================
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        location.href = `${BASE_PREFIX}/hu/login/`;
        return;
      }

      me = user;
      $("meChip").textContent = `Bel√©pve: ${user.email || user.uid}`;

      const ok = await isAdminUser(user);
      $("roleChip").textContent = ok ? "Role: ADMIN ‚úÖ" : "Role: NEM ADMIN ‚ùå";

      if(!ok){
        // Biztons√°g: ne mutassuk az admin oldalt
        log("Nincs admin jogosults√°g. √Åtdob√°s a vev≈ë appra.");
        location.href = `${BASE_PREFIX}/hu/app/`;
        return;
      }

      // admin ok
      await loadUsers();
      clearSelection();
    });
  </script>
</body>
</html>
