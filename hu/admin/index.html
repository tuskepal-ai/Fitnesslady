<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FitnessLady — Admin</title>

  <meta name="theme-color" content="#120018" />

  <style>
    :root{
      --bg:#07000b;
      --card:rgba(30,8,45,.68);
      --card2:rgba(40,10,60,.55);
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.66);
      --pink:#ff4fd8;
      --pink2:#c64bff;
      --ok:#2ee59d;
      --warn:#ffcc66;
      --err:#ff5b6b;
      --shadow: 0 18px 45px rgba(0,0,0,.55);
      --radius: 20px;
      --radius2: 26px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(900px 420px at 20% 15%, rgba(198,75,255,.18), transparent 55%),
        radial-gradient(800px 380px at 80% 25%, rgba(255,79,216,.16), transparent 55%),
        radial-gradient(1000px 480px at 55% 85%, rgba(255,79,216,.10), transparent 60%),
        linear-gradient(180deg, #050008, #040007 55%, #030006);
      overflow-x:hidden;
    }

    .bg {
      position:fixed; inset:0;
      background:
        radial-gradient(1200px 600px at 35% 35%, rgba(255,79,216,.14), transparent 60%),
        radial-gradient(1000px 520px at 70% 55%, rgba(198,75,255,.12), transparent 62%);
      pointer-events:none;
      opacity:.9;
    }

    header{
      position:sticky;
      top:0;
      z-index:10;
      backdrop-filter: blur(14px);
      background: rgba(10,0,15,.55);
      border-bottom: 1px solid var(--stroke);
    }
    .topbar{
      max-width:1100px;
      margin:0 auto;
      padding:14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800; letter-spacing:.2px;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: radial-gradient(circle at 30% 30%, #fff, var(--pink));
      box-shadow: 0 0 18px rgba(255,79,216,.55);
    }
    .pill{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      box-shadow: 0 10px 28px rgba(0,0,0,.25);
      font-size:14px;
      white-space:nowrap;
    }
    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}
    .btn{
      cursor:pointer;
      user-select:none;
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:10px 14px;
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:800;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 18px 38px rgba(0,0,0,.30); border-color: rgba(255,255,255,.18); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(255,79,216,.95), rgba(198,75,255,.95));
      border-color: rgba(255,255,255,.16);
      box-shadow: 0 22px 50px rgba(255,79,216,.18);
    }
    .btn.ghost{
      background: rgba(255,255,255,.04);
    }
    .btn.danger{
      background: rgba(255,91,107,.14);
      border-color: rgba(255,91,107,.30);
    }
    .btn.small{ padding:8px 12px; font-size:13px; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

    main{
      max-width:1100px;
      margin: 22px auto 80px;
      padding: 0 14px;
    }

    .card{
      border:1px solid var(--stroke);
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(25,7,40,.75), rgba(20,5,35,.55));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:16px 16px 0;
    }
    h1{
      margin:0 0 6px;
      font-size: 34px;
      letter-spacing:.2px;
    }
    .sub{
      margin:0 0 14px;
      color: var(--muted);
      line-height:1.45;
    }

    .tabs{
      display:flex; gap:10px;
      padding: 0 16px 16px;
      flex-wrap:wrap;
    }
    .tab{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      font-weight:900;
      color: var(--text);
      transition:.12s;
    }
    .tab.active{
      background: linear-gradient(135deg, rgba(255,79,216,.95), rgba(198,75,255,.95));
      box-shadow: 0 18px 42px rgba(255,79,216,.14);
      border-color: rgba(255,255,255,.16);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
      padding: 14px 16px 16px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
      h1{ font-size: 30px; }
    }

    .panel{
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      padding: 14px;
    }
    .panel h2{margin:0 0 6px; font-size: 22px;}
    .panel p{margin:0 0 12px; color:var(--muted); line-height:1.45;}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .split{ grid-template-columns: 1fr; }
    }

    .field{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
    }
    .field:focus{
      border-color: rgba(255,79,216,.45);
      box-shadow: 0 0 0 4px rgba(255,79,216,.12);
    }
    label{ display:block; font-size:13px; color:var(--muted); margin:10px 0 6px; }

    .hint{
      margin-top:8px;
      color: rgba(255,255,255,.70);
      font-size:12px;
      line-height:1.45;
    }

    .list{
      display:flex; flex-direction:column; gap:10px;
      max-height: 520px;
      overflow:auto;
      padding-right: 2px;
    }
    .item{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding: 12px;
      cursor:pointer;
      transition:.12s;
    }
    .item:hover{
      border-color: rgba(255,255,255,.18);
      box-shadow: 0 16px 34px rgba(0,0,0,.25);
      transform: translateY(-1px);
    }
    .item .t{ font-weight:900; }
    .item .m{ color:var(--muted); font-size:13px; margin-top:4px; }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.85);
      margin-left:8px;
    }
    .badge.ok{ border-color: rgba(46,229,157,.30); background: rgba(46,229,157,.10); }
    .badge.err{ border-color: rgba(255,91,107,.30); background: rgba(255,91,107,.12); }
    .badge.warn{ border-color: rgba(255,204,102,.30); background: rgba(255,204,102,.10); }

    textarea.field{
      min-height: 140px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }

    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
    }
    .table th,.table td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:top;
      font-size:13px;
    }
    .table th{
      text-align:left;
      color: rgba(255,255,255,.82);
      font-weight:900;
      background: rgba(255,255,255,.04);
    }
    .table tr:last-child td{ border-bottom:none; }
    .cell-actions{ width: 120px; white-space:nowrap; }

    .log{
      margin: 14px 16px 16px;
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      background: rgba(0,0,0,.18);
      padding: 12px 14px;
      color: rgba(255,255,255,.80);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      white-space: pre-wrap;
      line-height: 1.4;
    }

    footer{
      max-width:1100px;
      margin: 24px auto 30px;
      padding: 0 14px;
      color: rgba(255,255,255,.60);
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      font-size: 13px;
    }

    .toast{
      position: fixed;
      top: 74px;
      right: 14px;
      z-index: 50;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      max-width: 92vw;
      display:none;
      color: rgba(255,255,255,.92);
      font-weight: 800;
    }
    .toast.ok{ border-color: rgba(46,229,157,.28); }
    .toast.err{ border-color: rgba(255,91,107,.30); }
    .toast.warn{ border-color: rgba(255,204,102,.28); }
  </style>
</head>

<body>
  <div class="bg"></div>

  <header>
    <div class="topbar">
      <div class="brand">
        <span class="dot"></span>
        <span>FitnessLady <span style="opacity:.85">Admin</span></span>
      </div>

      <div class="actions">
        <span class="pill" id="statusPill">ellenőrzés…</span>
        <button class="btn" id="btnApp" title="Vevő oldal">↗ App</button>
        <button class="btn danger" id="btnLogout" title="Kilépés">↩ Kilépés</button>
      </div>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="cardHeader">
        <h1>Admin panel</h1>
        <p class="sub">
          Éles admin felület: vevők kezelése, plan sablonok (videók), és személyre szabás (overrides).
          <br><b>Belépés csak adminnak</b> (users/{uid}.role = "admin").
        </p>
      </div>

      <div class="tabs">
        <div class="tab active" data-tab="customers">Customers</div>
        <div class="tab" data-tab="plans">Plans</div>
        <div class="tab" data-tab="overrides">Overrides</div>
      </div>

      <div class="grid">
        <!-- BAL -->
        <div class="panel">
          <h2 id="leftTitle">Vevők</h2>
          <p id="leftDesc">Kattints egy vevőre. Jobbra szerkesztesz, majd Mentés → Firestore.</p>

          <!-- Customers -->
          <div id="customersBlock">
            <label>Keresés (e-mail / uid / docId)</label>
            <input class="field" id="search" placeholder="pl. teszt@email.com" />

            <div style="height:12px"></div>
            <div class="row">
              <button class="btn" id="btnReload">⟳ Lista frissítése</button>
              <button class="btn primary" id="btnNewUser">＋ Új vevő (doc)</button>
            </div>

            <div style="height:12px"></div>
            <div class="list" id="list"></div>
          </div>

          <!-- Plans PRO -->
          <div id="plansBlock" style="display:none">
            <p style="color:var(--muted);margin:0 0 12px">
              Plan sablonok (planTemplates/{planId}/weeks/{weekNo}) — PRO szerkesztő (nem JSON).
            </p>

            <div class="split">
              <div>
                <label>Plan</label>
                <select class="field" id="planPick">
                  <option value="Start">Start</option>
                  <option value="Balance">Balance</option>
                  <option value="Pro">Pro</option>
                </select>
                <div class="hint">Választhatsz előre definiáltat, vagy írd be kézzel lent.</div>
              </div>
              <div>
                <label>Plan ID (kézi)</label>
                <input class="field" id="planIdManual" placeholder="pl. start_v1 / Balance_v1 / Pro_v1" />
                <div class="hint">Ha üres, a fenti Plan választót használjuk.</div>
              </div>
            </div>

            <div class="split">
              <div>
                <label>Hét (weekNo)</label>
                <input class="field" id="planWeekNo" inputmode="numeric" placeholder="pl. 1" />
              </div>
              <div>
                <label>Hét cím (title)</label>
                <input class="field" id="planWeekTitle" placeholder='pl. "1. hét"' />
              </div>
            </div>

            <div style="height:12px"></div>
            <div class="row">
              <button class="btn" id="btnPlanLoad">Betöltés</button>
              <button class="btn primary" id="btnPlanSave">Mentés</button>
              <button class="btn ghost" id="btnPlanClear">Ürítés</button>
              <button class="btn" id="btnWorkoutAdd">＋ Új edzés sor</button>
            </div>

            <div style="height:12px"></div>
            <table class="table" id="workoutsTable">
              <thead>
                <tr>
                  <th style="width:34%">Edzés cím</th>
                  <th style="width:40%">Vimeo link (üres is lehet)</th>
                  <th style="width:14%">Perc</th>
                  <th class="cell-actions">Művelet</th>
                </tr>
              </thead>
              <tbody id="workoutsBody">
                <tr><td colspan="4" style="color:var(--muted)">Nincs betöltött hét. Nyomj Betöltést vagy adj hozzá sort.</td></tr>
              </tbody>
            </table>

            <div class="hint">
              Mentés formátum (week doc): <b>{ weekNo, title, workouts:[{title, video, duration}], updatedAt }</b><br>
              <b>Ha még nincs videó:</b> a <code>video</code> mező legyen <code>""</code>.
            </div>
          </div>

          <!-- Overrides PRO -->
          <div id="overridesBlock" style="display:none">
            <p style="color:var(--muted);margin:0 0 12px">
              Személyre szabások (users/{uid}/overrides/{docId}) — PRO szerkesztő.
            </p>

            <label>Vevő kiválasztása</label>
            <select class="field" id="ovUserPick">
              <option value="">— betöltés…</option>
            </select>

            <div style="height:10px"></div>
            <div class="row">
              <button class="btn" id="btnOvRefresh">⟳ Overrides lista</button>
              <button class="btn primary" id="btnOvNew">＋ Új override</button>
            </div>

            <div style="height:12px"></div>
            <div class="list" id="ovList"></div>

            <div style="height:12px"></div>
            <label>Override Doc ID</label>
            <input class="field" id="ovDocId" placeholder="pl. slot1 / 2026-02-15 / customA" />

            <div class="split">
              <div>
                <label>Cím (title)</label>
                <input class="field" id="ovTitle" placeholder='pl. "Személyre szabás 1"' />
              </div>
              <div>
                <label>Aktív</label>
                <select class="field" id="ovActive">
                  <option value="true">true</option>
                  <option value="false">false</option>
                </select>
              </div>
            </div>

            <label>Vimeo URL</label>
            <input class="field" id="ovVimeoUrl" placeholder="https://vimeo.com/xxxx vagy https://player.vimeo.com/video/xxxx" />

            <label>Megjegyzés (opcionális)</label>
            <textarea class="field" id="ovNote" placeholder="pl. fókusz: farizom / mobilitás / térd-kímélő"></textarea>

            <div style="height:12px"></div>
            <div class="row">
              <button class="btn" id="btnOvLoad">Betöltés</button>
              <button class="btn primary" id="btnOvSave">Mentés</button>
              <button class="btn danger" id="btnOvDelete">Törlés</button>
            </div>
          </div>
        </div>

        <!-- JOBB: editor -->
        <div class="panel">
          <h2>Szerkesztő</h2>
          <p id="rightDesc">Válassz egy vevőt bal oldalt.</p>

          <div id="editorEmpty" style="color:var(--muted)">Nincs kiválasztott vevő.</div>

          <div id="editor" style="display:none">
            <div class="row" style="justify-content:space-between; align-items:flex-start;">
              <div>
                <div style="font-weight:900;font-size:16px" id="edTitle">—</div>
                <div style="color:var(--muted);font-size:12px;margin-top:4px" id="edMeta">—</div>
              </div>
              <div class="row">
                <button class="btn" id="btnOpenDoc">↗ Firestore</button>
                <button class="btn danger" id="btnDeleteUser">Törlés</button>
              </div>
            </div>

            <label>Aktív</label>
            <select class="field" id="edActive">
              <option value="true">true</option>
              <option value="false">false</option>
            </select>

            <label>Role</label>
            <select class="field" id="edRole">
              <option value="user">user</option>
              <option value="admin">admin</option>
            </select>

            <label>Email</label>
            <input class="field" id="edEmail" placeholder="vevo@email.com" />

            <label>Csomag (package)</label>
            <select class="field" id="edPackage">
              <option value="Start">Start</option>
              <option value="Balance">Balance</option>
              <option value="Pro">Pro</option>
            </select>

            <label>Cél (goal)</label>
            <input class="field" id="edGoal" placeholder="pl. Formálás" />

            <label>Szint (level)</label>
            <input class="field" id="edLevel" inputmode="numeric" placeholder="pl. 2" />

            <label>Étrend (diet JSON) — validálva</label>
            <textarea class="field" id="edDiet" placeholder='{"kcal":1800,"protein":140,"carb":170,"fat":55,"note":"..."}'></textarea>

            <div style="height:12px"></div>
            <div class="row">
              <button class="btn" id="btnReloadUser">Frissítés</button>
              <button class="btn primary" id="btnSaveUser">Mentés → Firestore</button>
            </div>

            <div style="height:14px"></div>
            <div class="hint">
              A vevő oldal a <b>users/{uid}</b> + <b>users/{uid}/overrides</b> alapján épül.
            </div>
          </div>
        </div>
      </div>

      <div class="log" id="log">Log: betöltés…</div>
    </section>
  </main>

  <footer>
    <div>© 2026 FitnessLady — Admin</div>
    <div>Tüske web design</div>
  </footer>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore,
      doc, getDoc, setDoc, updateDoc, deleteDoc,
      collection, getDocs, query, orderBy, limit, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBl2MzyiRzgCzeg-eEWNHkc9Vxx-PgawfU",
      authDomain: "fitneady-15fd0.firebaseapp.com",
      projectId: "fitneady-15fd0",
      storageBucket: "fitneady-15fd0.firebasestorage.app",
      messagingSenderId: "480597492603",
      appId: "1:480597492603:web:2ba6c266c662b4c79e33de",
      measurementId: "G-MH1YK9C2YF"
    };

    const $ = (id)=>document.getElementById(id);

    const logEl = $("log");
    const toastEl = $("toast");
    const statusPill = $("statusPill");
    const btnApp = $("btnApp");
    const btnLogout = $("btnLogout");

    const tabs = Array.from(document.querySelectorAll(".tab"));
    const customersBlock = $("customersBlock");
    const plansBlock = $("plansBlock");
    const overridesBlock = $("overridesBlock");
    const leftTitle = $("leftTitle");
    const leftDesc = $("leftDesc");

    // Customers
    const listEl = $("list");
    const searchEl = $("search");
    const btnReload = $("btnReload");
    const btnNewUser = $("btnNewUser");

    // Right editor
    const editorEmpty = $("editorEmpty");
    const editor = $("editor");
    const edTitle = $("edTitle");
    const edMeta = $("edMeta");
    const btnOpenDoc = $("btnOpenDoc");
    const btnDeleteUser = $("btnDeleteUser");
    const edActive = $("edActive");
    const edRole = $("edRole");
    const edEmail = $("edEmail");
    const edPackage = $("edPackage");
    const edGoal = $("edGoal");
    const edLevel = $("edLevel");
    const edDiet = $("edDiet");
    const btnReloadUser = $("btnReloadUser");
    const btnSaveUser = $("btnSaveUser");

    // Plans PRO
    const planPick = $("planPick");
    const planIdManual = $("planIdManual");
    const planWeekNo = $("planWeekNo");
    const planWeekTitle = $("planWeekTitle");
    const btnPlanLoad = $("btnPlanLoad");
    const btnPlanSave = $("btnPlanSave");
    const btnPlanClear = $("btnPlanClear");
    const btnWorkoutAdd = $("btnWorkoutAdd");
    const workoutsBody = $("workoutsBody");

    // Overrides PRO
    const ovUserPick = $("ovUserPick");
    const btnOvRefresh = $("btnOvRefresh");
    const btnOvNew = $("btnOvNew");
    const ovList = $("ovList");
    const ovDocId = $("ovDocId");
    const ovTitle = $("ovTitle");
    const ovActive = $("ovActive");
    const ovVimeoUrl = $("ovVimeoUrl");
    const ovNote = $("ovNote");
    const btnOvLoad = $("btnOvLoad");
    const btnOvSave = $("btnOvSave");
    const btnOvDelete = $("btnOvDelete");

    function log(msg){
      const t = (new Date()).toLocaleString();
      logEl.textContent = `Log: ${t}\n${msg}`;
      console.log(msg);
    }
    function toast(msg, type="ok"){
      toastEl.className = `toast ${type}`;
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=> toastEl.style.display="none", 2600);
    }

    let app, auth, db;
    let currentUser = null;
    let currentProfile = null;

    // Customers state
    let usersCache = [];
    let selectedUid = null;
    let selectedDoc = null;

    // Plans state
    let planCurrentWorkouts = [];

    // Overrides state
    let overridesCache = [];
    let ovSelectedDocId = null;

    try{
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
    }catch(e){
      log(`Firebase init hiba: ${e?.message || e}`);
      statusPill.textContent = "Hiba / Konfig";
      toast("Firebase init hiba!", "err");
    }

    btnApp.addEventListener("click", ()=> window.location.href = "/hu/app/");
    btnLogout.addEventListener("click", async ()=>{
      try{
        await signOut(auth);
        toast("Kiléptél.", "ok");
        window.location.href = "/hu/login/";
      }catch(e){
        log(`Kilépés hiba: ${e?.message || e}`);
        toast("Kilépés hiba!", "err");
      }
    });

    function setTab(name){
      tabs.forEach(t=> t.classList.toggle("active", t.dataset.tab===name));
      customersBlock.style.display = (name==="customers") ? "block" : "none";
      plansBlock.style.display     = (name==="plans")     ? "block" : "none";
      overridesBlock.style.display = (name==="overrides") ? "block" : "none";

      if(name==="customers"){
        leftTitle.textContent = "Vevők";
        leftDesc.textContent = "Kattints egy vevőre. Jobbra szerkesztesz, majd Mentés → Firestore.";
      }
      if(name==="plans"){
        leftTitle.textContent = "Plans";
        leftDesc.textContent = "Plan sablonok (videók) szerkesztése — PRO felület.";
      }
      if(name==="overrides"){
        leftTitle.textContent = "Overrides";
        leftDesc.textContent = "Személyre szabások kezelése — PRO felület.";
      }
      log(`Tab: ${name}`);
    }
    tabs.forEach(t=> t.addEventListener("click", ()=> setTab(t.dataset.tab)));

    // ===== Auth + Admin check
    onAuthStateChanged(auth, async (u)=>{
      currentUser = u;

      if(!u){
        statusPill.textContent = "Nincs belépve";
        log("Nincs belépett user. Redirect → /hu/login/");
        window.location.href = "/hu/login/";
        return;
      }

      statusPill.textContent = `Belépve: ${u.email || u.uid} • ellenőrzés…`;

      try{
        const pRef = doc(db, "users", u.uid);
        const pSnap = await getDoc(pRef);

        if(!pSnap.exists()){
          statusPill.textContent = "Hiba / Nincs profil";
          log(`Nincs users/${u.uid} profil. Hozd létre Firestore-ban (role='admin').`);
          toast("Nincs profil (users/{uid})!", "err");
          return;
        }

        currentProfile = pSnap.data();
        const role = (currentProfile.role || "user").toLowerCase();

        if(role !== "admin"){
          statusPill.textContent = "Hiba / Nincs jogosultság";
          log(`Nincs admin jog. users/${u.uid}.role = ${role}`);
          toast("Nincs admin jogosultság!", "err");
          return;
        }

        statusPill.textContent = `Belépve: ${u.email} • role=admin`;
        toast("Admin belépés OK", "ok");
        log("Admin OK. Betöltés…");

        await loadUsers();
        await refreshOverridesUserPick();
      }catch(e){
        statusPill.textContent = "Hiba / Firebase";
        log(`Admin check hiba: ${e?.message || e}`);
        toast("Admin ellenőrzés hiba!", "err");
      }
    });

    // ===== Customers list
    async function loadUsers(){
      listEl.innerHTML = "";
      selectedUid = null;
      selectedDoc = null;
      editor.style.display = "none";
      editorEmpty.style.display = "block";

      try{
        const qy = query(collection(db, "users"), orderBy("createdAt", "desc"), limit(300));
        const snap = await getDocs(qy);
        usersCache = [];
        snap.forEach(d=> usersCache.push({ id:d.id, ...d.data() }));
        renderList(usersCache);
        log(`Users betöltve: ${usersCache.length} db`);

        await refreshOverridesUserPick();
      }catch(e){
        log(`Users load hiba: ${e?.message || e}`);
        toast("Nem tudom betölteni a users listát (Rules?)", "err");
      }
    }

    function renderList(items){
      const term = (searchEl.value || "").trim().toLowerCase();
      const filtered = !term ? items : items.filter(u=>{
        const id = (u.id || "").toLowerCase();
        const email = (u.email || "").toLowerCase();
        return id.includes(term) || email.includes(term);
      });

      listEl.innerHTML = "";
      if(filtered.length === 0){
        const d = document.createElement("div");
        d.className = "item";
        d.innerHTML = `<div class="t">Nincs találat</div><div class="m">Próbálj másik keresést.</div>`;
        listEl.appendChild(d);
        return;
      }

      filtered.forEach(u=>{
        const active = !!u.active;
        const role = (u.role || "user").toLowerCase();
        const pkg = u.package || "—";
        const goal = u.goal || "—";
        const level = (u.level ?? "—");

        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="t">
            ${(u.email || "(nincs email)")}
            <span class="badge ${active ? "ok" : "err"}">${active ? "active" : "inactive"}</span>
            <span class="badge ${role==="admin" ? "warn" : ""}">${role}</span>
          </div>
          <div class="m">
            uid/docId: <b>${u.id}</b><br>
            csomag: <b>${pkg}</b> • cél: <b>${goal}</b> • szint: <b>${level}</b>
          </div>
        `;
        el.addEventListener("click", ()=> selectUser(u.id));
        listEl.appendChild(el);
      });
    }

    searchEl.addEventListener("input", ()=> renderList(usersCache));
    btnReload.addEventListener("click", ()=> loadUsers());
    btnNewUser.addEventListener("click", ()=> createNewUserDoc());

    async function createNewUserDoc(){
      const email = prompt("Új vevő email:");
      if(!email) return;

      const docId = email.trim().toLowerCase().replace(/[^a-z0-9@._-]/g, "_");

      try{
        await setDoc(doc(db,"users",docId),{
          email: email.trim(),
          role: "user",
          active: true,
          package: "Start",
          goal: "Formálás",
          level: 1,
          diet: null,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge:true });

        toast("Új doc létrehozva.", "ok");
        await loadUsers();
      }catch(e){
        log(`New user doc hiba: ${e?.message || e}`);
        toast("Nem tudtam létrehozni.", "err");
      }
    }

    // ===== Right editor
    async function selectUser(uid){
      selectedUid = uid;
      editorEmpty.style.display = "none";
      editor.style.display = "block";
      edTitle.textContent = "Betöltés…";
      edMeta.textContent = uid;

      try{
        const uRef = doc(db, "users", uid);
        const uSnap = await getDoc(uRef);
        if(!uSnap.exists()){
          selectedDoc = null;
          edTitle.textContent = "Nincs ilyen user doc";
          toast("Nincs ilyen doc.", "err");
          return;
        }

        selectedDoc = uSnap.data();
        const email = selectedDoc.email || "(nincs email)";
        edTitle.textContent = email;
        edMeta.textContent = `docId/uid: ${uid}`;

        edActive.value = String(!!selectedDoc.active);
        edRole.value = (selectedDoc.role || "user");
        edEmail.value = selectedDoc.email || "";
        edPackage.value = selectedDoc.package || "Start";
        edGoal.value = selectedDoc.goal || "";
        edLevel.value = String(selectedDoc.level ?? "");

        if(selectedDoc.diet == null){
          edDiet.value = "";
        }else{
          try{
            edDiet.value = (typeof selectedDoc.diet === "string")
              ? selectedDoc.diet
              : JSON.stringify(selectedDoc.diet, null, 2);
          }catch{
            edDiet.value = "";
          }
        }

        btnOpenDoc.onclick = ()=>{
          const url = `https://console.firebase.google.com/project/${firebaseConfig.projectId}/firestore/databases/-default-/data/~2Fusers~2F${encodeURIComponent(uid)}`;
          window.open(url, "_blank");
        };

        log(`User kiválasztva: ${uid}`);
      }catch(e){
        log(`selectUser hiba: ${e?.message || e}`);
        toast("Betöltés hiba.", "err");
      }
    }

    btnReloadUser.addEventListener("click", ()=>{
      if(!selectedUid) return;
      selectUser(selectedUid);
    });

    btnSaveUser.addEventListener("click", async ()=>{
      if(!selectedUid) return;

      let dietValue = null;
      const dietText = (edDiet.value || "").trim();
      if(dietText){
        try{
          dietValue = JSON.parse(dietText);
        }catch(e){
          toast("Étrend JSON hibás (nem valid JSON).", "err");
          return;
        }
      }

      const levelNum = Number(String(edLevel.value || "").trim() || 0);
      if(Number.isNaN(levelNum) || levelNum < 0){
        toast("Szint (level) hibás szám.", "err");
        return;
      }

      const payload = {
        active: (edActive.value === "true"),
        role: edRole.value,
        email: (edEmail.value || "").trim(),
        package: edPackage.value,
        goal: (edGoal.value || "").trim(),
        level: levelNum,
        diet: dietValue,
        updatedAt: serverTimestamp()
      };

      try{
        await updateDoc(doc(db, "users", selectedUid), payload);
        toast("Mentve.", "ok");
        log(`Mentés OK: users/${selectedUid}`);
        await loadUsers();
        await selectUser(selectedUid);
      }catch(e){
        log(`Mentés hiba: ${e?.message || e}`);
        toast("Mentés hiba (Rules?)", "err");
      }
    });

    btnDeleteUser.addEventListener("click", async ()=>{
      if(!selectedUid) return;
      const ok = confirm(`Biztos törlöd? users/${selectedUid}`);
      if(!ok) return;

      try{
        await deleteDoc(doc(db, "users", selectedUid));
        toast("Törölve.", "ok");
        selectedUid = null;
        selectedDoc = null;
        editor.style.display = "none";
        editorEmpty.style.display = "block";
        await loadUsers();
      }catch(e){
        log(`Törlés hiba: ${e?.message || e}`);
        toast("Törlés hiba (Rules?)", "err");
      }
    });

    // ===== Plans PRO helpers
    function getPlanId(){
      const manual = (planIdManual.value || "").trim();
      if(manual) return manual;
      return (planPick.value || "").trim();
    }

    function renderWorkoutsTable(){
      workoutsBody.innerHTML = "";
      if(!Array.isArray(planCurrentWorkouts) || planCurrentWorkouts.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="4" style="color:var(--muted)">Nincs edzés. Nyomj: “＋ Új edzés sor”.</td>`;
        workoutsBody.appendChild(tr);
        return;
      }

      planCurrentWorkouts.forEach((w, idx)=>{
        const tr = document.createElement("tr");

        const title = (w.title ?? "");
        const video = (w.video ?? "");
        const duration = (w.duration ?? "");

        tr.innerHTML = `
          <td><input class="field" data-k="title" data-i="${idx}" value="${escapeHtml(title)}" placeholder="pl. Alsótest edzés"></td>
          <td><input class="field" data-k="video" data-i="${idx}" value="${escapeHtml(video)}" placeholder='"" vagy https://vimeo.com/....'></td>
          <td><input class="field" data-k="duration" data-i="${idx}" inputmode="numeric" value="${escapeHtml(String(duration))}" placeholder="pl. 30"></td>
          <td class="cell-actions">
            <button class="btn small danger" data-del="${idx}">Törlés</button>
          </td>
        `;
        workoutsBody.appendChild(tr);
      });

      // wire inputs
      workoutsBody.querySelectorAll("input.field").forEach(inp=>{
        inp.addEventListener("input", ()=>{
          const i = Number(inp.dataset.i);
          const k = inp.dataset.k;
          if(!planCurrentWorkouts[i]) return;
          planCurrentWorkouts[i][k] = inp.value;
        });
      });

      // wire deletes
      workoutsBody.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const i = Number(btn.dataset.del);
          planCurrentWorkouts.splice(i,1);
          renderWorkoutsTable();
        });
      });
    }

    function normalizeWorkouts(){
      // convert to clean array of maps: {title, video, duration}
      const clean = [];
      for(const raw of (planCurrentWorkouts || [])){
        const title = String(raw.title || "").trim();
        const video = String(raw.video ?? "").trim(); // may be ""
        const dur = Number(String(raw.duration ?? "").trim() || 0);

        if(!title){
          // skip empty rows
          continue;
        }
        if(Number.isNaN(dur) || dur < 0){
          throw new Error(`Hibás duration: "${raw.duration}" (csak number)`);
        }

        clean.push({
          title,
          video,       // "" is allowed
          duration: dur
        });
      }
      return clean;
    }

    btnWorkoutAdd.addEventListener("click", ()=>{
      planCurrentWorkouts = Array.isArray(planCurrentWorkouts) ? planCurrentWorkouts : [];
      planCurrentWorkouts.push({ title:"", video:"", duration: 30 });
      renderWorkoutsTable();
    });

    btnPlanClear.addEventListener("click", ()=>{
      planWeekTitle.value = "";
      planCurrentWorkouts = [];
      renderWorkoutsTable();
      toast("Ürítve.", "ok");
    });

    btnPlanLoad.addEventListener("click", async ()=>{
      const planId = getPlanId();
      const weekNo = Number(String(planWeekNo.value || "").trim() || 0);
      if(!planId){ toast("Hiányzik Plan ID.", "warn"); return; }
      if(!weekNo || Number.isNaN(weekNo) || weekNo < 1){ toast("Adj meg hét számot (>=1).", "warn"); return; }

      try{
        const wRef = doc(db, "planTemplates", planId, "weeks", String(weekNo));
        const wSnap = await getDoc(wRef);
        if(!wSnap.exists()){
          planWeekTitle.value = `${weekNo}. hét`;
          planCurrentWorkouts = [];
          renderWorkoutsTable();
          toast("Nincs ilyen hét doc — üresen létrehozhatod.", "warn");
          log(`Plan load: nincs doc planTemplates/${planId}/weeks/${weekNo}`);
          return;
        }

        const data = wSnap.data();
        planWeekTitle.value = data.title || `${weekNo}. hét`;
        planCurrentWorkouts = Array.isArray(data.workouts) ? data.workouts.map(x=>({ ...x })) : [];
        renderWorkoutsTable();
        toast("Hét betöltve.", "ok");
        log(`Plan load OK: planTemplates/${planId}/weeks/${weekNo}`);
      }catch(e){
        log(`Plan load hiba: ${e?.message || e}`);
        toast("Plan betöltés hiba.", "err");
      }
    });

    btnPlanSave.addEventListener("click", async ()=>{
      const planId = getPlanId();
      const weekNo = Number(String(planWeekNo.value || "").trim() || 0);
      const title = String(planWeekTitle.value || "").trim() || `${weekNo}. hét`;

      if(!planId){ toast("Hiányzik Plan ID.", "warn"); return; }
      if(!weekNo || Number.isNaN(weekNo) || weekNo < 1){ toast("Adj meg hét számot (>=1).", "warn"); return; }

      let workouts;
      try{
        workouts = normalizeWorkouts();
      }catch(err){
        toast(err.message || "Edzés lista hibás.", "err");
        return;
      }

      try{
        // Ensure planTemplates/{planId} exists as meta
        await setDoc(doc(db, "planTemplates", planId), {
          planId,
          updatedAt: serverTimestamp()
        }, { merge:true });

        // Save week doc
        await setDoc(doc(db, "planTemplates", planId, "weeks", String(weekNo)), {
          weekNo,
          title,
          workouts,
          updatedAt: serverTimestamp()
        }, { merge:true });

        toast("Plan hét mentve.", "ok");
        log(`Plan save OK: planTemplates/${planId}/weeks/${weekNo} workouts=${workouts.length}`);
      }catch(e){
        log(`Plan save hiba: ${e?.message || e}`);
        toast("Plan mentés hiba (Rules?)", "err");
      }
    });

    // ===== Overrides PRO
    async function refreshOverridesUserPick(){
      // fill dropdown from usersCache
      const current = ovUserPick.value;
      ovUserPick.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "— válassz vevőt —";
      ovUserPick.appendChild(opt0);

      // Prefer active first, then email sort
      const arr = [...usersCache].sort((a,b)=>{
        const aa = (!!a.active === !!b.active) ? 0 : (a.active ? -1 : 1);
        if(aa !== 0) return aa;
        return String(a.email||"").localeCompare(String(b.email||""), "hu");
      });

      for(const u of arr){
        const opt = document.createElement("option");
        opt.value = u.id;
        opt.textContent = `${u.email || u.id} • ${u.package || "—"} • ${u.active ? "active" : "inactive"}`;
        ovUserPick.appendChild(opt);
      }

      if(current){
        ovUserPick.value = current;
      }
    }

    function renderOverridesList(){
      ovList.innerHTML = "";
      if(!Array.isArray(overridesCache) || overridesCache.length === 0){
        const d = document.createElement("div");
        d.className = "item";
        d.innerHTML = `<div class="t">Nincs override</div><div class="m">Nyomj: “＋ Új override”.</div>`;
        ovList.appendChild(d);
        return;
      }

      overridesCache.forEach(o=>{
        const active = !!o.active;
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="t">
            ${escapeHtml(o.title || o.id)}
            <span class="badge ${active ? "ok" : "err"}">${active ? "active" : "inactive"}</span>
          </div>
          <div class="m">
            docId: <b>${escapeHtml(o.id)}</b><br>
            vimeo: <span style="opacity:.85">${escapeHtml((o.vimeoUrl || "").slice(0,60))}${(o.vimeoUrl||"").length>60 ? "…" : ""}</span>
          </div>
        `;
        el.addEventListener("click", ()=>{
          ovDocId.value = o.id;
          ovTitle.value = o.title || "";
          ovActive.value = String(!!o.active);
          ovVimeoUrl.value = o.vimeoUrl || "";
          ovNote.value = o.note || "";
          ovSelectedDocId = o.id;
          toast("Override kiválasztva.", "ok");
        });
        ovList.appendChild(el);
      });
    }

    async function loadOverrides(){
      const uid = (ovUserPick.value || "").trim();
      if(!uid){ toast("Válassz vevőt.", "warn"); return; }

      try{
        const snap = await getDocs(query(collection(db, "users", uid, "overrides"), orderBy("updatedAt","desc"), limit(200)));
        overridesCache = [];
        snap.forEach(d=> overridesCache.push({ id:d.id, ...d.data() }));
        renderOverridesList();
        toast("Overrides betöltve.", "ok");
        log(`Overrides load OK: users/${uid}/overrides (${overridesCache.length})`);
      }catch(e){
        log(`Overrides load hiba: ${e?.message || e}`);
        toast("Overrides betöltés hiba (Rules?)", "err");
      }
    }

    btnOvRefresh.addEventListener("click", ()=> loadOverrides());

    btnOvNew.addEventListener("click", ()=>{
      const uid = (ovUserPick.value || "").trim();
      if(!uid){ toast("Előbb válassz vevőt.", "warn"); return; }
      const id = prompt("Új override Doc ID (pl. slot1 / customA / 2026-02-15):");
      if(!id) return;
      ovDocId.value = id.trim();
      ovTitle.value = "";
      ovVimeoUrl.value = "";
      ovActive.value = "true";
      ovNote.value = "";
      ovSelectedDocId = ovDocId.value;
      toast("Add meg a mezőket, majd Mentés.", "ok");
    });

    btnOvLoad.addEventListener("click", async ()=>{
      const uid = (ovUserPick.value || "").trim();
      const docId = (ovDocId.value || "").trim();
      if(!uid || !docId){ toast("Vevő + Doc ID kell.", "warn"); return; }

      try{
        const s = await getDoc(doc(db, "users", uid, "overrides", docId));
        if(!s.exists()){
          toast("Nincs ilyen override doc.", "warn");
          return;
        }
        const d = s.data();
        ovTitle.value = d.title || "";
        ovActive.value = String(!!d.active);
        ovVimeoUrl.value = d.vimeoUrl || "";
        ovNote.value = d.note || "";
        ovSelectedDocId = docId;
        toast("Override betöltve.", "ok");
      }catch(e){
        log(`Override load hiba: ${e?.message || e}`);
        toast("Override betöltés hiba.", "err");
      }
    });

    btnOvSave.addEventListener("click", async ()=>{
      const uid = (ovUserPick.value || "").trim();
      const docId = (ovDocId.value || "").trim();
      if(!uid || !docId){ toast("Vevő + Doc ID kell.", "warn"); return; }

      const payload = {
        title: (ovTitle.value || "").trim() || docId,
        vimeoUrl: (ovVimeoUrl.value || "").trim(), // can be ""
        active: (ovActive.value === "true"),
        note: (ovNote.value || "").trim() || null,
        updatedAt: serverTimestamp()
      };

      try{
        await setDoc(doc(db, "users", uid, "overrides", docId), payload, { merge:true });
        toast("Override mentve.", "ok");
        log(`Override save OK: users/${uid}/overrides/${docId}`);
        await loadOverrides();
      }catch(e){
        log(`Override save hiba: ${e?.message || e}`);
        toast("Override mentés hiba (Rules?)", "err");
      }
    });

    btnOvDelete.addEventListener("click", async ()=>{
      const uid = (ovUserPick.value || "").trim();
      const docId = (ovDocId.value || "").trim();
      if(!uid || !docId){ toast("Vevő + Doc ID kell.", "warn"); return; }
      const ok = confirm(`Biztos törlöd? users/${uid}/overrides/${docId}`);
      if(!ok) return;

      try{
        await deleteDoc(doc(db, "users", uid, "overrides", docId));
        toast("Override törölve.", "ok");
        ovDocId.value = "";
        ovTitle.value = "";
        ovVimeoUrl.value = "";
        ovActive.value = "true";
        ovNote.value = "";
        ovSelectedDocId = null;
        await loadOverrides();
      }catch(e){
        log(`Override delete hiba: ${e?.message || e}`);
        toast("Override törlés hiba.", "err");
      }
    });

    ovUserPick.addEventListener("change", ()=>{
      overridesCache = [];
      ovList.innerHTML = "";
      ovDocId.value = "";
      ovTitle.value = "";
      ovVimeoUrl.value = "";
      ovActive.value = "true";
      ovNote.value = "";
      ovSelectedDocId = null;
      if(ovUserPick.value){
        loadOverrides();
      }
    });

    // ===== Utils
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // First tab
    setTab("customers");
    log("Admin UI (PRO) betöltve. Várjuk az auth állapotot…");
  </script>
</body>
</html>
