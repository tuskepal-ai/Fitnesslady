<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FitnessLady ‚Äî Admin</title>

  <meta name="theme-color" content="#120018" />

  <style>
    :root{
      --bg:#07000b;
      --card:rgba(30,8,45,.68);
      --card2:rgba(40,10,60,.55);
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.66);
      --pink:#ff4fd8;
      --pink2:#c64bff;
      --ok:#2ee59d;
      --warn:#ffcc66;
      --err:#ff5b6b;
      --shadow: 0 18px 45px rgba(0,0,0,.55);
      --radius: 20px;
      --radius2: 26px;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(900px 420px at 20% 15%, rgba(198,75,255,.18), transparent 55%),
        radial-gradient(800px 380px at 80% 25%, rgba(255,79,216,.16), transparent 55%),
        radial-gradient(1000px 480px at 55% 85%, rgba(255,79,216,.10), transparent 60%),
        linear-gradient(180deg, #050008, #040007 55%, #030006);
      overflow-x:hidden;
    }

    .bg{
      position:fixed; inset:0;
      background:
        radial-gradient(1200px 600px at 35% 35%, rgba(255,79,216,.14), transparent 60%),
        radial-gradient(1000px 520px at 70% 55%, rgba(198,75,255,.12), transparent 62%);
      pointer-events:none;
      opacity:.9;
    }

    header{
      position:sticky;
      top:0;
      z-index:10;
      backdrop-filter: blur(14px);
      background: rgba(10,0,15,.55);
      border-bottom: 1px solid var(--stroke);
    }

    .topbar{
      max-width:1200px;
      margin:0 auto;
      padding:14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800; letter-spacing:.2px;
    }

    .dot{
      width:10px; height:10px; border-radius:999px;
      background: radial-gradient(circle at 30% 30%, #fff, var(--pink));
      box-shadow: 0 0 18px rgba(255,79,216,.55);
    }

    .pill{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      box-shadow: 0 10px 28px rgba(0,0,0,.25);
      font-size:14px;
      white-space:nowrap;
    }

    .actions{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
    }

    .btn{
      cursor:pointer;
      user-select:none;
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:10px 14px;
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:800;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
    }
    .btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 18px 38px rgba(0,0,0,.30);
      border-color: rgba(255,255,255,.18);
    }
    .btn.primary{
      background: linear-gradient(135deg, rgba(255,79,216,.95), rgba(198,75,255,.95));
      border-color: rgba(255,255,255,.16);
      box-shadow: 0 22px 50px rgba(255,79,216,.18);
    }
    .btn.danger{
      background: rgba(255,91,107,.14);
      border-color: rgba(255,91,107,.30);
    }

    main{
      max-width:1200px;
      margin: 22px auto 80px;
      padding: 0 14px;
    }

    .card{
      border:1px solid var(--stroke);
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(25,7,40,.75), rgba(20,5,35,.55));
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .cardHeader{ padding:16px 16px 0; }

    h1{ margin:0 0 6px; font-size: 34px; letter-spacing:.2px; }

    .sub{
      margin:0 0 14px;
      color: var(--muted);
      line-height:1.45;
    }

    .tabs{
      display:flex; gap:10px;
      padding: 0 16px 16px;
      flex-wrap:wrap;
    }

    .tab{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      font-weight:900;
      color: var(--text);
      transition:.12s;
      display:flex; align-items:center; gap:10px;
    }
    .tab .ico{
      width:26px; height:26px; border-radius:10px;
      display:inline-flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 24px rgba(0,0,0,.22);
      font-size:15px;
    }
    .tab.active{
      background: linear-gradient(135deg, rgba(255,79,216,.95), rgba(198,75,255,.95));
      box-shadow: 0 18px 42px rgba(255,79,216,.14);
      border-color: rgba(255,255,255,.16);
    }
    .tab.active .ico{
      background: rgba(0,0,0,.18);
      border-color: rgba(255,255,255,.16);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
      padding: 14px 16px 16px;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      h1{ font-size: 30px; }
    }

    .panel{
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      padding: 14px;
    }
    .panel h2{margin:0 0 6px; font-size: 22px;}
    .panel p{margin:0 0 12px; color:var(--muted); line-height:1.45;}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}

    .field{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
    }

    .field:focus{
      border-color: rgba(255,79,216,.45);
      box-shadow: 0 0 0 4px rgba(255,79,216,.12);
    }

    label{
      display:block;
      font-size:13px;
      color:var(--muted);
      margin:10px 0 6px;
    }

    textarea.field{
      min-height: 140px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.45;
      white-space: pre-wrap;
    }

    .list{
      display:flex; flex-direction:column; gap:10px;
      max-height: 520px;
      overflow:auto;
      padding-right: 2px;
    }

    .item{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding: 12px;
      cursor:pointer;
      transition:.12s;
    }

    .item:hover{
      border-color: rgba(255,255,255,.18);
      box-shadow: 0 16px 34px rgba(0,0,0,.25);
      transform: translateY(-1px);
    }

    .item .t{ font-weight:900; }
    .item .m{ color:var(--muted); font-size:13px; margin-top:4px; }

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.85);
      margin-left:8px;
    }
    .badge.ok{ border-color: rgba(46,229,157,.30); background: rgba(46,229,157,.10); }
    .badge.err{ border-color: rgba(255,91,107,.30); background: rgba(255,91,107,.12); }
    .badge.warn{ border-color: rgba(255,204,102,.30); background: rgba(255,204,102,.10); }

    .log{
      margin: 14px 16px 16px;
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      background: rgba(0,0,0,.18);
      padding: 12px 14px;
      color: rgba(255,255,255,.80);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      white-space: pre-wrap;
      line-height: 1.4;
    }

    footer{
      max-width:1200px;
      margin: 24px auto 30px;
      padding: 0 14px;
      color: rgba(255,255,255,.60);
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      font-size: 13px;
    }

    .toast{
      position: fixed;
      top: 74px;
      right: 14px;
      z-index: 50;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      max-width: 92vw;
      display:none;
      color: rgba(255,255,255,.92);
      font-weight: 900;
    }
    .toast.ok{ border-color: rgba(46,229,157,.28); }
    .toast.err{ border-color: rgba(255,91,107,.30); }
    .toast.warn{ border-color: rgba(255,204,102,.28); }

    /* Editor: ikon-szekci√≥k */
    .segTabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin: 10px 0 12px;
    }
    .seg{
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight:900;
      color: var(--text);
      display:inline-flex;
      align-items:center;
      gap:10px;
      transition:.12s;
    }
    .seg:hover{
      transform: translateY(-1px);
      box-shadow: 0 16px 34px rgba(0,0,0,.25);
      border-color: rgba(255,255,255,.18);
    }
    .seg .ico{
      width:30px; height:30px;
      border-radius: 12px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 12px 26px rgba(0,0,0,.22);
      font-size: 16px;
    }
    .seg.active{
      background: linear-gradient(135deg, rgba(255,79,216,.95), rgba(198,75,255,.95));
      border-color: rgba(255,255,255,.16);
      box-shadow: 0 18px 42px rgba(255,79,216,.14);
    }
    .seg.active .ico{
      background: rgba(0,0,0,.18);
      border-color: rgba(255,255,255,.16);
    }

    .section{
      display:none;
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid rgba(255,255,255,.08);
    }
    .section.active{ display:block; }

    .hint{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <div class="bg"></div>

  <header>
    <div class="topbar">
      <div class="brand">
        <span class="dot"></span>
        <span>FitnessLady <span style="opacity:.85">Admin</span></span>
      </div>

      <div class="actions">
        <span class="pill" id="statusPill">ellen≈ërz√©s‚Ä¶</span>
        <button class="btn" id="btnApp" title="Vev≈ë oldal">‚Üó App</button>
        <button class="btn danger" id="btnLogout" title="Kil√©p√©s">‚Ü© Kil√©p√©s</button>
      </div>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="cardHeader">
        <h1>Admin panel</h1>
        <p class="sub">
          √âles (nem demo). Itt mindent tudsz kezelni: vev≈ëk, vide√≥k (planTemplates), szem√©lyre szab√°s (overrides),
          √©s a vev≈ë alatti tartalmak (√©trend + motiv√°ci√≥) ‚Äî <b>szabad sz√∂vegk√©nt</b>.
          <br><b>Bel√©p√©s csak adminnak</b> (users/{uid}.role = "admin").
        </p>
      </div>

      <div class="tabs">
        <div class="tab active" data-tab="customers"><span class="ico">üë§</span>Customers</div>
        <div class="tab" data-tab="plans"><span class="ico">üé•</span>Vide√≥k</div>
        <div class="tab" data-tab="overrides"><span class="ico">‚ú®</span>Szem√©lyre szab√°s</div>
      </div>

      <div class="grid">
        <!-- BAL -->
        <div class="panel">
          <h2 id="leftTitle">Vev≈ëk</h2>
          <p id="leftDesc">Kattints egy vev≈ëre. Jobbra szerkesztesz, majd Ment√©s ‚Üí Firestore.</p>

          <div id="customersBlock">
            <label>Keres√©s (e-mail / uid / docId)</label>
            <input class="field" id="search" placeholder="pl. teszt@email.com" />

            <div style="height:12px"></div>
            <div class="row">
              <button class="btn" id="btnReload">‚ü≥ Lista friss√≠t√©se</button>
              <button class="btn primary" id="btnNewUser">Ôºã √öj vev≈ë (doc)</button>
            </div>

            <div style="height:12px"></div>
            <div class="list" id="list"></div>
          </div>

          <div id="plansBlock" style="display:none">
            <p style="color:var(--muted);margin:0 0 12px">
              Vide√≥ sablonok (planTemplates) ‚Äî gyors, √©les szerkeszt√©s.
            </p>
            <label>Plan ID</label>
            <input class="field" id="planId" placeholder="pl. Start / Balance / Pro" />
            <label>Weeks JSON (planTemplates/{planId}/weeks/{weekNo})</label>
            <textarea class="field" id="planWeeksJson" placeholder='{"base":{...},"weeks":[{"weekNo":1,"workouts":[...]}]}'></textarea>
            <div style="height:12px"></div>
            <div class="row">
              <button class="btn" id="btnLoadPlan">Bet√∂lt√©s</button>
              <button class="btn primary" id="btnSavePlan">Ment√©s</button>
            </div>

            <div class="hint">
              Tipp: a workout elem √≠gy n√©z ki:
              <br><code>{"title":"Als√≥test edz√©s","video":"","duration":30}</code>
              <br>Ha m√©g nincs vide√≥, <b>video</b> lehet √ºres string: <code>""</code>.
            </div>
          </div>

          <div id="overridesBlock" style="display:none">
            <p style="color:var(--muted);margin:0 0 12px">
              Overrides = szem√©lyre szabott vide√≥k/elemek a user al√°: <b>users/{uid}/overrides/{doc}</b>
            </p>
            <label>Vev≈ë UID</label>
            <input class="field" id="ovUid" placeholder="pl. mOBrBrPlycPJb..." />
            <label>Override Doc ID</label>
            <input class="field" id="ovDoc" placeholder="pl. slot1 / 2026-02-15 / customA" />
            <label>Override JSON</label>
            <textarea class="field" id="ovJson" placeholder='{"title":"Szem√©lyre szab√°s 1","vimeoUrl":"...","active":true}'></textarea>
            <div style="height:12px"></div>
            <div class="row">
              <button class="btn" id="btnLoadOv">Bet√∂lt√©s</button>
              <button class="btn primary" id="btnSaveOv">Ment√©s</button>
            </div>
          </div>
        </div>

        <!-- JOBB: Profi editor ikon-szekci√≥kkal -->
        <div class="panel">
          <h2>Szerkeszt≈ë</h2>
          <p>V√°lassz egy vev≈ët bal oldalt.</p>

          <div id="editorEmpty" style="color:var(--muted)">Nincs kiv√°lasztott vev≈ë.</div>

          <div id="editor" style="display:none">
            <div class="row" style="justify-content:space-between; align-items:flex-start;">
              <div>
                <div style="font-weight:900;font-size:16px" id="edTitle">‚Äî</div>
                <div style="color:var(--muted);font-size:12px;margin-top:4px" id="edMeta">‚Äî</div>
              </div>
              <div class="row">
                <button class="btn" id="btnOpenDoc">‚Üó Firestore</button>
                <button class="btn danger" id="btnDeleteUser">T√∂rl√©s</button>
              </div>
            </div>

            <div class="segTabs" id="segTabs">
              <div class="seg active" data-seg="base"><span class="ico">‚öôÔ∏è</span>Alap</div>
              <div class="seg" data-seg="videos"><span class="ico">üé•</span>Vide√≥k</div>
              <div class="seg" data-seg="diet"><span class="ico">üçΩÔ∏è</span>√âtrend</div>
              <div class="seg" data-seg="motivation"><span class="ico">üíú</span>Motiv√°ci√≥</div>
              <div class="seg" data-seg="personal"><span class="ico">‚ú®</span>Szem√©lyre szab√°s</div>
            </div>

            <!-- BASE -->
            <div class="section active" id="sec_base">
              <label>Akt√≠v</label>
              <select class="field" id="edActive">
                <option value="true">true</option>
                <option value="false">false</option>
              </select>

              <label>Role</label>
              <select class="field" id="edRole">
                <option value="user">user</option>
                <option value="admin">admin</option>
              </select>

              <label>Email</label>
              <input class="field" id="edEmail" placeholder="vevo@email.com" />

              <label>Csomag (package)</label>
              <select class="field" id="edPackage">
                <option value="Start">Start</option>
                <option value="Balance">Balance</option>
                <option value="Pro">Pro</option>
              </select>

              <label>C√©l (goal)</label>
              <input class="field" id="edGoal" placeholder="pl. Form√°l√°s" />

              <label>Szint (level)</label>
              <input class="field" id="edLevel" inputmode="numeric" placeholder="pl. 2" />
            </div>

            <!-- VIDEOS -->
            <div class="section" id="sec_videos">
              <div class="hint" style="margin-top:0">
                Itt a vev≈ë alap csomagj√°t √°ll√≠tod. A konkr√©t heti vide√≥kat a <b>Vide√≥k</b> f√ºl alatt (planTemplates)
                vagy <b>Szem√©lyre szab√°s</b> alatt (overrides) tudod kezelni.
              </div>

              <label>Plan gyors megnyit√°s (bal oldali Vide√≥k f√ºl)</label>
              <div class="row">
                <button class="btn" id="btnGoPlans">üé• Vide√≥k szerkeszt√©se</button>
                <button class="btn" id="btnGoOverrides">‚ú® Szem√©lyre szab√°s</button>
              </div>

              <div class="hint">
                Szab√°ly: Balance = 1-el t√∂bb vide√≥/h√©t, Pro = 2-vel t√∂bb vide√≥/h√©t (a Start-hoz k√©pest).
              </div>
            </div>

            <!-- DIET (FREE TEXT) -->
            <div class="section" id="sec_diet">
              <label>√âtrend ‚Äî szabad szerkeszt√©s (b√°rmi)</label>
              <textarea class="field" id="edDiet" placeholder="Ide √≠rhatsz recepteket, list√°t, heti tervet, b√°rmit. Nem kell JSON!"></textarea>
              <div class="hint">
                Itt <b>b√°rmit</b> √≠rhatsz, nincs JSON ellen≈ërz√©s. Ment√©skor sima sz√∂vegk√©nt ker√ºl a Firestore-ba: <code>users/{uid}.diet</code>.
              </div>
            </div>

            <!-- MOTIVATION (FREE TEXT) -->
            <div class="section" id="sec_motivation">
              <label>Motiv√°ci√≥ ‚Äî szabad szerkeszt√©s</label>
              <textarea class="field" id="edMotivation" placeholder="Motiv√°ci√≥s √ºzenet, c√©lmeger≈ës√≠t√©s, napi tipp, b√°rmi."></textarea>
              <div class="hint">
                Ment√©skor sima sz√∂vegk√©nt ker√ºl a Firestore-ba: <code>users/{uid}.motivation</code>.
              </div>
            </div>

            <!-- PERSONAL -->
            <div class="section" id="sec_personal">
              <div class="hint" style="margin-top:0">
                Szem√©lyre szabott vide√≥k/elemek: <code>users/{uid}/overrides/{doc}</code>.
                <br>Menj a bal oldali <b>Szem√©lyre szab√°s</b> f√ºlre √©s ott kezeld.
              </div>
              <div class="row">
                <button class="btn primary" id="btnPrefillOv">‚ú® UID bet√∂lt√©se Overrides-hoz</button>
              </div>
            </div>

            <div style="height:12px"></div>
            <div class="row">
              <button class="btn" id="btnReloadUser">Friss√≠t√©s</button>
              <button class="btn primary" id="btnSaveUser">Ment√©s ‚Üí Firestore</button>
            </div>

            <div class="hint">
              Tipp: a vev≈ë oldalon a program az <code>users/{uid}</code> + <code>users/{uid}/overrides</code> alapj√°n √©p√ºl.
            </div>
          </div>
        </div>
      </div>

      <div class="log" id="log">Log: bet√∂lt√©s‚Ä¶</div>
    </section>
  </main>

  <footer>
    <div>¬© 2026 FitnessLady ‚Äî Admin</div>
    <div>T√ºske web design</div>
  </footer>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore,
      doc, getDoc, setDoc, updateDoc, deleteDoc,
      collection, getDocs, query, orderBy, limit, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ===== Firebase config (a ti√©d) =====
    const firebaseConfig = {
      apiKey: "AIzaSyBl2MzyiRzgCzeg-eEWNHkc9Vxx-PgawfU",
      authDomain: "fitneady-15fd0.firebaseapp.com",
      projectId: "fitneady-15fd0",
      storageBucket: "fitneady-15fd0.firebasestorage.app",
      messagingSenderId: "480597492603",
      appId: "1:480597492603:web:2ba6c266c662b4c79e33de",
      measurementId: "G-MH1YK9C2YF"
    };

    const $ = (id)=>document.getElementById(id);
    const logEl = $("log");
    const toastEl = $("toast");

    function log(msg){
      const t = (new Date()).toLocaleString();
      logEl.textContent = `Log: ${t}\n${msg}`;
      console.log(msg);
    }
    function toast(msg, type="ok"){
      toastEl.className = `toast ${type}`;
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=> toastEl.style.display="none", 2600);
    }

    // UI
    const statusPill = $("statusPill");
    const btnApp = $("btnApp");
    const btnLogout = $("btnLogout");

    const tabs = Array.from(document.querySelectorAll(".tab"));
    const customersBlock = $("customersBlock");
    const plansBlock = $("plansBlock");
    const overridesBlock = $("overridesBlock");
    const leftTitle = $("leftTitle");
    const leftDesc = $("leftDesc");

    const listEl = $("list");
    const searchEl = $("search");
    const btnReload = $("btnReload");
    const btnNewUser = $("btnNewUser");

    const editorEmpty = $("editorEmpty");
    const editor = $("editor");
    const edTitle = $("edTitle");
    const edMeta = $("edMeta");
    const btnOpenDoc = $("btnOpenDoc");
    const btnDeleteUser = $("btnDeleteUser");

    // Editor fields
    const edActive = $("edActive");
    const edRole = $("edRole");
    const edEmail = $("edEmail");
    const edPackage = $("edPackage");
    const edGoal = $("edGoal");
    const edLevel = $("edLevel");
    const edDiet = $("edDiet");                 // FREE TEXT
    const edMotivation = $("edMotivation");     // FREE TEXT
    const btnReloadUser = $("btnReloadUser");
    const btnSaveUser = $("btnSaveUser");

    // Editor seg tabs
    const segs = Array.from(document.querySelectorAll(".seg"));
    const sec_base = $("sec_base");
    const sec_videos = $("sec_videos");
    const sec_diet = $("sec_diet");
    const sec_motivation = $("sec_motivation");
    const sec_personal = $("sec_personal");

    const btnGoPlans = $("btnGoPlans");
    const btnGoOverrides = $("btnGoOverrides");
    const btnPrefillOv = $("btnPrefillOv");

    // Plans
    const planIdEl = $("planId");
    const planWeeksJsonEl = $("planWeeksJson");
    const btnLoadPlan = $("btnLoadPlan");
    const btnSavePlan = $("btnSavePlan");

    // Overrides
    const ovUidEl = $("ovUid");
    const ovDocEl = $("ovDoc");
    const ovJsonEl = $("ovJson");
    const btnLoadOv = $("btnLoadOv");
    const btnSaveOv = $("btnSaveOv");

    // State
    let app, auth, db;
    let currentUser = null;
    let currentProfile = null;
    let selectedUid = null;
    let selectedDoc = null;

    // Init
    try{
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
    }catch(e){
      log(`Firebase init hiba: ${e?.message || e}`);
      statusPill.textContent = "Hiba / Konfig";
      toast("Firebase init hiba!", "err");
    }

    // Buttons
    btnApp.addEventListener("click", ()=> window.location.href = "/hu/app/");
    btnLogout.addEventListener("click", async ()=>{
      try{
        await signOut(auth);
        toast("Kil√©pt√©l.", "ok");
        window.location.href = "/hu/login/";
      }catch(e){
        log(`Kil√©p√©s hiba: ${e?.message || e}`);
        toast("Kil√©p√©s hiba!", "err");
      }
    });

    // Tabs
    function setTab(name){
      tabs.forEach(t=> t.classList.toggle("active", t.dataset.tab===name));
      customersBlock.style.display = (name==="customers") ? "block" : "none";
      plansBlock.style.display     = (name==="plans")     ? "block" : "none";
      overridesBlock.style.display = (name==="overrides") ? "block" : "none";

      if(name==="customers"){
        leftTitle.textContent = "Vev≈ëk";
        leftDesc.textContent = "Kattints egy vev≈ëre. Jobbra szerkesztesz, majd Ment√©s ‚Üí Firestore.";
      }
      if(name==="plans"){
        leftTitle.textContent = "Vide√≥k";
        leftDesc.textContent = "Plan sablonok (planTemplates) gyors szerkeszt√©se.";
      }
      if(name==="overrides"){
        leftTitle.textContent = "Szem√©lyre szab√°s";
        leftDesc.textContent = "Overrides kezel√©se (users/{uid}/overrides).";
      }
      log(`Tab: ${name}`);
    }
    tabs.forEach(t=> t.addEventListener("click", ()=> setTab(t.dataset.tab)));

    // Editor segment switching
    function setSeg(name){
      segs.forEach(s=> s.classList.toggle("active", s.dataset.seg===name));
      [sec_base, sec_videos, sec_diet, sec_motivation, sec_personal].forEach(x=> x.classList.remove("active"));
      if(name==="base") sec_base.classList.add("active");
      if(name==="videos") sec_videos.classList.add("active");
      if(name==="diet") sec_diet.classList.add("active");
      if(name==="motivation") sec_motivation.classList.add("active");
      if(name==="personal") sec_personal.classList.add("active");
    }
    segs.forEach(s=> s.addEventListener("click", ()=> setSeg(s.dataset.seg)));

    btnGoPlans.addEventListener("click", ()=> setTab("plans"));
    btnGoOverrides.addEventListener("click", ()=> setTab("overrides"));
    btnPrefillOv.addEventListener("click", ()=>{
      if(!selectedUid){ toast("Nincs kiv√°lasztott vev≈ë.", "warn"); return; }
      setTab("overrides");
      ovUidEl.value = selectedUid;
      toast("UID be√°ll√≠tva az Overrides-hoz.", "ok");
    });

    // Auth guard + admin check
    onAuthStateChanged(auth, async (u)=>{
      currentUser = u;

      if(!u){
        statusPill.textContent = "Nincs bel√©pve";
        log("Nincs bel√©pett user. Redirect ‚Üí /hu/login/");
        window.location.href = "/hu/login/";
        return;
      }

      statusPill.textContent = `Bel√©pve: ${u.email || u.uid} ‚Ä¢ ellen≈ërz√©s‚Ä¶`;

      try{
        const pRef = doc(db, "users", u.uid);
        const pSnap = await getDoc(pRef);

        if(!pSnap.exists()){
          statusPill.textContent = "Hiba / Nincs profil";
          log(`Nincs users/${u.uid} profil. Hozd l√©tre Firestore-ban (role='admin').`);
          toast("Nincs profil (users/{uid})!", "err");
          return;
        }

        currentProfile = pSnap.data();
        const role = (currentProfile.role || "user").toLowerCase();
        if(role !== "admin"){
          statusPill.textContent = "Hiba / Nincs jogosults√°g";
          log(`Nincs admin jog. users/${u.uid}.role = ${role}`);
          toast("Nincs admin jogosults√°g!", "err");
          return;
        }

        statusPill.textContent = `Bel√©pve: ${u.email} ‚Ä¢ role=admin`;
        log("Admin OK. Bet√∂lt√©s‚Ä¶");
        toast("Admin bel√©p√©s OK", "ok");

        await loadUsers();
      }catch(e){
        statusPill.textContent = "Hiba / Firebase";
        log(`Admin check hiba: ${e?.message || e}`);
        toast("Admin ellen≈ërz√©s hiba!", "err");
      }
    });

    // Customers list
    let usersCache = [];

    async function loadUsers(){
      listEl.innerHTML = "";
      selectedUid = null;
      selectedDoc = null;
      editor.style.display = "none";
      editorEmpty.style.display = "block";

      try{
        const qy = query(collection(db, "users"), orderBy("createdAt", "desc"), limit(200));
        const snap = await getDocs(qy);
        usersCache = [];
        snap.forEach(d=> usersCache.push({ id:d.id, ...d.data() }));
        renderList(usersCache);
        log(`Users bet√∂ltve: ${usersCache.length} db`);
      }catch(e){
        log(`Users load hiba: ${e?.message || e}`);
        toast("Nem tudom bet√∂lteni a users list√°t (Rules?)", "err");
      }
    }

    function renderList(items){
      const term = (searchEl.value || "").trim().toLowerCase();
      const filtered = !term ? items : items.filter(u=>{
        const id = (u.id || "").toLowerCase();
        const email = (u.email || "").toLowerCase();
        return id.includes(term) || email.includes(term);
      });

      listEl.innerHTML = "";
      if(filtered.length === 0){
        const d = document.createElement("div");
        d.className = "item";
        d.innerHTML = `<div class="t">Nincs tal√°lat</div><div class="m">Pr√≥b√°lj m√°sik keres√©st.</div>`;
        listEl.appendChild(d);
        return;
      }

      filtered.forEach(u=>{
        const active = !!u.active;
        const role = (u.role || "user").toLowerCase();
        const pkg = u.package || "‚Äî";
        const goal = u.goal || "‚Äî";
        const level = (u.level ?? "‚Äî");

        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="t">
            ${(u.email || "(nincs email)")}
            <span class="badge ${active ? "ok" : "err"}">${active ? "active" : "inactive"}</span>
            <span class="badge ${role==="admin" ? "warn" : ""}">${role}</span>
          </div>
          <div class="m">
            uid/docId: <b>${u.id}</b><br>
            csomag: <b>${pkg}</b> ‚Ä¢ c√©l: <b>${goal}</b> ‚Ä¢ szint: <b>${level}</b>
          </div>
        `;
        el.addEventListener("click", ()=> selectUser(u.id));
        listEl.appendChild(el);
      });
    }

    searchEl.addEventListener("input", ()=> renderList(usersCache));
    btnReload.addEventListener("click", ()=> loadUsers());
    btnNewUser.addEventListener("click", ()=> createNewUserDoc());

    async function createNewUserDoc(){
      const email = prompt("√öj vev≈ë email:");
      if(!email) return;

      const docId = email.trim().toLowerCase().replace(/[^a-z0-9@._-]/g, "_");

      try{
        await setDoc(doc(db,"users",docId),{
          email: email.trim(),
          role: "user",
          active: true,
          package: "Start",
          goal: "Form√°l√°s",
          level: 1,

          // FREE TEXT fields:
          diet: "",
          motivation: "",

          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge:true });

        toast("√öj doc l√©trehozva.", "ok");
        await loadUsers();
      }catch(e){
        log(`New user doc hiba: ${e?.message || e}`);
        toast("Nem tudtam l√©trehozni.", "err");
      }
    }

    // Editor load user
    async function selectUser(uid){
      selectedUid = uid;
      editorEmpty.style.display = "none";
      editor.style.display = "block";
      edTitle.textContent = "Bet√∂lt√©s‚Ä¶";
      edMeta.textContent = uid;

      try{
        const uRef = doc(db, "users", uid);
        const uSnap = await getDoc(uRef);

        if(!uSnap.exists()){
          selectedDoc = null;
          edTitle.textContent = "Nincs ilyen user doc";
          toast("Nincs ilyen doc.", "err");
          return;
        }

        selectedDoc = uSnap.data();
        const email = selectedDoc.email || "(nincs email)";
        edTitle.textContent = email;
        edMeta.textContent = `docId/uid: ${uid}`;

        edActive.value = String(!!selectedDoc.active);
        edRole.value = (selectedDoc.role || "user");
        edEmail.value = selectedDoc.email || "";
        edPackage.value = selectedDoc.package || "Start";
        edGoal.value = selectedDoc.goal || "";
        edLevel.value = String(selectedDoc.level ?? "");

        // diet (FREE TEXT) - handle legacy object -> stringify preview
        const d = selectedDoc.diet;
        if(d == null){
          edDiet.value = "";
        }else if(typeof d === "string"){
          edDiet.value = d;
        }else{
          try{ edDiet.value = JSON.stringify(d, null, 2); }
          catch{ edDiet.value = ""; }
        }

        // motivation (FREE TEXT)
        const m = selectedDoc.motivation;
        edMotivation.value = (m == null) ? "" : String(m);

        btnOpenDoc.onclick = ()=>{
          const url = `https://console.firebase.google.com/project/${firebaseConfig.projectId}/firestore/databases/-default-/data/~2Fusers~2F${encodeURIComponent(uid)}`;
          window.open(url, "_blank");
        };

        // default editor seg
        setSeg("base");

        log(`User kiv√°lasztva: ${uid}`);
      }catch(e){
        log(`selectUser hiba: ${e?.message || e}`);
        toast("Bet√∂lt√©s hiba.", "err");
      }
    }

    btnReloadUser.addEventListener("click", ()=>{
      if(!selectedUid) return;
      selectUser(selectedUid);
    });

    btnSaveUser.addEventListener("click", async ()=>{
      if(!selectedUid) return;

      // ‚úÖ diet/motivation: FREE TEXT (NO JSON parsing)
      const dietText = (edDiet.value || "").trim();
      const motText  = (edMotivation.value || "").trim();

      const payload = {
        active: (edActive.value === "true"),
        role: edRole.value,
        email: (edEmail.value || "").trim(),
        package: edPackage.value,
        goal: (edGoal.value || "").trim(),
        level: Number(String(edLevel.value || "").trim() || 0),

        diet: dietText ? dietText : "",
        motivation: motText ? motText : "",

        updatedAt: serverTimestamp()
      };

      try{
        await updateDoc(doc(db, "users", selectedUid), payload);
        toast("Mentve.", "ok");
        log(`Ment√©s OK: users/${selectedUid}`);
        await loadUsers();
        await selectUser(selectedUid);
      }catch(e){
        log(`Ment√©s hiba: ${e?.message || e}`);
        toast("Ment√©s hiba (Rules?)", "err");
      }
    });

    btnDeleteUser.addEventListener("click", async ()=>{
      if(!selectedUid) return;
      const ok = confirm(`Biztos t√∂rl√∂d? users/${selectedUid}`);
      if(!ok) return;

      try{
        await deleteDoc(doc(db, "users", selectedUid));
        toast("T√∂r√∂lve.", "ok");
        selectedUid = null;
        selectedDoc = null;
        editor.style.display = "none";
        editorEmpty.style.display = "block";
        await loadUsers();
      }catch(e){
        log(`T√∂rl√©s hiba: ${e?.message || e}`);
        toast("T√∂rl√©s hiba (Rules?)", "err");
      }
    });

    // Plans (planTemplates)
    btnLoadPlan.addEventListener("click", async ()=>{
      const planId = (planIdEl.value || "").trim();
      if(!planId){ toast("Adj meg Plan ID-t.", "warn"); return; }

      try{
        const s = await getDoc(doc(db, "planTemplates", planId));
        const base = s.exists() ? s.data() : null;

        const weeksSnap = await getDocs(query(collection(db, "planTemplates", planId, "weeks"), orderBy("weekNo","asc"), limit(60)));
        const weeks = [];
        weeksSnap.forEach(d=> weeks.push({ id:d.id, ...d.data() }));

        const out = { base, weeks };
        planWeeksJsonEl.value = JSON.stringify(out, null, 2);
        toast("Plan bet√∂ltve.", "ok");
      }catch(e){
        log(`Plan load hiba: ${e?.message || e}`);
        toast("Plan bet√∂lt√©s hiba.", "err");
      }
    });

    btnSavePlan.addEventListener("click", async ()=>{
      const planId = (planIdEl.value || "").trim();
      if(!planId){ toast("Adj meg Plan ID-t.", "warn"); return; }

      const txt = (planWeeksJsonEl.value || "").trim();
      if(!txt){ toast("√úres JSON.", "warn"); return; }

      let data;
      try{ data = JSON.parse(txt); }
      catch{ toast("JSON hib√°s.", "err"); return; }

      try{
        if(data.base){
          await setDoc(doc(db, "planTemplates", planId), { ...data.base, updatedAt: serverTimestamp() }, { merge:true });
        }else{
          await setDoc(doc(db, "planTemplates", planId), { updatedAt: serverTimestamp() }, { merge:true });
        }

        if(Array.isArray(data.weeks)){
          for(const w of data.weeks){
            const weekNo = Number(w.weekNo ?? w.id ?? 0);
            if(!weekNo) continue;
            const id = String(weekNo);
            const payload = { ...w, weekNo, updatedAt: serverTimestamp() };
            delete payload.id;
            await setDoc(doc(db, "planTemplates", planId, "weeks", id), payload, { merge:true });
          }
        }

        toast("Plan mentve.", "ok");
      }catch(e){
        log(`Plan save hiba: ${e?.message || e}`);
        toast("Plan ment√©s hiba (Rules?)", "err");
      }
    });

    // Overrides
    btnLoadOv.addEventListener("click", async ()=>{
      const uid = (ovUidEl.value || "").trim();
      const docId = (ovDocEl.value || "").trim();
      if(!uid || !docId){ toast("UID + Doc ID kell.", "warn"); return; }

      try{
        const s = await getDoc(doc(db, "users", uid, "overrides", docId));
        if(!s.exists()){
          ovJsonEl.value = "";
          toast("Nincs ilyen override doc.", "warn");
          return;
        }
        ovJsonEl.value = JSON.stringify(s.data(), null, 2);
        toast("Override bet√∂ltve.", "ok");
      }catch(e){
        log(`Override load hiba: ${e?.message || e}`);
        toast("Override bet√∂lt√©s hiba.", "err");
      }
    });

    btnSaveOv.addEventListener("click", async ()=>{
      const uid = (ovUidEl.value || "").trim();
      const docId = (ovDocEl.value || "").trim();
      if(!uid || !docId){ toast("UID + Doc ID kell.", "warn"); return; }

      const txt = (ovJsonEl.value || "").trim();
      if(!txt){ toast("√úres JSON.", "warn"); return; }

      let data;
      try{ data = JSON.parse(txt); }
      catch{ toast("JSON hib√°s.", "err"); return; }

      try{
        await setDoc(doc(db, "users", uid, "overrides", docId), { ...data, updatedAt: serverTimestamp() }, { merge:true });
        toast("Override mentve.", "ok");
      }catch(e){
        log(`Override save hiba: ${e?.message || e}`);
        toast("Override ment√©s hiba (Rules?)", "err");
      }
    });

    // Start
    setTab("customers");
    log("Admin UI V3 bet√∂ltve. V√°rjuk az auth √°llapotot‚Ä¶");
  </script>
</body>
</html>
