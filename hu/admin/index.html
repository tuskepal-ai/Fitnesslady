<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FitnessLady ‚Äî Admin</title>
  <meta name="description" content="FitnessLady admin panel ‚Äî √ºgyfelek kezel√©se, program/√©trend/szem√©lyre szab√°s be√°ll√≠t√°sa." />

  <style>
    :root{
      --bg:#07060b;
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --pink:#ff4fd8;
      --pink2:#b14cff;
      --gold:#ffd38a;
      --radius:22px;
      --shadow: 0 18px 55px rgba(0,0,0,.55);
      --max: 1180px;
      --glassA: rgba(255,255,255,.06);
      --glassB: rgba(255,255,255,.02);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.14);
      --danger:#ff5a73;
      --ok:#6dffb8;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 700px at 30% 10%, rgba(255,79,216,.16), transparent 60%),
        radial-gradient(1000px 700px at 75% 20%, rgba(177,76,255,.14), transparent 60%),
        radial-gradient(1000px 700px at 60% 90%, rgba(255,211,138,.06), transparent 55%),
        var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }
    body::before{
      content:"";
      position: fixed; inset:0; z-index:-1;
      background-image:url("/hero.png");
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      opacity:.92;
    }
    a{ color:inherit; text-decoration:none; }
    button,input,select,textarea{ font:inherit; }
    .container{ width:min(var(--max), 92vw); margin:0 auto; }

    .topbar{
      position:fixed; top:0; left:0; right:0;
      z-index:50;
      background: rgba(8,6,12,.55);
      border-bottom: 1px solid rgba(255,255,255,.06);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .topbar-inner{
      height:64px;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.2px; }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: radial-gradient(circle at 30% 30%, #ffd0f6, var(--pink));
      box-shadow: 0 0 18px rgba(255,79,216,.7);
      flex:0 0 auto;
    }

    .pill{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(20,12,26,.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: var(--text);
      box-shadow: 0 12px 34px rgba(0,0,0,.35);
      cursor:pointer;
      transition: transform .18s ease, border-color .18s ease, background .18s ease, opacity .18s ease;
      user-select:none;
      white-space: nowrap;
      gap:8px;
    }
    .pill:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.20); }
    .pill.primary{
      background: linear-gradient(135deg, var(--pink), var(--pink2));
      color:#140813;
      border-color: rgba(255,255,255,.18);
      box-shadow: 0 18px 46px rgba(255,79,216,.26);
      font-weight: 950;
    }
    .pill.ghost{ background: rgba(255,255,255,.06); }
    .pill.danger{
      background: rgba(255,90,115,.12);
      border-color: rgba(255,90,115,.30);
      color: rgba(255,255,255,.92);
    }
    .pill.ok{
      background: rgba(109,255,184,.12);
      border-color: rgba(109,255,184,.30);
      color: rgba(255,255,255,.92);
    }

    main{ padding-top: 64px; min-height:100vh; min-height:100dvh; }
    .page{ padding: 18px 0 64px; }

    .glass{
      background: linear-gradient(180deg, var(--glassA), var(--glassB));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }
    .card{ padding:16px; }
    h1,h2,h3{ margin:0 0 10px; font-family: ui-serif, Georgia, "Times New Roman", Times, serif; letter-spacing:-.2px; }
    h1{ font-size: 26px; }
    h2{ font-size: 20px; }
    h3{ font-size: 16px; }
    .sub{ margin:0 0 12px; color:var(--muted); line-height:1.55; font-size:13.5px; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1.2fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .tabs{ display:flex; flex-wrap:wrap; gap:8px; margin: 8px 0 12px; }
    .tab{
      padding: 8px 11px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.86);
      cursor:pointer;
      font-size: 13px;
      font-weight: 900;
      user-select:none;
    }
    .tab.is-active{
      background: linear-gradient(135deg, var(--pink), var(--pink2));
      color:#140813;
      border-color: rgba(255,255,255,.18);
    }

    .row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items:center;
      padding: 12px;
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
    }
    .row .title{ font-weight: 950; letter-spacing:.2px; font-size: 13.5px; }
    .row .desc{ color: var(--muted); font-size: 12.8px; margin-top: 4px; line-height: 1.45; }
    .list{ margin:0; padding:0; list-style:none; display:grid; gap:10px; }

    .field{ display:grid; gap:8px; margin: 10px 0 12px; }
    label{ font-size: 12.5px; color: var(--muted2); font-weight: 900; }
    input,select,textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.92);
      outline: none;
    }
    textarea{ min-height: 110px; resize: vertical; }
    input:focus,select:focus,textarea:focus{ border-color: rgba(255,255,255,.22); }

    .note{ color: var(--muted2); font-size: 12.6px; line-height: 1.55; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 11px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.86);
      font-weight: 900;
      font-size: 12.5px;
      white-space: nowrap;
    }

    .split{
      display:grid; grid-template-columns: 1fr 1fr; gap:10px;
    }
    @media (max-width: 680px){
      .split{ grid-template-columns: 1fr; }
    }

    .hidden{ display:none !important; }

    footer{
      padding: 18px 0 46px;
      border-top:1px solid rgba(255,255,255,.08);
      background: rgba(10,8,14,.55);
      backdrop-filter: blur(10px);
    }
    .footer-inner{
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      color:rgba(255,255,255,.70);
      font-size:13px;
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="container topbar-inner">
      <div class="brand">
        <span class="dot"></span>
        <span>FitnessLady Admin</span>
      </div>

      <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
        <span class="badge" id="authBadge">ellen≈ërz√©s‚Ä¶</span>
        <a class="pill ghost" href="/hu/app/" title="Vev≈ë app">‚Üó App</a>
        <button class="pill ghost" id="btnSignOut" type="button">‚éã Kil√©p√©s</button>
      </div>
    </div>
  </header>

  <main>
    <div class="container page">
      <section class="glass card" style="margin-bottom:14px;">
        <h1>Admin panel</h1>
        <p class="sub">
          Itt l√°tod a vev≈ëket, √©s be tudod √°ll√≠tani: csomag, c√©l, szint, akt√≠v st√°tusz, √©trend (JSON), valamint a ‚Äúszem√©lyre szab√°s‚Äù (overrides).
        </p>

        <div class="tabs" id="tabs">
          <button class="tab is-active" data-tab="customers" type="button">Customers</button>
          <button class="tab" data-tab="plans" type="button">Plans</button>
          <button class="tab" data-tab="overrides" type="button">Overrides</button>
        </div>

        <div class="row" style="grid-template-columns: 1fr;">
          <div class="mono" id="logBox">Log: bet√∂lt√©s‚Ä¶</div>
        </div>
      </section>

      <div class="grid">
        <!-- LEFT: Customers list -->
        <section class="glass card" id="panelCustomers">
          <h2>Vev≈ëk</h2>
          <p class="sub">Kattints egy vev≈ëre. Jobbra szerkesztesz, majd Ment√©s ‚Üí Firestore.</p>

          <div class="field">
            <label for="search">Keres√©s (e-mail / uid / docId)</label>
            <input id="search" type="text" placeholder="pl. teszt@email.com" />
          </div>

          <ul class="list" id="customerList"></ul>
        </section>

        <!-- RIGHT: Editor -->
        <section class="glass card" id="panelEditor">
          <h2>Szerkeszt≈ë</h2>
          <p class="sub" id="editorSub">V√°lassz egy vev≈ët bal oldalt.</p>

          <div id="editorEmpty" class="note">Nincs kiv√°lasztott vev≈ë.</div>

          <div id="editorForm" class="hidden">
            <div class="row" style="grid-template-columns: 1fr;">
              <div>
                <div class="title" id="edTitle">‚Äî</div>
                <div class="desc mono" id="edIds">‚Äî</div>
              </div>
            </div>

            <div class="split">
              <div class="field">
                <label for="edActive">Active</label>
                <select id="edActive">
                  <option value="true">true</option>
                  <option value="false">false</option>
                </select>
              </div>

              <div class="field">
                <label for="edRole">Role</label>
                <select id="edRole">
                  <option value="">(none)</option>
                  <option value="admin">admin</option>
                  <option value="user">user</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label for="edEmail">E-mail</label>
              <input id="edEmail" type="email" placeholder="email" />
              <div class="note">Megjegyz√©s: Auth emailt ez nem √≠rja √°t, csak a Firestore profilt.</div>
            </div>

            <div class="split">
              <div class="field">
                <label for="edPackage">Csomag</label>
                <select id="edPackage">
                  <option value="Start">Start</option>
                  <option value="Balance">Balance</option>
                  <option value="Pro">Pro</option>
                </select>
              </div>
              <div class="field">
                <label for="edLevel">Szint (1‚Äì4)</label>
                <select id="edLevel">
                  <option value="1">1</option><option value="2">2</option>
                  <option value="3">3</option><option value="4">4</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label for="edGoal">C√©l</label>
              <input id="edGoal" type="text" placeholder="pl. Form√°l√°s / Fogy√°s / Er≈ë" />
            </div>

            <hr style="border:none; height:1px; background:rgba(255,255,255,.08); margin: 14px 0;" />

            <h3>√âtrend (diet)</h3>
            <p class="note">
              PRO m√≥d: egy mez≈ëben t√°roljuk JSON-k√©nt. App oldal ezt tudja olvasni (k√©s≈ëbb csin√°lunk ‚Äúsz√©p UI‚Äù-t).
            </p>

            <div class="split">
              <div class="field">
                <label for="edKcal">Kcal</label>
                <input id="edKcal" type="number" placeholder="pl. 1800" />
              </div>
              <div class="field">
                <label for="edProtein">Feh√©rje (g)</label>
                <input id="edProtein" type="number" placeholder="pl. 150" />
              </div>
            </div>
            <div class="split">
              <div class="field">
                <label for="edCarb">CH (g)</label>
                <input id="edCarb" type="number" placeholder="pl. 170" />
              </div>
              <div class="field">
                <label for="edFat">Zs√≠r (g)</label>
                <input id="edFat" type="number" placeholder="pl. 55" />
              </div>
            </div>

            <div class="field">
              <label for="edDietNote">√Åltal√°nos megjegyz√©s</label>
              <textarea id="edDietNote" placeholder="pl. pihen≈ënapon kevesebb CH, sok v√≠z..."></textarea>
            </div>

            <div class="field">
              <label for="edDietWeekJson">Heti terv (JSON) ‚Äî gyors szerkeszt√©s</label>
              <textarea id="edDietWeekJson" class="mono" placeholder='{"mon":{"meals":[{"title":"Reggeli","items":["..."]}],"note":""},"tue":{...}}'></textarea>
              <div class="note">A Ment√©s gomb valid√°lja, hogy JSON-e (ha nem, nem enged menteni).</div>
            </div>

            <hr style="border:none; height:1px; background:rgba(255,255,255,.08); margin: 14px 0;" />

            <h3>Szem√©lyre szab√°s (overrides)</h3>
            <p class="note">
              Ide tudsz vev≈ë-specifikus vide√≥kat / slotokat adni. PRO: egy JSON mez≈ë.
            </p>
            <div class="field">
              <label for="edOverridesJson">Overrides JSON</label>
              <textarea id="edOverridesJson" class="mono" placeholder='{"week1":{"slot1":{"title":"Glute f√≥kusz","video":"https://player.vimeo.com/video/..."}}}'></textarea>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
              <button class="pill primary" id="btnSave" type="button">üíæ Ment√©s</button>
              <button class="pill ghost" id="btnReload" type="button">‚Ü∫ √öjrat√∂lt</button>
              <button class="pill danger" id="btnDeactivate" type="button">‚õî Active=false</button>
            </div>

            <div class="note" id="saveMsg" style="margin-top:10px;"></div>
          </div>
        </section>
      </div>
    </div>
  </main>

  <footer>
    <div class="container footer-inner">
      <div>¬© <span id="y"></span> FitnessLady ‚Äî Admin</div>
      <div>T√ºske web design</div>
    </div>
  </footer>

  <script type="module">
    // =========================
    // 0) FIREBASE CONFIG (K√ñTELEZ≈ê kit√∂lteni)
    // =========================
    // Ide m√°sold be a Firebase Console -> Project settings -> Your apps -> Web app config adatait.
    const firebaseConfig = {
      apiKey: "PASTE_YOUR_API_KEY",
      authDomain: "PASTE_YOUR_AUTH_DOMAIN",
      projectId: "PASTE_YOUR_PROJECT_ID",
      storageBucket: "PASTE_YOUR_STORAGE_BUCKET",
      messagingSenderId: "PASTE_YOUR_SENDER_ID",
      appId: "PASTE_YOUR_APP_ID"
    };

    // =========================
    // 1) Imports
    // =========================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    import {
      getFirestore,
      doc,
      getDoc,
      getDocs,
      collection,
      updateDoc,
      serverTimestamp,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // =========================
    // 2) Helpers
    // =========================
    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
    const nowISO = ()=>new Date().toISOString();
    const esc = (v)=>String(v??"");
    const logBox = $("#logBox");
    const authBadge = $("#authBadge");
    const saveMsg = $("#saveMsg");

    function log(msg){
      logBox.textContent = `Log: ${msg}`;
      console.log("[Admin]", msg);
    }

    function safeJsonParse(str){
      try{
        if(!str || !String(str).trim()) return null;
        return JSON.parse(str);
      }catch(e){
        return { __error: e?.message || "Invalid JSON" };
      }
    }

    function stringifyPretty(obj){
      if(obj == null) return "";
      try{ return JSON.stringify(obj, null, 2); }catch{ return ""; }
    }

    function setSaveMsg(text, kind=""){
      saveMsg.textContent = text || "";
      saveMsg.style.color = kind==="ok" ? "rgba(109,255,184,.92)"
        : kind==="err" ? "rgba(255,90,115,.92)"
        : "rgba(255,255,255,.72)";
    }

    // =========================
    // 3) Init Firebase
    // =========================
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // =========================
    // 4) State
    // =========================
    let me = null;            // auth user
    let meProfile = null;     // /users/{uid}
    let customers = [];       // [{id, data}]
    let selected = null;      // {id, data}

    // =========================
    // 5) UI Elements
    // =========================
    const customerList = $("#customerList");
    const search = $("#search");

    const editorEmpty = $("#editorEmpty");
    const editorForm = $("#editorForm");
    const editorSub = $("#editorSub");

    const edTitle = $("#edTitle");
    const edIds = $("#edIds");
    const edActive = $("#edActive");
    const edRole = $("#edRole");
    const edEmail = $("#edEmail");
    const edPackage = $("#edPackage");
    const edLevel = $("#edLevel");
    const edGoal = $("#edGoal");

    const edKcal = $("#edKcal");
    const edProtein = $("#edProtein");
    const edCarb = $("#edCarb");
    const edFat = $("#edFat");
    const edDietNote = $("#edDietNote");
    const edDietWeekJson = $("#edDietWeekJson");
    const edOverridesJson = $("#edOverridesJson");

    // Tabs panels
    const panelCustomers = $("#panelCustomers");
    const panelEditor = $("#panelEditor");

    // =========================
    // 6) Auth Flow
    // =========================
    async function ensureAdminOrBlock(){
      // admin check: /users/{uid}.role === 'admin'
      const ref = doc(db, "users", me.uid);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        throw new Error("Nincs /users/{uid} profilod. Hozd l√©tre a users doc-ot a te UID-eddel.");
      }
      meProfile = snap.data();
      const role = (meProfile.role || "").toLowerCase();
      if(role !== "admin"){
        throw new Error("Nincs admin jogosults√°god (users/{uid}.role != admin).");
      }
      authBadge.textContent = `Bel√©pve: ${me.email} ‚Ä¢ role=admin`;
      authBadge.style.borderColor = "rgba(109,255,184,.30)";
      authBadge.style.background = "rgba(109,255,184,.10)";
      log("admin jogosults√°g OK");
    }

    async function promptLogin(){
      // egyszer≈±, stabil login prompt (mobilon is m≈±k√∂dik)
      const email = window.prompt("Admin bel√©p√©s ‚Äî Email:", "");
      if(!email) throw new Error("Bel√©p√©s megszak√≠tva (nincs email).");
      const pw = window.prompt("Jelsz√≥:", "");
      if(!pw) throw new Error("Bel√©p√©s megszak√≠tva (nincs jelsz√≥).");
      await signInWithEmailAndPassword(auth, email.trim(), pw);
    }

    $("#btnSignOut").addEventListener("click", async ()=>{
      await signOut(auth);
      location.reload();
    });

    // =========================
    // 7) Data Loading
    // =========================
    async function loadCustomers(){
      log("customers bet√∂lt√©se‚Ä¶");
      // Rendez√©s createdAt szerint (ha nincs, akkor doc id)
      const qy = query(collection(db, "users"), orderBy("createdAt", "desc"));
      const snap = await getDocs(qy);
      customers = snap.docs.map(d => ({ id: d.id, data: d.data() }));
      log(`customers OK (${customers.length} db)`);
      renderCustomerList();
    }

    // =========================
    // 8) Render list
    // =========================
    function matchCustomer(c, term){
      if(!term) return true;
      const t = term.toLowerCase().trim();
      const d = c.data || {};
      const hay = [
        c.id,
        d.uid,
        d.email,
        d.goal,
        d.package,
        d.role
      ].map(x => String(x||"").toLowerCase()).join(" ");
      return hay.includes(t);
    }

    function renderCustomerList(){
      const term = (search.value || "").trim();
      const filtered = customers.filter(c => matchCustomer(c, term));

      customerList.innerHTML = "";
      if(filtered.length === 0){
        const li = document.createElement("li");
        li.className = "row";
        li.style.gridTemplateColumns = "1fr";
        li.innerHTML = `<div class="note">Nincs tal√°lat.</div>`;
        customerList.appendChild(li);
        return;
      }

      filtered.forEach(c=>{
        const d = c.data || {};
        const email = d.email || "(nincs email)";
        const pack = d.package || "‚Äî";
        const goal = d.goal || "‚Äî";
        const active = d.active !== false; // default true
        const role = (d.role || "").toLowerCase();

        const li = document.createElement("li");
        li.className = "row";
        li.style.cursor = "pointer";
        li.innerHTML = `
          <div>
            <div class="title">${active ? "‚úÖ" : "‚õî"} ${email}</div>
            <div class="desc">Csomag: <b>${esc(pack)}</b> ‚Ä¢ C√©l: ${esc(goal)} ${role==="admin" ? " ‚Ä¢ <b>ADMIN</b>" : ""}</div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
            <span class="badge mono">${esc(c.id)}</span>
          </div>
        `;
        li.addEventListener("click", ()=>{
          selectCustomer(c.id);
        });
        customerList.appendChild(li);
      });
    }

    search.addEventListener("input", renderCustomerList);

    // =========================
    // 9) Editor
    // =========================
    function selectCustomer(id){
      const c = customers.find(x=>x.id===id);
      if(!c) return;

      selected = { id: c.id, data: structuredClone(c.data || {}) };
      editorEmpty.classList.add("hidden");
      editorForm.classList.remove("hidden");

      const d = selected.data;
      editorSub.textContent = "Ment√©s ut√°n a vev≈ë oldala azonnal ezt fogja olvasni Firestore-b√≥l.";

      edTitle.textContent = d.email || "(nincs email)";
      edIds.textContent = `docId: ${selected.id}`;

      edActive.value = (d.active === false) ? "false" : "true";
      edRole.value = d.role || "";
      edEmail.value = d.email || "";
      edPackage.value = d.package || "Start";
      edLevel.value = String(d.level || 2);
      edGoal.value = d.goal || "";

      // diet objektum: diet = {kcal, protein, carb, fat, note, weekPlan}
      const diet = d.diet || {};
      edKcal.value = diet.kcal ?? "";
      edProtein.value = diet.protein ?? "";
      edCarb.value = diet.carb ?? "";
      edFat.value = diet.fat ?? "";
      edDietNote.value = diet.note ?? "";
      edDietWeekJson.value = stringifyPretty(diet.weekPlan ?? null);

      // overrides JSON: d.overrides
      edOverridesJson.value = stringifyPretty(d.overrides ?? null);

      setSaveMsg("");
    }

    $("#btnReload").addEventListener("click", async ()=>{
      if(!selected) return;
      await refreshSelectedFromServer();
    });

    async function refreshSelectedFromServer(){
      setSaveMsg("√öjrat√∂lt√©s‚Ä¶");
      const ref = doc(db, "users", selected.id);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        setSaveMsg("A vev≈ë dokumentuma nem tal√°lhat√≥.", "err");
        return;
      }
      // friss√≠ts list√°t is
      const idx = customers.findIndex(x=>x.id===selected.id);
      const fresh = snap.data();
      if(idx>=0) customers[idx] = { id: selected.id, data: fresh };
      selected = { id: selected.id, data: structuredClone(fresh) };
      selectCustomer(selected.id);
      renderCustomerList();
      setSaveMsg("√öjrat√∂ltve.", "ok");
    }

    $("#btnDeactivate").addEventListener("click", ()=>{
      if(!selected) return;
      edActive.value = "false";
      setSaveMsg("Be√°ll√≠tva: active=false (ne felejts Ment√©s).");
    });

    $("#btnSave").addEventListener("click", async ()=>{
      if(!selected) return;

      // 1) JSON valid√°ci√≥
      const weekPlanParsed = safeJsonParse(edDietWeekJson.value);
      if(weekPlanParsed && weekPlanParsed.__error){
        setSaveMsg(`Diet week JSON hib√°s: ${weekPlanParsed.__error}`, "err");
        return;
      }
      const overridesParsed = safeJsonParse(edOverridesJson.value);
      if(overridesParsed && overridesParsed.__error){
        setSaveMsg(`Overrides JSON hib√°s: ${overridesParsed.__error}`, "err");
        return;
      }

      // 2) payload
      const payload = {
        active: edActive.value === "true",
        role: edRole.value || null,
        email: (edEmail.value || "").trim().toLowerCase(),
        package: edPackage.value,
        level: parseInt(edLevel.value, 10) || 2,
        goal: (edGoal.value || "").trim(),
        diet: {
          kcal: edKcal.value === "" ? null : Number(edKcal.value),
          protein: edProtein.value === "" ? null : Number(edProtein.value),
          carb: edCarb.value === "" ? null : Number(edCarb.value),
          fat: edFat.value === "" ? null : Number(edFat.value),
          note: (edDietNote.value || "").trim(),
          weekPlan: weekPlanParsed ?? null
        },
        overrides: overridesParsed ?? null,
        updatedAt: serverTimestamp()
      };

      // role null ‚Üí t√∂rl√©s helyett null-t √≠runk (rules egyszer≈± marad)
      // Ha zavar, k√©s≈ëbb √°t√°ll√≠tjuk deleteField-re.

      setSaveMsg("Ment√©s‚Ä¶");
      try{
        const ref = doc(db, "users", selected.id);
        await updateDoc(ref, payload);

        // friss√≠ts list√°ban is
        const idx = customers.findIndex(x=>x.id===selected.id);
        if(idx>=0){
          const merged = { ...(customers[idx].data||{}), ...payload };
          // serverTimestamp nem j√∂n vissza r√∂gt√∂n, ok√©
          customers[idx] = { id: selected.id, data: merged };
        }
        setSaveMsg("Mentve ‚úÖ Firestore friss√ºlt.", "ok");
        renderCustomerList();
      }catch(e){
        console.error(e);
        setSaveMsg(`Ment√©s hiba: ${e?.message || e}`, "err");
      }
    });

    // =========================
    // 10) Tabs (most csak UI v√°lt√°s ‚Äî k√©s≈ëbb b≈ëv√≠tj√ºk)
    // =========================
    $("#tabs").addEventListener("click", (e)=>{
      const btn = e.target.closest("[data-tab]");
      if(!btn) return;
      $$("#tabs .tab").forEach(t=>t.classList.remove("is-active"));
      btn.classList.add("is-active");

      const tab = btn.getAttribute("data-tab");
      // jelenleg: customers panel + editor mindig l√°tszik
      // k√©s≈ëbb: plans/overrides k√ºl√∂n panelek
      if(tab === "customers"){
        panelCustomers.classList.remove("hidden");
        panelEditor.classList.remove("hidden");
        log("Customers tab");
      }else if(tab === "plans"){
        panelCustomers.classList.remove("hidden");
        panelEditor.classList.remove("hidden");
        log("Plans tab (k√∂vetkez≈ë k√∂rben b≈ëv√≠tj√ºk: sablonok / planTemplates)");
      }else if(tab === "overrides"){
        panelCustomers.classList.remove("hidden");
        panelEditor.classList.remove("hidden");
        log("Overrides tab (itt a kiv√°lasztott user overrides mez≈ëje a PRO)");
      }
    });

    // =========================
    // 11) Boot
    // =========================
    document.getElementById("y").textContent = new Date().getFullYear();

    onAuthStateChanged(auth, async (user)=>{
      try{
        if(!user){
          authBadge.textContent = "Nincs bel√©pve";
          authBadge.style.borderColor = "rgba(255,255,255,.12)";
          authBadge.style.background = "rgba(255,255,255,.06)";
          log("bel√©p√©s sz√ºks√©ges‚Ä¶");
          await promptLogin();
          return; // onAuthStateChanged √∫jra lefut
        }

        me = user;
        log("auth OK, admin ellen≈ërz√©s‚Ä¶");
        await ensureAdminOrBlock();

        // bet√∂lt√©s
        await loadCustomers();

        // auto select: els≈ë vev≈ë
        if(customers[0]) selectCustomer(customers[0].id);

        setSaveMsg("K√©sz. V√°lassz vev≈ët bal oldalt.");
      }catch(err){
        console.error(err);
        authBadge.textContent = "Hiba / Nincs jogosults√°g";
        authBadge.style.borderColor = "rgba(255,90,115,.30)";
        authBadge.style.background = "rgba(255,90,115,.10)";
        log(err?.message || String(err));
        setSaveMsg(err?.message || String(err), "err");
      }
    });
  </script>
</body>
</html>
