<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FitnessLady – Admin</title>
  <style>
    :root{
      --bg:#07060b;
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.72);
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.10);
      --accent1:#ff4fd8;
      --accent2:#b14cff;
      --radius:18px;
      --max: 1200px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 700px at 30% 10%, rgba(255,79,216,.16), transparent 60%),
        radial-gradient(1000px 700px at 75% 20%, rgba(177,76,255,.14), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    .container{width:min(var(--max), 92vw); margin:0 auto; padding:18px 0 50px}
    .topbar{
      position:sticky; top:0; z-index:5;
      backdrop-filter: blur(12px);
      background: rgba(8,6,12,.55);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .topbar-inner{
      width:min(var(--max), 92vw); margin:0 auto;
      height:64px; display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{display:flex; gap:10px; align-items:center; font-weight:900}
    .dot{width:10px;height:10px;border-radius:999px;background:radial-gradient(circle at 30% 30%, #ffd0f6, var(--accent1));
         box-shadow:0 0 18px rgba(255,79,216,.7)}
    .pill{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 12px; border-radius:999px; cursor:pointer; user-select:none;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text); font-weight:900;
    }
    .pill.primary{
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      color:#120812;
      border-color: rgba(255,255,255,.18);
    }
    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:14px; margin-top:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: 0 18px 55px rgba(0,0,0,.55);
      backdrop-filter: blur(16px);
    }
    h1{margin:0;font-size:18px}
    h2{margin:0 0 10px;font-size:15px}
    .sub{margin:8px 0 0; color:var(--muted); font-size:13px; line-height:1.5}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between}
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
    }
    label{display:block; font-size:12px; color:var(--muted); font-weight:800; margin:10px 0 6px}
    .table-wrap{overflow:auto; border-radius:14px; border:1px solid rgba(255,255,255,.10)}
    table{width:100%; border-collapse:collapse; min-width:760px; background: rgba(0,0,0,.10)}
    th,td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.08); text-align:left; font-size:13px}
    th{font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:rgba(255,255,255,.70)}
    tr:hover{background: rgba(255,255,255,.05); cursor:pointer}
    .badge{display:inline-flex; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12);
           background: rgba(255,255,255,.06); color:rgba(255,255,255,.78); font-size:12px; font-weight:900}
    .danger{border-color: rgba(255,100,100,.35)}
    .ok{color:#b7ffcf}
    .warn{color:#ffd38a}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:12px; opacity:.9}
    .muted{color:var(--muted)}
    .small{font-size:12px;color:var(--muted);line-height:1.45}
    .hr{height:1px; background:rgba(255,255,255,.08); margin:12px 0}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand"><span class="dot"></span> FitnessLady <span class="badge">ADMIN</span></div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="pill" id="btnGoApp" type="button">Vevő oldal</button>
        <button class="pill" id="btnRefresh" type="button">Frissítés</button>
        <button class="pill primary" id="btnLogout" type="button">Kilépés</button>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="card">
      <div class="row">
        <div>
          <h1>Admin panel</h1>
          <div class="sub" id="me">Betöltés…</div>
        </div>
        <div class="mono" id="status"></div>
      </div>
      <div class="sub">Itt látod a felhasználókat (users kollekció), és kiválasztás után szerkeszted: csomag, cél, szint, active, role.</div>
    </div>

    <div class="grid">
      <!-- LEFT: LIST -->
      <div class="card">
        <div class="row" style="align-items:flex-end">
          <div style="flex:1;min-width:220px">
            <label>Keresés (email)</label>
            <input id="q" placeholder="pl. tuskepal@gmail.com" />
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="pill" id="btnClear" type="button">Törlés</button>
            <span class="badge" id="count">0 user</span>
          </div>
        </div>

        <div class="hr"></div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Email</th>
                <th>Csomag</th>
                <th>Cél</th>
                <th>Szint</th>
                <th>Aktív</th>
                <th>Role</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="small" style="margin-top:10px">
          Tipp: kattints egy sorra → jobbra megjelenik a szerkesztő.
        </div>
      </div>

      <!-- RIGHT: EDIT -->
      <div class="card">
        <h2>Kijelölt user</h2>
        <div class="small muted">Kattints bal oldalt egy userre.</div>

        <div class="hr"></div>

        <div class="small"><b>UID:</b> <span class="mono" id="selUid">—</span></div>
        <div class="small"><b>Email:</b> <span class="mono" id="selEmail">—</span></div>

        <label>Csomag</label>
        <select id="fPackage">
          <option value="Start">Start</option>
          <option value="Balance">Balance</option>
          <option value="Pro">Pro</option>
        </select>

        <label>Cél</label>
        <input id="fGoal" placeholder="pl. Formálás / Fogyás / Erő" />

        <label>Szint (1–4)</label>
        <input id="fLevel" type="number" min="1" max="4" />

        <label>Aktív</label>
        <select id="fActive">
          <option value="true">true</option>
          <option value="false">false</option>
        </select>

        <label>Role</label>
        <select id="fRole">
          <option value="user">user</option>
          <option value="admin">admin</option>
        </select>

        <div class="hr"></div>

        <div class="row">
          <button class="pill" id="btnResetSel" type="button">Visszaállítás</button>
          <button class="pill primary" id="btnSave" type="button">Mentés</button>
        </div>

        <div class="small" style="margin-top:10px" id="saveMsg"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const BASE_PREFIX = (location.hostname.endsWith("github.io")) ? "/Fitnesslady" : "";
    const appUrl   = `${BASE_PREFIX}/hu/app/`;
    const loginUrl = `${BASE_PREFIX}/hu/login/`;

    const firebaseConfig = {
      apiKey: "AIzaSyBl2MzyiRzgCzeg-eEWNHkc9Vxx-PgawfU",
      authDomain: "fitneady-15fd0.firebaseapp.com",
      projectId: "fitneady-15fd0",
      storageBucket: "fitneady-15fd0.firebasestorage.app",
      messagingSenderId: "480597492603",
      appId: "1:480597492603:web:2ba6c266c662b4c79e33de",
      measurementId: "G-MH1YK9C2YF"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const el = (id)=>document.getElementById(id);
    const status = (msg)=> el("status").textContent = msg || "";

    let meUid = null;
    let meEmail = null;

    // loaded users cache
    let users = [];
    let selected = null; // {id, ...data}

    function safe(v){ return String(v ?? ""); }
    function lower(v){ return safe(v).toLowerCase(); }

    async function ensureAdmin(user){
      const snap = await getDoc(doc(db, "users", user.uid));
      const data = snap.exists() ? snap.data() : {};
      const role = lower(data.role);

      if(role !== "admin"){
        // nem admin -> app vagy login
        location.replace(appUrl);
        return false;
      }
      return true;
    }

    function renderTable(){
      const q = lower(el("q").value).trim();
      const filtered = q ? users.filter(u => lower(u.email).includes(q)) : users;

      el("count").textContent = `${filtered.length} user`;
      const tbody = el("tbody");
      tbody.innerHTML = filtered.map(u => `
        <tr data-uid="${safe(u.id)}">
          <td>${safe(u.email)}</td>
          <td>${safe(u.package)}</td>
          <td>${safe(u.goal)}</td>
          <td>${safe(u.level)}</td>
          <td>${safe(u.active)}</td>
          <td>${safe(u.role)}</td>
        </tr>
      `).join("");

      tbody.querySelectorAll("tr").forEach(tr=>{
        tr.addEventListener("click", ()=>{
          const uid = tr.getAttribute("data-uid");
          const u = users.find(x => x.id === uid);
          if(!u) return;
          selectUser(u);
        });
      });
    }

    function selectUser(u){
      selected = JSON.parse(JSON.stringify(u)); // deep-ish copy
      el("selUid").textContent = safe(u.id);
      el("selEmail").textContent = safe(u.email);

      el("fPackage").value = safe(u.package || "Start");
      el("fGoal").value = safe(u.goal || "");
      el("fLevel").value = safe(u.level ?? 2);
      el("fActive").value = String(!!u.active);
      el("fRole").value = safe(u.role || "user");

      el("saveMsg").textContent = "";
    }

    function resetSelectionForm(){
      if(!selected) return;
      // reload from current users cache (server last loaded)
      const fresh = users.find(x => x.id === selected.id);
      if(fresh) selectUser(fresh);
    }

    async function loadUsers(){
      status("Users betöltése…");
      const snap = await getDocs(collection(db, "users"));
      const arr = [];
      snap.forEach(d => arr.push({ id:d.id, ...d.data() }));
      arr.sort((a,b)=> safe(a.email).localeCompare(safe(b.email)));
      users = arr;
      renderTable();
      status("OK ✅");
    }

    async function saveSelected(){
      if(!selected) return;

      const uid = selected.id;
      const payload = {
        email: selected.email || el("selEmail").textContent || null,
        package: el("fPackage").value,
        goal: el("fGoal").value.trim(),
        level: Math.max(1, Math.min(4, parseInt(el("fLevel").value || "2", 10))),
        active: el("fActive").value === "true",
        role: el("fRole").value,
        updatedAt: serverTimestamp()
      };

      el("saveMsg").textContent = "Mentés…";
      await setDoc(doc(db, "users", uid), payload, { merge:true });
      el("saveMsg").innerHTML = `<span class="ok">Mentve ✅</span>`;
      await loadUsers();
      // keep selection on saved user
      const fresh = users.find(x=>x.id===uid);
      if(fresh) selectUser(fresh);
    }

    // UI events
    el("q").addEventListener("input", renderTable);
    el("btnClear").addEventListener("click", ()=>{ el("q").value=""; renderTable(); });
    el("btnRefresh").addEventListener("click", ()=> loadUsers().catch(e=>status("Hiba: "+(e?.message||e))));
    el("btnGoApp").addEventListener("click", ()=> location.href = appUrl);
    el("btnResetSel").addEventListener("click", resetSelectionForm);
    el("btnSave").addEventListener("click", ()=> saveSelected().catch(e=>{
      el("saveMsg").innerHTML = `<span class="warn">Hiba: ${safe(e?.message||e)}</span>`;
    }));

    el("btnLogout").addEventListener("click", async ()=>{
      await signOut(auth);
      location.replace(loginUrl);
    });

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        location.replace(loginUrl);
        return;
      }
      meUid = user.uid;
      meEmail = user.email;
      el("me").textContent = `Belépve: ${meEmail} (UID: ${meUid})`;

      const ok = await ensureAdmin(user);
      if(!ok) return;

      await loadUsers();
    });
  </script>
</body>
</html>
