<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FitnessLady ‚Äì Bejelentkez√©s</title>
  <style>
    :root{ --bg:#0b0b0f; --card:#141420; --stroke:rgba(255,255,255,.10); --muted:rgba(255,255,255,.72); --accent:#ff4fd8; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:#fff}
    .wrap{max-width:560px;margin:0 auto;padding:22px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
          border:1px solid var(--stroke);border-radius:18px;padding:18px;backdrop-filter:blur(14px)}
    h1{font-size:22px;margin:0 0 12px}
    label{display:block;font-size:13px;opacity:.85;margin:10px 0 6px}
    input{width:100%;padding:12px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0f0f18;color:#fff;outline:none}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button{flex:1;min-width:160px;padding:12px 14px;border-radius:12px;border:0;cursor:pointer;font-weight:800}
    .primary{background:linear-gradient(135deg, var(--accent), #b14cff);color:#120812}
    .ghost{background:rgba(255,255,255,.08);color:#fff}
    .small{font-size:12px;opacity:.75;margin-top:10px;line-height:1.4}
    .log{margin-top:14px;white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
         background:#0f0f18;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px;min-height:64px}
    .badge{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
           background:rgba(255,255,255,.06);color:var(--muted);font-size:12px;font-weight:800}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="badge">üîê √âles bel√©p√©s (Firebase)</div>
      <h1>Bejelentkez√©s / Regisztr√°ci√≥</h1>

      <label>Email</label>
      <input id="email" type="email" placeholder="pl. teszt@fitnesslady.ch" autocomplete="email">

      <label>Jelsz√≥</label>
      <input id="pass" type="password" placeholder="min. 6 karakter" autocomplete="current-password">

      <div class="row">
        <button class="primary" id="btnLogin">Bel√©p√©s</button>
        <button class="ghost" id="btnRegister">Regisztr√°ci√≥</button>
      </div>

      <div class="row">
        <button class="ghost" id="btnMe">Profil (users/{uid})</button>
        <button class="ghost" id="btnLogout">Kil√©p√©s</button>
      </div>

      <div class="small">
        Bel√©p√©s ut√°n: <b>admin ‚Üí /hu/admin/</b>, user ‚Üí <b>/hu/app/</b>.
      </div>

      <div class="log" id="log">Log: bet√∂lt√©s‚Ä¶</div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from
      "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from
      "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    // GitHub Pages prefix t√°mogat√°s
    const BASE_PREFIX = (location.hostname.endsWith("github.io")) ? "/Fitnesslady" : "";

    const firebaseConfig = {
      apiKey: "AIzaSyBl2MzyiRzgCzeg-eEWNHkc9Vxx-PgawfU",
      authDomain: "fitneady-15fd0.firebaseapp.com",
      projectId: "fitneady-15fd0",
      storageBucket: "fitneady-15fd0.firebasestorage.app",
      messagingSenderId: "480597492603",
      appId: "1:480597492603:web:2ba6c266c662b4c79e33de",
      measurementId: "G-MH1YK9C2YF"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id) => document.getElementById(id);
    const log = (msg) => { $("log").textContent = "Log: " + msg; console.log(msg); };

    const adminUrl = `${BASE_PREFIX}/hu/admin/`;
    const appUrl   = `${BASE_PREFIX}/hu/app/`;

    function getInputs() {
      return { email: $("email").value.trim().toLowerCase(), password: $("pass").value };
    }

    async function routeByRole(user){
      const snap = await getDoc(doc(db, "users", user.uid));
      const data = snap.exists() ? snap.data() : {};
      const role = String(data.role || "").toLowerCase();

      if (role === "admin") location.replace(adminUrl);
      else location.replace(appUrl);
    }

    async function doRegister() {
      const { email, password } = getInputs();
      if (!email || password.length < 6) return log("Hiba: email kell + jelsz√≥ min. 6 karakter.");
      log("Regisztr√°ci√≥‚Ä¶");
      const cred = await createUserWithEmailAndPassword(auth, email, password);

      // Alap user doc (admin role-t TE √°ll√≠tod be a saj√°t UID-dn√°l)
      await setDoc(doc(db, "users", cred.user.uid), {
        email: cred.user.email,
        role: "user",
        package: "Start",
        goal: "Form√°l√°s",
        level: 2,
        active: true,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      }, { merge: true });

      log("Sikeres reg ‚úÖ √Åtir√°ny√≠t√°s role alapj√°n‚Ä¶");
      await routeByRole(cred.user);
    }

    async function doLogin() {
      const { email, password } = getInputs();
      if (!email || !password) return log("Hiba: add meg az emailt √©s jelsz√≥t.");
      log("Bel√©p√©s‚Ä¶");
      const cred = await signInWithEmailAndPassword(auth, email, password);
      log("Bel√©pve ‚úÖ √Åtir√°ny√≠t√°s role alapj√°n‚Ä¶");
      await routeByRole(cred.user);
    }

    async function doLogout() {
      await signOut(auth);
      log("Kijelentkezve.");
    }

    async function doMe() {
      const user = auth.currentUser;
      if (!user) return log("Nincs bel√©pve user.");
      const snap = await getDoc(doc(db, "users", user.uid));
      log(snap.exists() ? JSON.stringify(snap.data(), null, 2) : "Nincs users/" + user.uid);
    }

    $("btnRegister").addEventListener("click", () => doRegister().catch(e => log("Reg hiba: " + e.message)));
    $("btnLogin").addEventListener("click", () => doLogin().catch(e => log("Login hiba: " + e.message)));
    $("btnLogout").addEventListener("click", () => doLogout().catch(e => log("Logout hiba: " + e.message)));
    $("btnMe").addEventListener("click", () => doMe().catch(e => log("Me hiba: " + e.message)));

    onAuthStateChanged(auth, (user) => {
      if (user) log("Auth: LOGGED IN ‚Üí " + user.email + " (√°tir√°ny√≠t√°s gombbal vagy automatikusan bel√©p√©skor)");
      else log("Auth: LOGGED OUT");
    });
  </script>
</body>
</html>
